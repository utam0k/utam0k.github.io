---
title: "k/k#135495: 非同期プリエンプション最適化のラストピース"
date: 2025-12-12T00:51:43+09:00
draft: false
---

{{< github "https://github.com/kubernetes/kubernetes/pull/135495" >}}

N 個のPodをプリエンプトする際、最初の N-1 個の Pods 削除が失敗した場合、最後のPodの削除をスキップするという最適化。
既に N-1 の非同期プリエンプションで失敗した場合の途中停止は実装済みだったので、これがその周辺では残っていた最適化でした。

{{< alert tip >}}
最初の N-1 個の削除に失敗している時点で、最後の 1 個だけ削除しても意味がない。意味がないというのは NNN を仮に埋めたとしても結局リソース不足でスケジュール負荷になる。
{{< /alert >}}

読んでいるとメトリクス周りで修正した方が良さそうな箇所があったので issue にした。
{{< github "https://github.com/kubernetes/kubernetes/issues/135717" >}}

ついでに [Async Preemption の KEP](https://github.com/kubernetes/enhancements/tree/b83d33122e3f36dd5f70cd19deb41e208764b1de/keps/sig-scheduling/4832-async-preemption) を読んだが、確かにプリエンプションがおそい
{{< github-code "https://github.com/kubernetes/kubernetes/blob/342da505bdefbd849b808cca3cb76c24a993025f/test/integration/scheduler_perf/config/performance-config.yaml#L621-L645" >}}

FeatureGate があると機能が読みやすい気がした。