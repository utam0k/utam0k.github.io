---
title: "youki#3230: NUMA Memory Policy (set_mempolicy)"
date: 2025-12-08T21:10:51+09:00
draft: false
---


{{< github "https://github.com/youki-dev/youki/pull/3230" >}}
{{< github "https://github.com/opencontainers/runtime-spec/pull/1282" >}}

{{< speakerdeck "https://speakerdeck.com/n4mlz/numahuan-jing-tokontenarantaimu-youki-niokeru-linux-memory-policy-shi-zhuang" >}}

# set_mempolicy(2)

{{< man "set_mempolicy" 2 >}}

```c
long set_mempolicy(int mode, const unsigned long *nodemask, unsigned long maxnode);
```

This function controls which NUMA node a process's memory should be allocated to.
```{title="NUMA"}
+-------------------------------------------------------------+
|                    Multi-Socket Server                      |
+-----------------------------+-------------------------------+
|         Node 0              |           Node 1              |
|  +---------+  +---------+   |   +---------+  +---------+    |
|  |  CPU 0  |  |  CPU 1  |   |   |  CPU 2  |  |  CPU 3  |    |
|  +----+----+  +----+----+   |   +----+----+  +----+----+    |
|       |            |        |        |            |         |
|       +------+-----+        |        +------+-----+         |
|              |              |               |               |
|       +------+------+       |        +------+------+        |
|       |  Memory 0   |<------+------->|  Memory 1   |        |
|       |   (local)   | slow  |        |   (local)   |        |
|       +-------------+       |        +-------------+        |
+-----------------------------+-------------------------------+
```


## Modes

| Mode           | Behavior                                   |
|----------------|--------------------------------------------|
| MPOL_DEFAULT   | System default: Local memory preference    |
| MPOL_LOCAL     | Allocate memory to the local node of current CPU |
| MPOL_PREFERRED | Prefer specified node; use other nodes if unavailable |
| MPOL_BIND      | Use only the specified node                |
| MPOL_INTERLEAVE | Alternate allocation between specified nodes |
| MPOL_PREFERRED_MANY | Prioritize multiple nodes                  |
| MPOL_WEIGHTED_INTERLEAVE | Alternate allocation with weighted priorities |

```json {title="MPOL_BIND"}
{
  "memoryPolicy": {
    "mode": "MPOL_BIND",
    "nodes": "0,1"
  }
}
```

Memory allocation behavior:
- Node 0: Available
- Node 1: Available
- Node 2: Unavailable → Triggers OOM if memory is exhausted

```json {title="MPOL_INTERLEAVE"}
{
  "memoryPolicy": {
    "mode": "MPOL_INTERLEAVE",
    "nodes": "0,1"
  }
}
```

Memory allocation behavior:
- Page 1 → Node 0
- Page 2 → Node 1
- Page 3 → Node 0
- Page 4 → Node 1
- ... (alternating allocation)

Use case: Distributes large datasets across multiple nodes to optimize bandwidth utilization

```json {title="MPOL_PREFERRED"}
{
  "memoryPolicy": {
    "mode": "MPOL_PREFERRED",
    "nodes": "0"
  }
}
```

Memory allocation behavior:
- First attempts allocation on Node 0
- If Node 0 is full, fallback to Node 1
    - Unlike BIND, this does not result in an error

## Flags

| Flag           | Effect                                                   |
|----------------|----------------------------------------------------------|
| MPOL_F_STATIC_NODES | Maintains node numbers even when changing cpusets       |
| MPOL_F_RELATIVE_NODES | Interprets node numbers as relative positions within cpusets |
| MPOL_F_NUMA_BALANCING | Applicable only to BIND. The kernel monitors access patterns and automatically migrates pages |



# Validation

Validation is quite challenging :P

## Flag-related notes

- `MPOL_F_NUMA_BALANCING` can only be used with `MPOL_BIND`
- `MPOL_F_STATIC_NODES` and `MPOL_F_RELATIVE_NODES` cannot be used simultaneously

## Mode-related notes

- `DEFAULT`: nodes must be empty, flags must be empty
- `LOCAL`: nodes must be empty, flags must be empty
- `PREFERRED` + empty nodes: `STATIC`/`RELATIVE` flags are prohibited
- `BIND`: nodes must have one or more entries
- `INTERLEAVE`: nodes must have one or more entries
- `PREFERRED_MANY`: nodes must have one or more entries
- `WEIGHTED_INTERLEAVE`: nodes must have one or more entries