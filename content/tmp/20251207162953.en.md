---
title: "youki#3230: Implementing NUMA Memory Policy (set_mempolicy)"
date: 2025-12-07T16:29:53+09:00
draft: false
---


{{< github "https://github.com/youki-dev/youki/pull/3230" >}}
{{< github "https://github.com/opencontainers/runtime-spec/pull/1282" >}}

{{< speakerdeck "https://speakerdeck.com/n4mlz/numahuan-jing-tokontenarantaimu-youki-niokeru-linux-memory-policy-shi-zhuang" >}}

# set_mempolicy(2)

{{< man "set_mempolicy" 2 >}}

```c
long set_mempolicy(int mode, const unsigned long *nodemask, unsigned long maxnode);
```

Controls which nodes memory is allocated to for a process.
```{title="NUMA"}
+-------------------------------------------------------------+
|                    Multi-Socket Server                      |
+-----------------------------+-------------------------------+
|         Node 0              |           Node 1              |
|  +---------+  +---------+   |   +---------+  +---------+    |
|  |  CPU 0  |  |  CPU 1  |   |   |  CPU 2  |  |  CPU 3  |    |
|  +----+----+  +----+----+   |   +----+----+  +----+----+    |
|       |            |        |        |            |         |
|       +------+-----+        |        +------+-----+         |
|              |              |               |               |
|       +------+------+       |        +------+------+        |
|       |  Memory 0   |<------+------->|  Memory 1   |        |
|       |   (local)   | slow  |        |   (local)   |        |
|       +-------------+       |        +-------------+        |
+-----------------------------+-------------------------------+
```


## Modes

| Mode | Behavior |
|--------|------|
| MPOL_DEFAULT | System default. Local node preferred |
| MPOL_LOCAL | Allocate to the local node of the current CPU |
| MPOL_PREFERRED | Prefer specified node, fallback to others on failure |
| MPOL_BIND | Use only specified nodes |
| MPOL_INTERLEAVE | Allocate alternately among specified nodes |
| MPOL_PREFERRED_MANY | Prefer multiple nodes |
| MPOL_WEIGHTED_INTERLEAVE | Allocate alternately with weights |

```json {title="MPOL_BIND"}
{
  "memoryPolicy": {
    "mode": "MPOL_BIND",
    "nodes": "0,1"
  }
}
```

Memory allocation behavior:
- Node 0: Available
- Node 1: Available
- Node 2: Not allowed → OOM if memory is insufficient

```json {title="MPOL_INTERLEAVE"}
{
  "memoryPolicy": {
    "mode": "MPOL_INTERLEAVE",
    "nodes": "0,1"
  }
}
```

Memory allocation behavior:
- Page 1 → Node 0
- Page 2 → Node 1
- Page 3 → Node 0
- Page 4 → Node 1
- ... (alternating placement)

Use case: Distribute large data across multiple nodes to increase bandwidth

```json {title="MPOL_PREFERRED"}
{
  "memoryPolicy": {
    "mode": "MPOL_PREFERRED",
    "nodes": "0"
  }
}
```

Memory allocation behavior:
- First, try to allocate on Node 0
- If Node 0 is full → Fallback to Node 1
    - Unlike BIND, no error occurs

## Flags

| Flag | Effect |
|--------|------|
| MPOL_F_STATIC_NODES | Keep node numbers unchanged when cpuset changes |
| MPOL_F_RELATIVE_NODES | Interpret node numbers as relative positions within cpuset |
| MPOL_F_NUMA_BALANCING | Valid only with BIND. Kernel monitors access patterns and automatically migrates pages |



# Validation

Validation is quite complex :P

## Flag-related

- `MPOL_F_NUMA_BALANCING` can only be used with `MPOL_BIND`
- `MPOL_F_STATIC_NODES` and `MPOL_F_RELATIVE_NODES` cannot be used together

## Mode-related

- `DEFAULT`: nodes must be empty, flags must be empty
- `LOCAL`: nodes must be empty, flags must be empty
- `PREFERRED` + empty nodes: `STATIC`/`RELATIVE` flags prohibited
- `BIND`: must have at least one node
- `INTERLEAVE`: must have at least one node
- `PREFERRED_MANY`: must have at least one node
- `WEIGHTED_INTERLEAVE`: must have at least one node
