<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>詳解xv6 Scheduling 1 | うたもく</title><meta name=description content><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:site_name" content="うたもく"><meta property="og:url" content="https://www.utam0k.jp/blog/2019/12/20/xv6_scheduling_1/"><meta property="og:title" content="詳解xv6 Scheduling 1"><meta property="og:image" content="https://www.utam0k.jp/img/logo.png"><link rel=alternate type=application/rss+xml href=https://www.utam0k.jp/index.xml><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/hack-font/3.3.0/web/hack.min.css crossorigin=anonymous><link rel=stylesheet href=https://www.utam0k.jp/css/main.min.91b5203317d0db866d60ee9cd9a1261438b2bbb6d788a0bb2afbaae96e0f1342.css integrity="sha256-kbUgMxfQ24ZtYO6c2aEmFDiyu7bXiKC7Kvuq6W4PE0I="><script>(()=>{const e=window.matchMedia("(prefers-color-scheme: dark)"),n=e=>{const s=document.querySelectorAll(".theme-option");s.forEach(t=>{const n=t.dataset.mode===e;t.setAttribute("aria-pressed",n?"true":"false")});const t=document.querySelector(".theme-toggle");t&&t.setAttribute("aria-pressed",e==="dark"?"true":"false");const o=document.querySelectorAll(".theme-choice");o.forEach(t=>t.setAttribute("aria-checked",t.dataset.mode===e?"true":"false"));const n=document.querySelector("[data-theme-icon]");if(n){const t=e==="system"?document.documentElement.dataset.theme||"light":e;n.dataset.state=t}},s=t=>t==="system"?e.matches?"dark":"light":t,t=e=>{const t=s(e);document.documentElement.dataset.theme=t,document.body&&(document.body.dataset.theme=t,document.body.classList.toggle("theme-dark",t==="dark"),document.body.classList.toggle("theme-light",t==="light")),n(e)},o=()=>{const e=localStorage.getItem("color-scheme"),n=e||"system";t(n)};e.addEventListener("change",e=>{const n=localStorage.getItem("color-scheme");(!n||n==="system")&&t("system")}),window.__setTheme=e=>{const n=e||(document.documentElement.dataset.theme==="dark"?"light":"dark");localStorage.setItem("color-scheme",n),t(n)},window.__toggleTheme=()=>window.__setTheme(),window.__toggleThemeMenu=e=>{const t=e?.nextElementSibling;if(!t)return;const n=!t.hidden;document.querySelectorAll(".theme-popover").forEach(e=>e.hidden=!0),document.querySelectorAll(".theme-trigger").forEach(e=>e.setAttribute("aria-expanded","false")),n||(t.hidden=!1,e.setAttribute("aria-expanded","true"))},document.addEventListener("click",e=>{const t=document.querySelector(".theme-popover");if(!t)return;if(e.target.closest(".theme-menu"))return;t.hidden=!0;const n=document.querySelector(".theme-trigger");n?.setAttribute("aria-expanded","false")}),window.__toggleLangMenu=e=>{const t=e?.nextElementSibling;if(!t)return;const n=!t.hidden;document.querySelectorAll(".lang-popover").forEach(e=>e.hidden=!0),document.querySelectorAll(".lang-trigger").forEach(e=>e.setAttribute("aria-expanded","false")),n||(t.hidden=!1,e.setAttribute("aria-expanded","true"))},window.__switchLang=(e)=>{if(!e)return;window.location.href=e},document.addEventListener("click",e=>{const t=document.querySelector(".lang-popover");if(!t)return;if(e.target.closest(".lang-menu"))return;t.hidden=!0;const n=document.querySelector(".lang-trigger");n?.setAttribute("aria-expanded","false")}),o(),document.addEventListener("DOMContentLoaded",()=>{const t=document.documentElement.dataset.theme||(e.matches?"dark":"light");n(t)})})()</script><meta name=generator content="Hugo 0.152.2"></head><body class=page><div class=page-shell><header class=site-header><a class=brand href=https://www.utam0k.jp/><span class=brand-mark aria-hidden=true style=background-image:url(https://www.utam0k.jp/img/logo.png)></span><div class=brand-text><span class=brand-name>うたもく</span>
<span class=brand-tagline>utam0k</span></div></a><div class=header-actions><nav class=main-nav aria-label=Primary><a class=nav-item href=https://www.utam0k.jp/post/>Posts</a>
<a class=nav-item href=https://www.utam0k.jp/slides/>Slides</a>
<a class=nav-item href=https://www.utam0k.jp/page/about/>About</a></nav><span class=header-divider aria-hidden=true></span><div class=lang-menu><button class=lang-trigger type=button aria-haspopup=true aria-expanded=false onclick=window.__toggleLangMenu&&window.__toggleLangMenu(this)>
<span class=lang-trigger__label>JA</span></button><div class=lang-popover hidden role=menu><button class=lang-choice type=button data-lang=JA aria-checked=true role=menuitemradio onclick='window.__switchLang&&window.__switchLang("/","JA")'>日本語</button>
<button class=lang-choice type=button data-lang=EN aria-checked=false role=menuitemradio onclick='window.__switchLang&&window.__switchLang("/en/","EN")'>English</button></div></div><div class=theme-menu><button class=theme-trigger type=button aria-haspopup=true aria-expanded=false onclick=window.__toggleThemeMenu&&window.__toggleThemeMenu(this)>
<span class=theme-trigger__icon aria-hidden=true data-theme-icon data-state=system></span>
<span class=sr-only data-theme-label>Theme</span></button><div class=theme-popover hidden><button class=theme-choice type=button data-mode=system aria-checked=false role=menuitemradio onclick='window.__setTheme&&window.__setTheme("system")'>Auto (System)</button>
<button class=theme-choice type=button data-mode=light aria-checked=false role=menuitemradio onclick='window.__setTheme&&window.__setTheme("light")'>Light</button>
<button class=theme-choice type=button data-mode=dark aria-checked=false role=menuitemradio onclick='window.__setTheme&&window.__setTheme("dark")'>Dark</button></div></div></div></header><main class=layout><div class=article-layout><article class=article><header class="article-hero article-hero--stack"><h1 class=article-title>詳解xv6 Scheduling 1</h1><div class="share-block share-block--mobile"><div class=toc-share aria-label="Share this post"><a class=share-btn href="https://twitter.com/intent/tweet?text=%e8%a9%b3%e8%a7%a3xv6%20Scheduling%201&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f12%2f20%2fxv6_scheduling_1%2f" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h5.3l3.4 4.8L14.8 3H21l-6.8 9.2L21 21h-5.3L12 15.8 8.2 21H3l6.8-8.9L3 3z"/></svg>
<span class=sr-only>Share on X</span>
</a><a class=share-btn href="http://b.hatena.ne.jp/add?mode=confirm&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f12%2f20%2fxv6_scheduling_1%2f&title=%e8%a9%b3%e8%a7%a3xv6%20Scheduling%201" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.47.0C22.42.0 24 1.58 24 3.53v16.94c0 1.95-1.58 3.53-3.53 3.53H3.53C1.58 24 0 22.42.0 20.47V3.53C0 1.58 1.58.0 3.53.0h16.94zM8.61 17.25c1.2.0 2.06-.04 2.58-.12.53-.08.98-.22 1.32-.41.45-.23.78-.56 1.02-.99.24-.43.36-.91.36-1.48.0-.78-.21-1.4-.63-1.87-.42-.48-.99-.74-1.74-.79.66-.18 1.16-.45 1.46-.81.32-.34.47-.82.47-1.42.0-.48-.1-.88-.3-1.26-.21-.36-.5-.65-.88-.87-.35-.2-.74-.32-1.22-.4-.46-.08-1.29-.12-2.48-.12H5.65v10.46H8.6zm.74-4.19c.7.0 1.18.09 1.44.27.27.18.4.5.4.93.0.4-.14.69-.42.86-.27.18-.76.25-1.44.25H8.31v-2.31h1.03zm8.66.71V6.71h-2.46v7.06h2.46zM8.93 9.08c.71.0 1.19.08 1.43.24.25.16.37.44.37.84.0.38-.13.65-.39.8-.27.16-.75.24-1.45.24h-.57V9.08h.61z"/></svg>
<span class=sr-only>はてなブックマーク</span>
</a><a class=share-btn href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f12%2f20%2fxv6_scheduling_1%2f&title=%e8%a9%b3%e8%a7%a3xv6%20Scheduling%201" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.45 3.5H3.55A1.55 1.55.0 002 5.05v13.9A1.55 1.55.0 003.55 20.5h16.9A1.55 1.55.0 0022 18.95V5.05A1.55 1.55.0 0020.45 3.5zM7.14 18.1H4.54V9.88h2.6V18.1zm-1.3-9.36a1.51 1.51.0 110-3.02 1.51 1.51.0 010 3.02zM19 18.1h-2.6v-4.96c0-1.18-.42-1.99-1.48-1.99-.81.0-1.3.55-1.51 1.09-.08.19-.1.46-.1.73v5.13H10.7s.03-8.32.0-9.18h2.6v1.3c.35-.54.98-1.31 2.39-1.31 1.74.0 3.31 1.13 3.31 3.56V18.1z"/></svg>
<span class=sr-only>Share on LinkedIn</span></a></div></div><div class="article-meta article-meta--stack"><div class=meta-row>date: <time datetime=2019-12-20>Fri, 20 Dec 2019 00:00:00 +0900</time></div><div class=meta-row>author: <a class=meta-link href=https://www.utam0k.jp/page/about/>@utam0k</a></div><div class=meta-row>tags: [<a class=meta-link href=https://www.utam0k.jp/tags/xv6>xv6</a>, <a class=meta-link href=https://www.utam0k.jp/tags/os>os</a>]</div></div></header><div class=meta-separator aria-hidden=true>---</div><details class=toc-inline><summary>目次を開く</summary><nav class=toc aria-label="Table of contents"><p class=toc__title>目次</p><div class=toc__body><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#アドベントカレンダーの読者向け説明用>アドベントカレンダーの読者向け説明用</a></li></ul></li></ul></li><li><a href=#スケジューリングのシーケンス図>スケジューリングのシーケンス図</a></li><li><a href=#code-context-switching>Code: Context switching</a><ul><li><a href=#swtch>swtch()</a></li></ul></li><li><a href=#code-scheduling>Code: Scheduling</a><ul><li><a href=#trap>trap()</a></li><li><a href=#yield>yield()</a></li><li><a href=#sched>sched()</a></li><li><a href=#scheduler>scheduler()</a></li></ul></li></ul></nav></div></nav></details><div class=article-body><p><a href=https://www.utam0k.jp/blog/2019/03/05/xv6_index/>詳解xv6の目次</a><br><a href=https://www.utam0k.jp/blog/2019/07/08/xv6_traps_interrupts_drivers_1/>前の記事</a></p><hr><hr><h3 id=アドベントカレンダーの読者向け説明用>アドベントカレンダーの読者向け説明用</h3><p><a href=https://adventar.org/calendars/4027>自作OSアドベントカレンダー 2019</a> の20日目の記事です。<br>この記事はxv6の説明をシリーズでしているスケジュール編です。<br>アドベントカレンダー向けに話が完結しそうなスケジューラの話を選びました。<br>xv6というなぜこのシリーズを書いているのか、OSの説明や動かし方はこのシリーズの<a href=https://www.utam0k.jp/blog/2019/03/05/xv6_intro/>はじめに</a>をよんでくださると助かります。</p><hr><p>この章は以下のように説明をしていきます。</p><ol><li>コンテキストスイッチの方法(本記事)</li><li>スケジューラによるプロセス切り替えの説明(本記事)</li><li>sleep/wakeupでのプロセス切り替えの方法(次回の記事)</li></ol><h1 id=スケジューリングのシーケンス図>スケジューリングのシーケンス図</h1><p>ざっくりとタイマー割り込みからスケジューラが呼ばれ次のプロセスに移り変わるまでの流れです。<br>newプロセスは時間が経過してシーケンス図でのoldプロセスに移り変わっていきます。<br>newプロセスが処理を再開する箇所はnewプロセスがoldだった時の<code>swtch()</code>を呼び出した直後となるはずです。</p><figure><img src=https://www.utam0k.jp/blog/2019/12/20/xv6_scheduling_1/sequence.png></figure><h1 id=code-context-switching>Code: Context switching</h1><p>xv6がどのようにしてプロセスの切り替えを行っているのか説明します。<br>まず、抑えておいてほしい点です。</p><ol><li>各CPUごとにスケジューラが存在している</li><li>各プロセスは自分自身のカーネルスタックを保持している</li></ol><blockquote><p><figure><img src=https://www.utam0k.jp/blog/2019/12/20/xv6_scheduling_1/fig5-1.png></figure>Source: <a href=https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf>commentary/textbook</a></p></blockquote><p>図は２つのユーザプロセス(shellとcat)がスケジューラによってどのように切り替わるのを説明した大まかな図です。</p><ol><li>shellプロセスはシステムコールや割り込み(e.g.タイマー割り込み)によってshellプロセスのカーネルスレッドに移行</li><li>shellプロセスのコンテキストを保存</li><li>スケジューラスレッドにコンテキストスイッチ</li><li>スケジューリングが走る</li><li>catプロセスのカーネルスレッドにコンテキストスイッチ</li><li>コンテキストをリストアしてcatプロセスに移行</li></ol><h2 id=swtch>swtch()</h2><p>スレッドのsave/restoreを行う関数<br>違うスレッドへの変更は実質、<code>%eip</code>と<code>%esp</code>の変更を意味します。<br><code>entry.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl> <span class=mi>9</span> <span class=p>.</span><span class=n>globl</span> <span class=n>swtch</span>
</span></span><span class=line><span class=cl><span class=mi>10</span> <span class=nl>swtch</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=mi>11</span>   <span class=n>movl</span> <span class=mi>4</span><span class=p>(</span><span class=o>%</span><span class=n>esp</span><span class=p>),</span> <span class=o>%</span><span class=n>eax</span>
</span></span><span class=line><span class=cl><span class=mi>12</span>   <span class=n>movl</span> <span class=mi>8</span><span class=p>(</span><span class=o>%</span><span class=n>esp</span><span class=p>),</span> <span class=o>%</span><span class=n>edx</span>
</span></span><span class=line><span class=cl><span class=mi>13</span>
</span></span><span class=line><span class=cl><span class=mi>14</span>   <span class=err>#</span> <span class=n>Save</span> <span class=n>old</span> <span class=n>callee</span><span class=o>-</span><span class=n>saved</span> <span class=n>registers</span>
</span></span><span class=line><span class=cl><span class=mi>15</span>   <span class=n>pushl</span> <span class=o>%</span><span class=n>ebp</span>
</span></span><span class=line><span class=cl><span class=mi>16</span>   <span class=n>pushl</span> <span class=o>%</span><span class=n>ebx</span>
</span></span><span class=line><span class=cl><span class=mi>17</span>   <span class=n>pushl</span> <span class=o>%</span><span class=n>esi</span>
</span></span><span class=line><span class=cl><span class=mi>18</span>   <span class=n>pushl</span> <span class=o>%</span><span class=n>edi</span>
</span></span><span class=line><span class=cl><span class=mi>19</span>
</span></span><span class=line><span class=cl><span class=mi>20</span>   <span class=err>#</span> <span class=n>Switch</span> <span class=n>stacks</span>
</span></span><span class=line><span class=cl><span class=mi>21</span>   <span class=n>movl</span> <span class=o>%</span><span class=n>esp</span><span class=p>,</span> <span class=p>(</span><span class=o>%</span><span class=n>eax</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>22</span>   <span class=n>movl</span> <span class=o>%</span><span class=n>edx</span><span class=p>,</span> <span class=o>%</span><span class=n>esp</span>
</span></span><span class=line><span class=cl><span class=mi>23</span>
</span></span><span class=line><span class=cl><span class=mi>24</span>   <span class=err>#</span> <span class=n>Load</span> <span class=n>new</span> <span class=n>callee</span><span class=o>-</span><span class=n>saved</span> <span class=n>registers</span>
</span></span><span class=line><span class=cl><span class=mi>25</span>   <span class=n>popl</span> <span class=o>%</span><span class=n>edi</span>
</span></span><span class=line><span class=cl><span class=mi>26</span>   <span class=n>popl</span> <span class=o>%</span><span class=n>esi</span>
</span></span><span class=line><span class=cl><span class=mi>27</span>   <span class=n>popl</span> <span class=o>%</span><span class=n>ebx</span>
</span></span><span class=line><span class=cl><span class=mi>28</span>   <span class=n>popl</span> <span class=o>%</span><span class=n>ebp</span>
</span></span><span class=line><span class=cl><span class=mi>29</span>   <span class=n>ret</span>
</span></span></code></pre></div><p>L11-12: 引数で<code>context</code>の<code>**old</code>と<code>*new</code>が渡されている</p><ul><li><p><code>proc.h</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>27</span> <span class=k>struct</span> <span class=n>context</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>28</span>   <span class=n>uint</span> <span class=n>edi</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>29</span>   <span class=n>uint</span> <span class=n>esi</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>30</span>   <span class=n>uint</span> <span class=n>ebx</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>31</span>   <span class=n>uint</span> <span class=n>ebp</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>32</span>   <span class=n>uint</span> <span class=n>eip</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>33</span> <span class=p>};</span>
</span></span></code></pre></div></li></ul><p>L14-18: 現在のプロセスの<code>context</code>の保存</p><ul><li>callによって<code>eip</code>は保存されている</li></ul><p>L21: 引数で渡されたoldに現在のスタックポインタ、つまり保存した<code>context</code>を代入<br>L22: 引数で渡されたnewをスタックポインタに変更する<br>L24-29: 新しいプロセスの<code>context</code>の復元</p><ul><li>retによって<code>eip</code>は復元される</li></ul><h1 id=code-scheduling>Code: Scheduling</h1><h2 id=trap>trap()</h2><p>タイマー割り込みで<code>yield()</code>が呼ばれる。<br><code>trap.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>36</span> <span class=kt>void</span>                                                                                                                                                                          
</span></span><span class=line><span class=cl><span class=mi>37</span> <span class=nf>trap</span><span class=p>(</span><span class=k>struct</span> <span class=n>trapframe</span> <span class=o>*</span><span class=n>tf</span><span class=p>)</span>                                                                                                                                                    
</span></span><span class=line><span class=cl><span class=o>~~~</span>
</span></span><span class=line><span class=cl><span class=mi>103</span>   <span class=c1>// Force process to give up CPU on clock tick.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>104</span>   <span class=c1>// If interrupts were on while locks held, would need to check nlock.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>105</span>   <span class=k>if</span><span class=p>(</span><span class=nf>myproc</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=nf>myproc</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>state</span> <span class=o>==</span> <span class=n>RUNNING</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl><span class=mi>106</span>      <span class=n>tf</span><span class=o>-&gt;</span><span class=n>trapno</span> <span class=o>==</span> <span class=n>T_IRQ0</span><span class=o>+</span><span class=n>IRQ_TIMER</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>107</span>     <span class=nf>yield</span><span class=p>();</span>
</span></span></code></pre></div><h2 id=yield>yield()</h2><p><code>proc.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>384</span> <span class=c1>// Give up the CPU for one scheduling round.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>385</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=mi>386</span> <span class=nf>yield</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>387</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>388</span>   <span class=nf>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ptable</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>  <span class=c1>//DOC: yieldlock
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>389</span>   <span class=nf>myproc</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>state</span> <span class=o>=</span> <span class=n>RUNNABLE</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>390</span>   <span class=nf>sched</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=mi>391</span>   <span class=nf>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ptable</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>392</span> <span class=p>}</span>
</span></span></code></pre></div><p>L388: <code>ptable</code>のロックを取得<br>L389: 動かしているプロセスを<code>RUNNING</code>から<code>RUNNABLE</code>にする<br>L390: <code>shed()</code>を呼び出す<br>L391: <code>ptable</code>のロックを解放(プロセス再開はここから)</p><h2 id=sched>sched()</h2><p><code>proc.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>365</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=mi>366</span> <span class=nf>sched</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>367</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>371</span>   <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nf>holding</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ptable</span><span class=p>.</span><span class=n>lock</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=mi>372</span>     <span class=nf>panic</span><span class=p>(</span><span class=s>&#34;sched ptable.lock&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>~~~</span>
</span></span><span class=line><span class=cl><span class=mi>379</span>   <span class=n>intena</span> <span class=o>=</span> <span class=nf>mycpu</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>intena</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>380</span>   <span class=nf>swtch</span><span class=p>(</span><span class=o>&amp;</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>,</span> <span class=nf>mycpu</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>scheduler</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>381</span>   <span class=nf>mycpu</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>intena</span> <span class=o>=</span> <span class=n>intena</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>382</span> <span class=p>}</span>
</span></span></code></pre></div><p>L371: 他のCPUがプロセスの状態等を書き換える可能性があるためロック<br>L380: スケジューラにコンテキストスイッチ</p><p><code>ptable</code>のロックについて</p><ul><li><code>yield()</code>でロックを取得して開放している</li><li><code>sched()</code>は<code>yield()</code>(呼び出し元)がロックの取得/解放しているのが前提になっているが普通ではない</li><li>コンテキストスイッチの場合<code>swtch()</code>の実行中は不変条件を満たしていない状態になる
ロックされていない場合<ul><li>プロセスAが実行中に<code>yield()</code>が呼び出され状態を<code>RUNNABLE</code>にセットし、<code>swtch()</code>がプロセスAのカーネルスタックの使用する</li><li>しかし別のCPUがプロセスAが<code>RUNNABLE</code>なのでプロセスAを実行することを決定するかもしれない</li></ul></li></ul><h2 id=scheduler>scheduler()</h2><p>いよいよ、メインのスケジューリングの箇所です。<br>次に動かすプロセスを見つけて、コンテキストスイッチします。<br><code>proc.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>322</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=mi>323</span> <span class=nf>scheduler</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>324</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>325</span>   <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>326</span>   <span class=k>struct</span> <span class=n>cpu</span> <span class=o>*</span><span class=n>c</span> <span class=o>=</span> <span class=nf>mycpu</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=mi>327</span>   <span class=n>c</span><span class=o>-&gt;</span><span class=n>proc</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>328</span>
</span></span><span class=line><span class=cl><span class=mi>329</span>   <span class=k>for</span><span class=p>(;;){</span>
</span></span><span class=line><span class=cl><span class=mi>330</span>     <span class=c1>// Enable interrupts on this processor.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>331</span>     <span class=nf>sti</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=mi>332</span>
</span></span><span class=line><span class=cl><span class=mi>333</span>     <span class=c1>// Loop over process table looking for process to run.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>334</span>     <span class=nf>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ptable</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>335</span>     <span class=k>for</span><span class=p>(</span><span class=n>p</span> <span class=o>=</span> <span class=n>ptable</span><span class=p>.</span><span class=n>proc</span><span class=p>;</span> <span class=n>p</span> <span class=o>&lt;</span> <span class=o>&amp;</span><span class=n>ptable</span><span class=p>.</span><span class=n>proc</span><span class=p>[</span><span class=n>NPROC</span><span class=p>];</span> <span class=n>p</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=mi>336</span>       <span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>state</span> <span class=o>!=</span> <span class=n>RUNNABLE</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>337</span>         <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>338</span>
</span></span><span class=line><span class=cl><span class=mi>339</span>       <span class=c1>// Switch to chosen process.  It is the process&#39;s job
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>340</span>       <span class=c1>// to release ptable.lock and then reacquire it
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>341</span>       <span class=c1>// before jumping back to us.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>342</span>       <span class=n>c</span><span class=o>-&gt;</span><span class=n>proc</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>343</span>       <span class=nf>switchuvm</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>344</span>       <span class=n>p</span><span class=o>-&gt;</span><span class=n>state</span> <span class=o>=</span> <span class=n>RUNNING</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>345</span>
</span></span><span class=line><span class=cl><span class=mi>346</span>       <span class=nf>swtch</span><span class=p>(</span><span class=o>&amp;</span><span class=p>(</span><span class=n>c</span><span class=o>-&gt;</span><span class=n>scheduler</span><span class=p>),</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>347</span>       <span class=nf>switchkvm</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=mi>348</span>
</span></span><span class=line><span class=cl><span class=mi>349</span>       <span class=c1>// Process is done running for now.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>350</span>       <span class=c1>// It should have changed its p-&gt;state before coming back.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>351</span>       <span class=n>c</span><span class=o>-&gt;</span><span class=n>proc</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>352</span>     <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=mi>353</span>     <span class=nf>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ptable</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>354</span>
</span></span><span class=line><span class=cl><span class=mi>355</span>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=mi>356</span> <span class=p>}</span>
</span></span></code></pre></div><p>L329: 無限ループになっている<br>L335-337: 次に動かすプロセス(<code>RUNNEABLE</code>なプロセス)<code>p</code>を探す<br>L343: <code>p</code>のTSS(Task State Segment)をTRにセットして、割り込みなどがあった時に<code>p</code>のカーネルスタックになるようにする<br>L342: <code>myproc()</code>で実行中のプロセスを取得できるようにセット</p><ul><li><p><code>proc.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>57</span> <span class=k>struct</span> <span class=n>proc</span><span class=o>*</span>
</span></span><span class=line><span class=cl><span class=mi>58</span> <span class=nf>myproc</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>59</span>   <span class=k>struct</span> <span class=n>cpu</span> <span class=o>*</span><span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>60</span>   <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>61</span>   <span class=nf>pushcli</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=mi>62</span>   <span class=n>c</span> <span class=o>=</span> <span class=nf>mycpu</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=mi>63</span>   <span class=n>p</span> <span class=o>=</span> <span class=n>c</span><span class=o>-&gt;</span><span class=n>proc</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>64</span>   <span class=nf>popcli</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=mi>65</span>   <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>66</span> <span class=p>}</span>
</span></span></code></pre></div></li></ul><p>L346: <code>p</code>にコンテキストスイッチ<br>L347: メモリ空間の切り替え(<a href=https://www.utam0k.jp/blog/2019/03/05/xv6_pagetable_1//#switchkvm>switchkvm</a>)<br>L351: 動いているプロセスはスケジューラなため、リセットしておく</p><p>もし実行できるプロセスが見つからなかった時の想定<br>L334/353: 実行できるプロセスを探している間のみ<code>ptable</code>をロック</p><ul><li><code>ptable</code>がロックしたままの状態でアイドルすると他のCPUもコンテキストスイッチや<code>ptable</code>を必要とするシステムコールができなくなる</li><li>プロセスの状態を<code>RUNNABLE</code>にできなくなる</li><li>pidの重複を防ぐ</li><li>プロセステーブルの重複を防ぐ</li></ul><p>L331: 割り込みの許可</p><ul><li>シェルなどはよくI/O待ち状態で実行できない状態になるのに割り込み不可の状態でアイドルするとI/O待ちは永遠に終わらなくなる</li></ul><hr><p>xv6のコンテキストスイッチからスケジューリングまでを追ってみました。<br>gdbを使いデバッグしながら動作を確認すると楽しくコードを読めると思います！<br>明日は<a href=https://adventar.org/users/20256>SugarHigh_bin</a>さんの「メモリモデルを考慮した並行記号ファジング」です。</p><hr><hr><p>コメントや間違いなどがある場合は<a href=https://twitter.com/utam0k>Twitter</a>に連絡してもらうか
<a href=https://github.com/utam0k/utam0k.github.io/issues/1>Issue</a>に書いていただくと助かります</p></div><div class=article-footer><a class=muted href=https://www.utam0k.jp/post/>← Back to posts</a><div class=article-nav><a class=nav-arrow href=https://www.utam0k.jp/blog/2019/07/08/xv6_traps_interrupts_drivers_1/>← 詳解xv6 Traps, interrupts, and drivers 1</a>
<a class=nav-arrow href=https://www.utam0k.jp/blog/2020/05/10/vineria-sorcuore/>GWにフロントエンド力を鍛えつつ飲食店の手助けをちょっとできた話 →</a></div></div></article><aside class=toc-desktop><nav class=toc aria-label="Table of contents"><p class=toc__title>目次</p><div class=toc__body><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#アドベントカレンダーの読者向け説明用>アドベントカレンダーの読者向け説明用</a></li></ul></li></ul></li><li><a href=#スケジューリングのシーケンス図>スケジューリングのシーケンス図</a></li><li><a href=#code-context-switching>Code: Context switching</a><ul><li><a href=#swtch>swtch()</a></li></ul></li><li><a href=#code-scheduling>Code: Scheduling</a><ul><li><a href=#trap>trap()</a></li><li><a href=#yield>yield()</a></li><li><a href=#sched>sched()</a></li><li><a href=#scheduler>scheduler()</a></li></ul></li></ul></nav></div></nav><div class="share-block share-block--desktop"><div class=toc-share aria-label="Share this post"><a class=share-btn href="https://twitter.com/intent/tweet?text=%e8%a9%b3%e8%a7%a3xv6%20Scheduling%201&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f12%2f20%2fxv6_scheduling_1%2f" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h5.3l3.4 4.8L14.8 3H21l-6.8 9.2L21 21h-5.3L12 15.8 8.2 21H3l6.8-8.9L3 3z"/></svg>
<span class=sr-only>Share on X</span>
</a><a class=share-btn href="http://b.hatena.ne.jp/add?mode=confirm&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f12%2f20%2fxv6_scheduling_1%2f&title=%e8%a9%b3%e8%a7%a3xv6%20Scheduling%201" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.47.0C22.42.0 24 1.58 24 3.53v16.94c0 1.95-1.58 3.53-3.53 3.53H3.53C1.58 24 0 22.42.0 20.47V3.53C0 1.58 1.58.0 3.53.0h16.94zM8.61 17.25c1.2.0 2.06-.04 2.58-.12.53-.08.98-.22 1.32-.41.45-.23.78-.56 1.02-.99.24-.43.36-.91.36-1.48.0-.78-.21-1.4-.63-1.87-.42-.48-.99-.74-1.74-.79.66-.18 1.16-.45 1.46-.81.32-.34.47-.82.47-1.42.0-.48-.1-.88-.3-1.26-.21-.36-.5-.65-.88-.87-.35-.2-.74-.32-1.22-.4-.46-.08-1.29-.12-2.48-.12H5.65v10.46H8.6zm.74-4.19c.7.0 1.18.09 1.44.27.27.18.4.5.4.93.0.4-.14.69-.42.86-.27.18-.76.25-1.44.25H8.31v-2.31h1.03zm8.66.71V6.71h-2.46v7.06h2.46zM8.93 9.08c.71.0 1.19.08 1.43.24.25.16.37.44.37.84.0.38-.13.65-.39.8-.27.16-.75.24-1.45.24h-.57V9.08h.61z"/></svg>
<span class=sr-only>はてなブックマーク</span>
</a><a class=share-btn href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f12%2f20%2fxv6_scheduling_1%2f&title=%e8%a9%b3%e8%a7%a3xv6%20Scheduling%201" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.45 3.5H3.55A1.55 1.55.0 002 5.05v13.9A1.55 1.55.0 003.55 20.5h16.9A1.55 1.55.0 0022 18.95V5.05A1.55 1.55.0 0020.45 3.5zM7.14 18.1H4.54V9.88h2.6V18.1zm-1.3-9.36a1.51 1.51.0 110-3.02 1.51 1.51.0 010 3.02zM19 18.1h-2.6v-4.96c0-1.18-.42-1.99-1.48-1.99-.81.0-1.3.55-1.51 1.09-.08.19-.1.46-.1.73v5.13H10.7s.03-8.32.0-9.18h2.6v1.3c.35-.54.98-1.31 2.39-1.31 1.74.0 3.31 1.13 3.31 3.56V18.1z"/></svg>
<span class=sr-only>Share on LinkedIn</span></a></div></div></aside></div></main><footer class=site-footer><div class=footer-meta><span>&copy; 2025 Toru Komatsu</span>
<a href=https://twitter.com/utam0k target=_blank rel=noopener class=muted>@utam0k</a></div><div class=footer-links><a class=muted href=https://www.utam0k.jp/index.xml>RSS</a>
<a class=muted href=https://github.com/utam0k target=_blank rel=noopener>GitHub</a></div></footer></div><script defer src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script defer type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script><script>(()=>{const e=document.querySelector(".site-header");if(!e)return;let t=window.scrollY,n=!1;const s=8,o=()=>{const n=window.scrollY;if(n<80){e.classList.remove("is-hidden"),t=n;return}if(Math.abs(n-t)<s)return;n>t?e.classList.add("is-hidden"):e.classList.remove("is-hidden"),t=n};window.addEventListener("scroll",()=>{if(n)return;n=!0,requestAnimationFrame(()=>{o(),n=!1})},{passive:!0})})()</script><script>(()=>{const s=Array.from(document.querySelectorAll(".toc__body a"));if(!s.length)return;const r=e=>decodeURIComponent(e.hash.replace("#","")),o=new Map;s.forEach(e=>{const t=r(e),n=o.get(t)||[];n.push(e),o.set(t,n)});const t=Array.from(new Set(s.map(e=>document.getElementById(r(e))).filter(Boolean)));if(!t.length)return;const i=e=>{o.forEach((t,n)=>{t.forEach(t=>t.classList.toggle("is-active",n===e))})},e=()=>{const n=window.scrollY+120;let e=t[0].id;for(const s of t)if(s.offsetTop<=n)e=s.id;else break;return i(e),e};let n=t[0].id;if(i(n),"IntersectionObserver"in window){const s=new Map,o=()=>{if(s.size){const e=Array.from(s.values()).sort((e,t)=>e.boundingClientRect.top-t.boundingClientRect.top)[0];n=e.target.id,i(n)}else n=e()},a=new IntersectionObserver(e=>{e.forEach(e=>{const t=e.target.id;e.isIntersecting?s.set(t,e):s.delete(t)}),o()},{rootMargin:"0px 0px -65% 0px",threshold:[0,.1,.5]});t.forEach(e=>a.observe(e)),window.addEventListener("load",o),window.addEventListener("resize",o,{passive:!0});return}let a=!1;const c=()=>{if(a)return;a=!0,requestAnimationFrame(()=>{e(),a=!1})};window.addEventListener("scroll",c,{passive:!0}),window.addEventListener("resize",e,{passive:!0}),window.addEventListener("load",e),document.querySelectorAll("img").forEach(t=>t.addEventListener("load",e,{once:!0})),e()})()</script></body></html>