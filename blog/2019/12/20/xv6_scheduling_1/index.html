<!doctype html><html><head><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-119773781-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>詳解xv6 Scheduling 1 &ndash; うたもく</title><meta name=description property="og:description" content="|utam0k"><meta name=apple-mobile-web-app-title content="うたもく"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@utam0k"><meta name=twitter:creator content="@utam0k"><meta name=twitter:title content="詳解xv6 Scheduling 1"><meta name=twitter:image content="https://www.utam0k.jp/img/logo.png"><meta property="og:title" content="詳解xv6 Scheduling 1"><meta property="og:url" content="https://www.utam0k.jp/blog/2019/12/20/xv6_scheduling_1/"><meta property="og:type" content="website"><meta property="og:site_name" content="うたもく"><meta name=og:image content="https://www.utam0k.jp/img/logo.png"><link rel=stylesheet href=https://www.utam0k.jp/assets/syntax.css><link rel=stylesheet href=https://www.utam0k.jp/assets/style.css><link rel=stylesheet href=https://www.utam0k.jp/assets/custom_style.css><link href=https://unpkg.com/@primer/css@^16.0.0/dist/primer.css rel=stylesheet></head><body class=bg-gray><div id=holy class="container-lg bg-white h-100"><div id=header class="px-1 bg-white"><nav class="UnderlineNav UnderlineNav-right px-3"><a class="d-inline-flex UnderlineNav-actions muted-link h2" href=https://www.utam0k.jp/><img class="avatar avatar-5 mr-2" src=https://www.utam0k.jp/img/logo.png><div class=hide-sm><span>うたもく</span></div></a><div class=UnderlineNav-body><a class=UnderlineNav-item href=https://www.utam0k.jp/post/><span>Posts</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/page/about/><span>About</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/en/><span>EN</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/index.xml><span>Atom</span></a></div></nav></div><div role=main id=main class="holy-main markdown-body px-4 bg-white"><div class=Subhead><div class=Subhead-heading><div class="h1 mt-3 mb-1">詳解xv6 Scheduling 1</div></div><div class=Subhead-description><a href=https://www.utam0k.jp/tags/xv6 class=muted-link><span class="Label Label--gray">xv6</span></a>
<a href=https://www.utam0k.jp/tags/os class=muted-link><span class="Label Label--gray">os</span></a><div class=float-md-right><span title="Lastmod: 2019-12-20. Published at: 2019-12-20.">Published: 2019-12-20</span></div></div></div><article><section class="pb-6 mb-3 border-bottom"><p><a href=https://www.utam0k.jp/blog/2019/03/05/xv6_index/>詳解xv6の目次</a><br><a href=https://www.utam0k.jp/blog/2019/07/08/xv6_traps_interrupts_drivers_1/>前の記事</a></p><hr><hr><h3 id=アドベントカレンダーの読者向け説明用>アドベントカレンダーの読者向け説明用</h3><p><a href=https://adventar.org/calendars/4027>自作OSアドベントカレンダー 2019</a> の20日目の記事です。<br>この記事はxv6の説明をシリーズでしているスケジュール編です。<br>アドベントカレンダー向けに話が完結しそうなスケジューラの話を選びました。<br>xv6というなぜこのシリーズを書いているのか、OSの説明や動かし方はこのシリーズの<a href=https://www.utam0k.jp/blog/2019/03/05/xv6_intro/>はじめに</a>をよんでくださると助かります。</p><hr><p>この章は以下のように説明をしていきます。</p><ol><li>コンテキストスイッチの方法(本記事)</li><li>スケジューラによるプロセス切り替えの説明(本記事)</li><li>sleep/wakeupでのプロセス切り替えの方法(次回の記事)</li></ol><h1 id=スケジューリングのシーケンス図>スケジューリングのシーケンス図</h1><p>ざっくりとタイマー割り込みからスケジューラが呼ばれ次のプロセスに移り変わるまでの流れです。<br>newプロセスは時間が経過してシーケンス図でのoldプロセスに移り変わっていきます。<br>newプロセスが処理を再開する箇所はnewプロセスがoldだった時の<code>swtch()</code>を呼び出した直後となるはずです。</p><figure><img src=sequence.png></figure><h1 id=code-context-switching>Code: Context switching</h1><p>xv6がどのようにしてプロセスの切り替えを行っているのか説明します。<br>まず、抑えておいてほしい点です。</p><ol><li>各CPUごとにスケジューラが存在している</li><li>各プロセスは自分自身のカーネルスタックを保持している</li></ol><blockquote><p><figure><img src=fig5-1.png></figure>Source: <a href=https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf>commentary/textbook</a></p></blockquote><p>図は２つのユーザプロセス(shellとcat)がスケジューラによってどのように切り替わるのを説明した大まかな図です。</p><ol><li>shellプロセスはシステムコールや割り込み(e.g.タイマー割り込み)によってshellプロセスのカーネルスレッドに移行</li><li>shellプロセスのコンテキストを保存</li><li>スケジューラスレッドにコンテキストスイッチ</li><li>スケジューリングが走る</li><li>catプロセスのカーネルスレッドにコンテキストスイッチ</li><li>コンテキストをリストアしてcatプロセスに移行</li></ol><h2 id=swtch>swtch()</h2><p>スレッドのsave/restoreを行う関数<br>違うスレッドへの変更は実質、<code>%eip</code>と<code>%esp</code>の変更を意味します。<br><code>entry.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl> <span class=mi>9</span> <span class=p>.</span><span class=n>globl</span> <span class=n>swtch</span>
</span></span><span class=line><span class=cl><span class=mi>10</span> <span class=nl>swtch</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=mi>11</span>   <span class=n>movl</span> <span class=mi>4</span><span class=p>(</span><span class=o>%</span><span class=n>esp</span><span class=p>),</span> <span class=o>%</span><span class=n>eax</span>
</span></span><span class=line><span class=cl><span class=mi>12</span>   <span class=n>movl</span> <span class=mi>8</span><span class=p>(</span><span class=o>%</span><span class=n>esp</span><span class=p>),</span> <span class=o>%</span><span class=n>edx</span>
</span></span><span class=line><span class=cl><span class=mi>13</span>
</span></span><span class=line><span class=cl><span class=mi>14</span>   <span class=err>#</span> <span class=n>Save</span> <span class=n>old</span> <span class=n>callee</span><span class=o>-</span><span class=n>saved</span> <span class=n>registers</span>
</span></span><span class=line><span class=cl><span class=mi>15</span>   <span class=n>pushl</span> <span class=o>%</span><span class=n>ebp</span>
</span></span><span class=line><span class=cl><span class=mi>16</span>   <span class=n>pushl</span> <span class=o>%</span><span class=n>ebx</span>
</span></span><span class=line><span class=cl><span class=mi>17</span>   <span class=n>pushl</span> <span class=o>%</span><span class=n>esi</span>
</span></span><span class=line><span class=cl><span class=mi>18</span>   <span class=n>pushl</span> <span class=o>%</span><span class=n>edi</span>
</span></span><span class=line><span class=cl><span class=mi>19</span>
</span></span><span class=line><span class=cl><span class=mi>20</span>   <span class=err>#</span> <span class=n>Switch</span> <span class=n>stacks</span>
</span></span><span class=line><span class=cl><span class=mi>21</span>   <span class=n>movl</span> <span class=o>%</span><span class=n>esp</span><span class=p>,</span> <span class=p>(</span><span class=o>%</span><span class=n>eax</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>22</span>   <span class=n>movl</span> <span class=o>%</span><span class=n>edx</span><span class=p>,</span> <span class=o>%</span><span class=n>esp</span>
</span></span><span class=line><span class=cl><span class=mi>23</span>
</span></span><span class=line><span class=cl><span class=mi>24</span>   <span class=err>#</span> <span class=n>Load</span> <span class=n>new</span> <span class=n>callee</span><span class=o>-</span><span class=n>saved</span> <span class=n>registers</span>
</span></span><span class=line><span class=cl><span class=mi>25</span>   <span class=n>popl</span> <span class=o>%</span><span class=n>edi</span>
</span></span><span class=line><span class=cl><span class=mi>26</span>   <span class=n>popl</span> <span class=o>%</span><span class=n>esi</span>
</span></span><span class=line><span class=cl><span class=mi>27</span>   <span class=n>popl</span> <span class=o>%</span><span class=n>ebx</span>
</span></span><span class=line><span class=cl><span class=mi>28</span>   <span class=n>popl</span> <span class=o>%</span><span class=n>ebp</span>
</span></span><span class=line><span class=cl><span class=mi>29</span>   <span class=n>ret</span>
</span></span></code></pre></div><p>L11-12: 引数で<code>context</code>の<code>**old</code>と<code>*new</code>が渡されている</p><ul><li><p><code>proc.h</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>27</span> <span class=k>struct</span> <span class=n>context</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>28</span>   <span class=n>uint</span> <span class=n>edi</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>29</span>   <span class=n>uint</span> <span class=n>esi</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>30</span>   <span class=n>uint</span> <span class=n>ebx</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>31</span>   <span class=n>uint</span> <span class=n>ebp</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>32</span>   <span class=n>uint</span> <span class=n>eip</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>33</span> <span class=p>};</span>
</span></span></code></pre></div></li></ul><p>L14-18: 現在のプロセスの<code>context</code>の保存</p><ul><li>callによって<code>eip</code>は保存されている</li></ul><p>L21: 引数で渡されたoldに現在のスタックポインタ、つまり保存した<code>context</code>を代入<br>L22: 引数で渡されたnewをスタックポインタに変更する<br>L24-29: 新しいプロセスの<code>context</code>の復元</p><ul><li>retによって<code>eip</code>は復元される</li></ul><h1 id=code-scheduling>Code: Scheduling</h1><h2 id=trap>trap()</h2><p>タイマー割り込みで<code>yield()</code>が呼ばれる。<br><code>trap.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>36</span> <span class=kt>void</span>                                                                                                                                                                          
</span></span><span class=line><span class=cl><span class=mi>37</span> <span class=nf>trap</span><span class=p>(</span><span class=k>struct</span> <span class=n>trapframe</span> <span class=o>*</span><span class=n>tf</span><span class=p>)</span>                                                                                                                                                    
</span></span><span class=line><span class=cl><span class=o>~~~</span>
</span></span><span class=line><span class=cl><span class=mi>103</span>   <span class=c1>// Force process to give up CPU on clock tick.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>104</span>   <span class=c1>// If interrupts were on while locks held, would need to check nlock.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>105</span>   <span class=k>if</span><span class=p>(</span><span class=nf>myproc</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=nf>myproc</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>state</span> <span class=o>==</span> <span class=n>RUNNING</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl><span class=mi>106</span>      <span class=n>tf</span><span class=o>-&gt;</span><span class=n>trapno</span> <span class=o>==</span> <span class=n>T_IRQ0</span><span class=o>+</span><span class=n>IRQ_TIMER</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>107</span>     <span class=nf>yield</span><span class=p>();</span>
</span></span></code></pre></div><h2 id=yield>yield()</h2><p><code>proc.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>384</span> <span class=c1>// Give up the CPU for one scheduling round.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>385</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=mi>386</span> <span class=nf>yield</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>387</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>388</span>   <span class=nf>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ptable</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>  <span class=c1>//DOC: yieldlock
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>389</span>   <span class=nf>myproc</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>state</span> <span class=o>=</span> <span class=n>RUNNABLE</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>390</span>   <span class=nf>sched</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=mi>391</span>   <span class=nf>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ptable</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>392</span> <span class=p>}</span>
</span></span></code></pre></div><p>L388: <code>ptable</code>のロックを取得<br>L389: 動かしているプロセスを<code>RUNNING</code>から<code>RUNNABLE</code>にする<br>L390: <code>shed()</code>を呼び出す<br>L391: <code>ptable</code>のロックを解放(プロセス再開はここから)</p><h2 id=sched>sched()</h2><p><code>proc.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>365</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=mi>366</span> <span class=nf>sched</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>367</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>371</span>   <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nf>holding</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ptable</span><span class=p>.</span><span class=n>lock</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=mi>372</span>     <span class=nf>panic</span><span class=p>(</span><span class=s>&#34;sched ptable.lock&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>~~~</span>
</span></span><span class=line><span class=cl><span class=mi>379</span>   <span class=n>intena</span> <span class=o>=</span> <span class=nf>mycpu</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>intena</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>380</span>   <span class=nf>swtch</span><span class=p>(</span><span class=o>&amp;</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>,</span> <span class=nf>mycpu</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>scheduler</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>381</span>   <span class=nf>mycpu</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>intena</span> <span class=o>=</span> <span class=n>intena</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>382</span> <span class=p>}</span>
</span></span></code></pre></div><p>L371: 他のCPUがプロセスの状態等を書き換える可能性があるためロック<br>L380: スケジューラにコンテキストスイッチ</p><p><code>ptable</code>のロックについて</p><ul><li><code>yield()</code>でロックを取得して開放している</li><li><code>sched()</code>は<code>yield()</code>(呼び出し元)がロックの取得/解放しているのが前提になっているが普通ではない</li><li>コンテキストスイッチの場合<code>swtch()</code>の実行中は不変条件を満たしていない状態になる
ロックされていない場合<ul><li>プロセスAが実行中に<code>yield()</code>が呼び出され状態を<code>RUNNABLE</code>にセットし、<code>swtch()</code>がプロセスAのカーネルスタックの使用する</li><li>しかし別のCPUがプロセスAが<code>RUNNABLE</code>なのでプロセスAを実行することを決定するかもしれない</li></ul></li></ul><h2 id=scheduler>scheduler()</h2><p>いよいよ、メインのスケジューリングの箇所です。<br>次に動かすプロセスを見つけて、コンテキストスイッチします。<br><code>proc.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>322</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=mi>323</span> <span class=nf>scheduler</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>324</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>325</span>   <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>326</span>   <span class=k>struct</span> <span class=n>cpu</span> <span class=o>*</span><span class=n>c</span> <span class=o>=</span> <span class=nf>mycpu</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=mi>327</span>   <span class=n>c</span><span class=o>-&gt;</span><span class=n>proc</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>328</span>
</span></span><span class=line><span class=cl><span class=mi>329</span>   <span class=k>for</span><span class=p>(;;){</span>
</span></span><span class=line><span class=cl><span class=mi>330</span>     <span class=c1>// Enable interrupts on this processor.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>331</span>     <span class=nf>sti</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=mi>332</span>
</span></span><span class=line><span class=cl><span class=mi>333</span>     <span class=c1>// Loop over process table looking for process to run.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>334</span>     <span class=nf>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ptable</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>335</span>     <span class=k>for</span><span class=p>(</span><span class=n>p</span> <span class=o>=</span> <span class=n>ptable</span><span class=p>.</span><span class=n>proc</span><span class=p>;</span> <span class=n>p</span> <span class=o>&lt;</span> <span class=o>&amp;</span><span class=n>ptable</span><span class=p>.</span><span class=n>proc</span><span class=p>[</span><span class=n>NPROC</span><span class=p>];</span> <span class=n>p</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=mi>336</span>       <span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>state</span> <span class=o>!=</span> <span class=n>RUNNABLE</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>337</span>         <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>338</span>
</span></span><span class=line><span class=cl><span class=mi>339</span>       <span class=c1>// Switch to chosen process.  It is the process&#39;s job
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>340</span>       <span class=c1>// to release ptable.lock and then reacquire it
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>341</span>       <span class=c1>// before jumping back to us.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>342</span>       <span class=n>c</span><span class=o>-&gt;</span><span class=n>proc</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>343</span>       <span class=nf>switchuvm</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>344</span>       <span class=n>p</span><span class=o>-&gt;</span><span class=n>state</span> <span class=o>=</span> <span class=n>RUNNING</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>345</span>
</span></span><span class=line><span class=cl><span class=mi>346</span>       <span class=nf>swtch</span><span class=p>(</span><span class=o>&amp;</span><span class=p>(</span><span class=n>c</span><span class=o>-&gt;</span><span class=n>scheduler</span><span class=p>),</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>347</span>       <span class=nf>switchkvm</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=mi>348</span>
</span></span><span class=line><span class=cl><span class=mi>349</span>       <span class=c1>// Process is done running for now.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>350</span>       <span class=c1>// It should have changed its p-&gt;state before coming back.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>351</span>       <span class=n>c</span><span class=o>-&gt;</span><span class=n>proc</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>352</span>     <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=mi>353</span>     <span class=nf>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ptable</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>354</span>
</span></span><span class=line><span class=cl><span class=mi>355</span>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=mi>356</span> <span class=p>}</span>
</span></span></code></pre></div><p>L329: 無限ループになっている<br>L335-337: 次に動かすプロセス(<code>RUNNEABLE</code>なプロセス)<code>p</code>を探す<br>L343: <code>p</code>のTSS(Task State Segment)をTRにセットして、割り込みなどがあった時に<code>p</code>のカーネルスタックになるようにする<br>L342: <code>myproc()</code>で実行中のプロセスを取得できるようにセット</p><ul><li><p><code>proc.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>57</span> <span class=k>struct</span> <span class=n>proc</span><span class=o>*</span>
</span></span><span class=line><span class=cl><span class=mi>58</span> <span class=nf>myproc</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>59</span>   <span class=k>struct</span> <span class=n>cpu</span> <span class=o>*</span><span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>60</span>   <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>61</span>   <span class=nf>pushcli</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=mi>62</span>   <span class=n>c</span> <span class=o>=</span> <span class=nf>mycpu</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=mi>63</span>   <span class=n>p</span> <span class=o>=</span> <span class=n>c</span><span class=o>-&gt;</span><span class=n>proc</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>64</span>   <span class=nf>popcli</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=mi>65</span>   <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>66</span> <span class=p>}</span>
</span></span></code></pre></div></li></ul><p>L346: <code>p</code>にコンテキストスイッチ<br>L347: メモリ空間の切り替え(<a href=https://www.utam0k.jp/blog/2019/03/05/xv6_pagetable_1//#switchkvm>switchkvm</a>)<br>L351: 動いているプロセスはスケジューラなため、リセットしておく</p><p>もし実行できるプロセスが見つからなかった時の想定<br>L334/353: 実行できるプロセスを探している間のみ<code>ptable</code>をロック</p><ul><li><code>ptable</code>がロックしたままの状態でアイドルすると他のCPUもコンテキストスイッチや<code>ptable</code>を必要とするシステムコールができなくなる</li><li>プロセスの状態を<code>RUNNABLE</code>にできなくなる</li><li>pidの重複を防ぐ</li><li>プロセステーブルの重複を防ぐ</li></ul><p>L331: 割り込みの許可</p><ul><li>シェルなどはよくI/O待ち状態で実行できない状態になるのに割り込み不可の状態でアイドルするとI/O待ちは永遠に終わらなくなる</li></ul><hr><p>xv6のコンテキストスイッチからスケジューリングまでを追ってみました。<br>gdbを使いデバッグしながら動作を確認すると楽しくコードを読めると思います！<br>明日は<a href=https://adventar.org/users/20256>SugarHigh_bin</a>さんの「メモリモデルを考慮した並行記号ファジング」です。</p><hr><hr><p>コメントや間違いなどがある場合は<a href=https://twitter.com/utam0k>Twitter</a>に連絡してもらうか
<a href=https://github.com/utam0k/utam0k.github.io/issues/1>Issue</a>に書いていただくと助かります</p></section><style>#share-buttons{display:inline-block;vertical-align:middle}#share-buttons:after{content:"";display:block;clear:both}#share-buttons>div{position:relative;text-align:left;height:36px;width:32px;float:left;text-align:center}#share-buttons>div>svg{height:16px;fill:#d5d5d5;margin-top:10px}#share-buttons>div:hover{cursor:pointer}#share-buttons>div.facebook:hover>svg{fill:#3b5998}#share-buttons>div.twitter:hover>svg{fill:#55acee}#share-buttons>div.hatebu:hover>svg{fill:#00a4de}#share-buttons>div.linkedin:hover>svg{fill:#0077b5}#share-buttons>div.pinterest:hover>svg{fill:#cb2027}#share-buttons>div.mail:hover>svg{fill:#7d7d7d}#share-buttons>div.facebook>svg{height:18px;margin-top:9px}#share-buttons>div.twitter>svg{height:20px;margin-top:8px}#share-buttons>div.linkedin>svg{height:19px;margin-top:7px}#share-buttons>div.pinterest>svg{height:20px;margin-top:9px}#share-buttons>div.mail>svg{height:14px;margin-top:11px}</style><span style=color:silver>Share on:</span><div id=share-buttons><div class=facebook title="Share this on Facebook" onclick='window.open("http://www.facebook.com/share.php?u=https://www.utam0k.jp/blog/2019/12/20/xv6_scheduling_1/")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759H734V905H479V609h255V391q0-186 104-288.5T1115 0q147 0 228 12z"/></svg></div><div class=twitter title="Share this on Twitter" onclick='window.open("http://twitter.com/intent/tweet?text=詳解xv6 Scheduling 1&url=https://www.utam0k.jp/blog/2019/12/20/xv6_scheduling_1/")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5T1369.5 1125 1185 1335.5t-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5T285 1033q33 5 61 5 43 0 85-11-112-23-185.5-111.5T172 710v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5T884 653q-8-38-8-74 0-134 94.5-228.5T1199 256q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div><div class=linkedin title="Share this on Linkedin" onclick='window.open("https://www.linkedin.com/shareArticle?mini=true&url=https://www.utam0k.jp/blog/2019/12/20/xv6_scheduling_1/&title=&summary=&source=")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991H147V625h330zm21-306q1 73-50.5 122T312 490h-2q-82 0-132-49t-50-122q0-74 51.5-122.5T314 148t133 48.5T498 319zm1166 729v568h-329v-530q0-105-40.5-164.5T1168 862q-63 0-105.5 34.5T999 982q-11 30-11 81v553H659q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5T1285 602q171 0 275 113.5t104 332.5z"/></svg></div><div class=hatebu title="Share this on Hatebu" onclick='window.open("http://b.hatena.ne.jp/add?mode=confirm&url=https://www.utam0k.jp/blog/2019/12/20/xv6_scheduling_1/&title=詳解xv6 Scheduling 1")'><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.47.0C22.42.0 24 1.58 24 3.53v16.94c0 1.95-1.58 3.53-3.53 3.53H3.53C1.58 24 0 22.42.0 20.47V3.53C0 1.58 1.58.0 3.53.0h16.94zm-3.705 14.47c-.78.0-1.41.63-1.41 1.41s.63 1.414 1.41 1.414 1.41-.645 1.41-1.425-.63-1.41-1.41-1.41zM8.61 17.247c1.2.0 2.056-.042 2.58-.12.526-.084.976-.222 1.32-.412.45-.232.78-.564 1.02-.99s.36-.915.36-1.48c0-.78-.21-1.403-.63-1.87-.42-.48-.99-.734-1.74-.794.66-.18 1.156-.45 1.456-.81.315-.344.465-.824.465-1.424.0-.48-.103-.885-.3-1.26-.21-.36-.493-.645-.883-.87-.345-.195-.735-.315-1.215-.405-.464-.074-1.29-.12-2.474-.12H5.654v10.486H8.61zm.736-4.185c.705.0 1.185.088 1.44.262.27.18.39.495.39.93.0.405-.135.69-.42.855-.27.18-.765.254-1.44.254H8.31v-2.297h1.05zm8.656.706v-7.06h-2.46v7.06H18zM8.925 9.08c.71.0 1.185.08 1.432.24.245.16.367.435.367.83.0.38-.13.646-.39.804-.265.154-.747.232-1.452.232h-.57V9.08h.615z"/></svg></div><div class=mail title="Share this through Email" onclick='window.open("mailto:?&body=https://www.utam0k.jp/blog/2019/12/20/xv6_scheduling_1/")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47H160q-66 0-113-47T0 1504V710q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 1e2-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38T639 1015q-91-64-262-182.5T172 690q-62-42-117-115.5T0 438q0-78 41.5-130T160 256h1472q65 0 112.5 47t47.5 113z"/></svg></div></div><section><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//utam0k.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></article></div><div id=side class="pr-1 bg-white"><aside class=pr-3><div id=toc class="Box Box--blue mb-3"><b>詳解xv6 Scheduling 1</b><nav id=TableOfContents><ul><li><ul><li><a href=#アドベントカレンダーの読者向け説明用>アドベントカレンダーの読者向け説明用</a></li></ul></li></ul><ul><li><a href=#swtch>swtch()</a></li></ul><ul><li><a href=#trap>trap()</a></li><li><a href=#yield>yield()</a></li><li><a href=#sched>sched()</a></li><li><a href=#scheduler>scheduler()</a></li></ul></nav></div><style>#share-buttons{display:inline-block;vertical-align:middle}#share-buttons:after{content:"";display:block;clear:both}#share-buttons>div{position:relative;text-align:left;height:36px;width:32px;float:left;text-align:center}#share-buttons>div>svg{height:16px;fill:#d5d5d5;margin-top:10px}#share-buttons>div:hover{cursor:pointer}#share-buttons>div.facebook:hover>svg{fill:#3b5998}#share-buttons>div.twitter:hover>svg{fill:#55acee}#share-buttons>div.hatebu:hover>svg{fill:#00a4de}#share-buttons>div.linkedin:hover>svg{fill:#0077b5}#share-buttons>div.pinterest:hover>svg{fill:#cb2027}#share-buttons>div.mail:hover>svg{fill:#7d7d7d}#share-buttons>div.facebook>svg{height:18px;margin-top:9px}#share-buttons>div.twitter>svg{height:20px;margin-top:8px}#share-buttons>div.linkedin>svg{height:19px;margin-top:7px}#share-buttons>div.pinterest>svg{height:20px;margin-top:9px}#share-buttons>div.mail>svg{height:14px;margin-top:11px}</style><span style=color:silver>Share on:</span><div id=share-buttons><div class=facebook title="Share this on Facebook" onclick='window.open("http://www.facebook.com/share.php?u=https://www.utam0k.jp/blog/2019/12/20/xv6_scheduling_1/")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759H734V905H479V609h255V391q0-186 104-288.5T1115 0q147 0 228 12z"/></svg></div><div class=twitter title="Share this on Twitter" onclick='window.open("http://twitter.com/intent/tweet?text=詳解xv6 Scheduling 1&url=https://www.utam0k.jp/blog/2019/12/20/xv6_scheduling_1/")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5T1369.5 1125 1185 1335.5t-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5T285 1033q33 5 61 5 43 0 85-11-112-23-185.5-111.5T172 710v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5T884 653q-8-38-8-74 0-134 94.5-228.5T1199 256q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div><div class=linkedin title="Share this on Linkedin" onclick='window.open("https://www.linkedin.com/shareArticle?mini=true&url=https://www.utam0k.jp/blog/2019/12/20/xv6_scheduling_1/&title=&summary=&source=")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991H147V625h330zm21-306q1 73-50.5 122T312 490h-2q-82 0-132-49t-50-122q0-74 51.5-122.5T314 148t133 48.5T498 319zm1166 729v568h-329v-530q0-105-40.5-164.5T1168 862q-63 0-105.5 34.5T999 982q-11 30-11 81v553H659q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5T1285 602q171 0 275 113.5t104 332.5z"/></svg></div><div class=hatebu title="Share this on Hatebu" onclick='window.open("http://b.hatena.ne.jp/add?mode=confirm&url=https://www.utam0k.jp/blog/2019/12/20/xv6_scheduling_1/&title=詳解xv6 Scheduling 1")'><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.47.0C22.42.0 24 1.58 24 3.53v16.94c0 1.95-1.58 3.53-3.53 3.53H3.53C1.58 24 0 22.42.0 20.47V3.53C0 1.58 1.58.0 3.53.0h16.94zm-3.705 14.47c-.78.0-1.41.63-1.41 1.41s.63 1.414 1.41 1.414 1.41-.645 1.41-1.425-.63-1.41-1.41-1.41zM8.61 17.247c1.2.0 2.056-.042 2.58-.12.526-.084.976-.222 1.32-.412.45-.232.78-.564 1.02-.99s.36-.915.36-1.48c0-.78-.21-1.403-.63-1.87-.42-.48-.99-.734-1.74-.794.66-.18 1.156-.45 1.456-.81.315-.344.465-.824.465-1.424.0-.48-.103-.885-.3-1.26-.21-.36-.493-.645-.883-.87-.345-.195-.735-.315-1.215-.405-.464-.074-1.29-.12-2.474-.12H5.654v10.486H8.61zm.736-4.185c.705.0 1.185.088 1.44.262.27.18.39.495.39.93.0.405-.135.69-.42.855-.27.18-.765.254-1.44.254H8.31v-2.297h1.05zm8.656.706v-7.06h-2.46v7.06H18zM8.925 9.08c.71.0 1.185.08 1.432.24.245.16.367.435.367.83.0.38-.13.646-.39.804-.265.154-.747.232-1.452.232h-.57V9.08h.615z"/></svg></div><div class=mail title="Share this through Email" onclick='window.open("mailto:?&body=https://www.utam0k.jp/blog/2019/12/20/xv6_scheduling_1/")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47H160q-66 0-113-47T0 1504V710q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 1e2-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38T639 1015q-91-64-262-182.5T172 690q-62-42-117-115.5T0 438q0-78 41.5-130T160 256h1472q65 0 112.5 47t47.5 113z"/></svg></div></div></aside></div><div id=footer class="pt-2 pb-3 bg-white text-center"></div></div><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script></body></html>