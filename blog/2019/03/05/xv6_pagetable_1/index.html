<!doctype html><html><head><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-119773781-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>詳解xv6 Page tables 1 &ndash; うたもく</title><meta name=description property="og:description" content="詳解xv6の目次 次の記事 単語説明 PA(Physical Address): 物理アドレス VA(Virtual Address): 仮想アドレス ページング関係 ページングについて参考にしたサイト PTE: ページテーブルエントリ xv|utam0k"><meta name=apple-mobile-web-app-title content="うたもく"><link rel=stylesheet href=https://www.utam0k.jp/assets/syntax.css><link rel=stylesheet href=https://www.utam0k.jp/assets/primer-build.css><link rel=stylesheet href=https://www.utam0k.jp/assets/style.css><link rel=stylesheet href=https://www.utam0k.jp/assets/custom_style.css></head><body class=bg-gray><div id=holy class="container-lg bg-white h-100"><div id=header class="px-1 bg-white"><nav class="UnderlineNav UnderlineNav--right px-2"><a class="UnderlineNav-actions muted-link h2" href=https://www.utam0k.jp/>うたもく</a><div class=UnderlineNav-body><a class=UnderlineNav-item href=https://www.utam0k.jp/post/><span>Posts</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/tags><span>Tags</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/page/about/><span>About</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/index.xml><span>Atom</span></a></div></nav></div><div role=main id=main class="holy-main markdown-body px-4 bg-white"><div class=Subhead><div class=Subhead-heading><div class="h1 mt-3 mb-1">詳解xv6 Page tables 1</div></div><div class=Subhead-description><a href=https://www.utam0k.jp/tags/xv6 class=muted-link><span class="Label Label--gray">xv6</span></a>
<a href=https://www.utam0k.jp/tags/os class=muted-link><span class="Label Label--gray">os</span></a><div class=float-md-right><span title="Lastmod: 2019-03-05. Published at: 2019-03-05.">Published: 2019-03-05</span></div></div></div><article><section class="pb-6 mb-3 border-bottom"><p><a href=https://www.utam0k.jp/blog/2019/03/05/xv6_index/>詳解xv6の目次</a><br><a href=https://www.utam0k.jp/blog/2019/04/25/xv6_pagetable_2/>次の記事</a></p><hr><h1 id=単語説明>単語説明</h1><ul><li>PA(Physical Address): 物理アドレス</li><li>VA(Virtual Address): 仮想アドレス</li></ul><h4 id=ページング関係>ページング関係</h4><ul><li><a href=http://softwaretechnique.jp/OS_Development/kernel_development07.html>ページングについて参考にしたサイト</a></li><li>PTE: ページテーブルエントリ<ul><li><p>xv6では1PTEで4KBのアドレス空間を表現する</p></li><li><blockquote><p><a href=https://gyazo.com/76f1ccd02fb190c6e714b3f2cca72e2e><img src=https://gyazo.com/76f1ccd02fb190c6e714b3f2cca72e2e/thumb/1000 alt=Image></a>
Source: <a href=http://softwaretechnique.jp/OS_Development/kernel_development07.html>０から作るOS開発　ページングその１　ページとPTEとPDE</a></p></blockquote></li><li><p>4KB分のメモリの最初のアドレスを設定する</p></li><li><p>ページテーブルはPTEが1024個で構成されている</p><ul><li>1ページテーブルで4KB * 1024 = 4MBのアドレス空間を表現できる</li></ul></li></ul></li><li>PDE: ページディレクトリエントリ<ul><li><p>ページテーブルを指す</p></li><li><blockquote><p><a href=https://gyazo.com/1498fc91c4888457c8f88dca9f3c65d8><img src=https://gyazo.com/1498fc91c4888457c8f88dca9f3c65d8/thumb/1000 alt=Image></a>
Source: <a href=http://softwaretechnique.jp/OS_Development/kernel_development07.html>０から作るOS開発　ページングその１　ページとPTEとPDE</a></p></blockquote></li></ul></li><li>PDT: ページディレクトリテーブル<ul><li>ソースコード内では<code>pgdir</code>で表される</li><li>PDEを1024個で構成されるテーブル</li><li>1PDTで4MB * 1024 = 4GBのアドレス空間を表現できる</li></ul></li></ul><pre><code>Page Directory Table         4MB*1024=4GB
+-------------------------------------------------------------------+
| +---------+           +---------+                    +---------+  |
| | PDE[0]  |           | PDE[1]  |         ...        |PDE[1023]|  |
| +----+----+           +----+----+                    +----+----+  |
|      |                     |                              |       |
+-------------------------------------------------------------------+
       |                     |                              |
       v                     v                              v
+--------------+      +--------------+               +--------------+  +--+
| +----------+ |      | +----------+ |               | +----------+ |     |
| |  PTE[0]  | |      | |  PTE[0]  | |               | |  PTE[0]  | |     |
| +----------+ |      | +----------+ |               | +----------+ |     |
| +----------+ |      | +----------+ |               | +----------+ |     |
| |  PTE[1]  | |      | |  PTE[1]  | |      ...      | |  PTE[1]  | |     |
| +----------+ |      | +----------+ |               | +----------+ |     | 4KB*1024=4MB
|       .      |      |       .      |               |       .      |     |
|       .      |      |       .      |               |       .      |     |
|       .      |      |       .      |               |       .      |     |
| +----------+ |      | +----------+ |               | +----------+ |     |
| | PTE[1023]| |      | | PTE[1023]| |               | | PTE[1023]| |     |
| +----------+ |      | +----------+ |               | +----------+ |     |
+--------------+      +--------------+               +--------------+  +--+
   Page Table            Page Table                     Page Table
</code></pre><h1 id=code-creating-an-address-space>Code: creating an address space</h1><p>本章ではxv6が作るカーネルのアドレス空間、つまりページングの設定を行うコードの解説です。
カーネルのアドレス空間のVAとPAは図のようにマッピングしていきます。<br><strong>本章の解説するコードの目的は図のマッピングを作ることです。</strong></p><blockquote></blockquote><pre><code>&lt;img src=&quot;memorylayout.png&quot;/&gt; 
</code></pre><p>Source: <a href=https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf>commentary/textbook</a></p><p>どのプロセスにもカーネル用の仮想アドレス空間が設定されています。
図のように1プロセスには4GBの仮想メモリ空間が割り当てられますが、
KERNBASE~4GBまではカーネル用の仮想アドレス空間になっています。
カーネル用のアドレス空間はVAとPAが必ず図のように固定でマッピングされます。</p><h3 id=シーケンス図>シーケンス図</h3><p>エラー処理等を省いたざっくりとしたシーケンスです。
今見ている関数はどこから呼ばれるんだっけとなったときに見てもらえればと思います。</p><h3 id=main>main()</h3><p>メイン関数</p><ul><li><p><code>main.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>14</span> <span class=c1>// Bootstrap processor starts running C code here.
</span><span class=c1></span><span class=mi>15</span> <span class=c1>// Allocate a real stack and switch to it, first
</span><span class=c1></span><span class=mi>16</span> <span class=c1>// doing some setup required for memory allocator to work.
</span><span class=c1></span><span class=mi>17</span> <span class=kt>int</span>
<span class=mi>18</span> <span class=n>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=mi>19</span> <span class=p>{</span>
<span class=mi>20</span>   <span class=n>kinit1</span><span class=p>(</span><span class=n>end</span><span class=p>,</span> <span class=n>P2V</span><span class=p>(</span><span class=mi>4</span><span class=o>*</span><span class=mi>1024</span><span class=o>*</span><span class=mi>1024</span><span class=p>));</span> <span class=c1>// phys page allocator
</span><span class=c1></span><span class=mi>21</span>   <span class=nf>kvmalloc</span><span class=p>();</span>      <span class=c1>// kernel page table
</span><span class=c1></span><span class=o>~~~</span>
<span class=mi>37</span>   <span class=n>mpmain</span><span class=p>();</span>        <span class=c1>// finish this processor&#39;s setup
</span><span class=c1></span><span class=mi>38</span> <span class=p>}</span>
</code></pre></div></li><li><p>L21: カーネル用ページテーブルの作成</p></li></ul><h3 id=kvmalloc>kvmalloc()</h3><p>カーネル用のページテーブルを作成して作成したページテーブルに切り替える</p><ul><li><p>作成するのはページディレクトリエントリを1つのみ</p></li><li><p><a href=#setupkvm>setupkvm()</a>はPDEを返すがそれを先頭アドレスとしたPDTとも見れる</p></li><li><p><code>vm.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>138</span> <span class=c1>// Allocate one page table for the machine for the kernel address
</span><span class=c1></span><span class=mi>139</span> <span class=c1>// space for scheduler processes.
</span><span class=c1></span><span class=mi>140</span> <span class=kt>void</span>
<span class=mi>141</span> <span class=n>kvmalloc</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=mi>142</span> <span class=p>{</span>
<span class=mi>143</span>   <span class=n>kpgdir</span> <span class=o>=</span> <span class=n>setupkvm</span><span class=p>();</span>
<span class=mi>144</span>   <span class=nf>switchkvm</span><span class=p>();</span>
<span class=mi>145</span> <span class=p>}</span>
</code></pre></div></li></ul><h3 id=switchkvm>switchkvm()</h3><p>カーネル用のページテーブルに切り替え</p><ul><li><p><code>vm.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>147</span> <span class=c1>// Switch h/w page table register to the kernel-only page table,
</span><span class=c1></span><span class=mi>148</span> <span class=c1>// for when no process is running.
</span><span class=c1></span><span class=mi>149</span> <span class=kt>void</span>
<span class=mi>150</span> <span class=n>switchkvm</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=mi>151</span> <span class=p>{</span>
<span class=mi>152</span>   <span class=n>lcr3</span><span class=p>(</span><span class=n>V2P</span><span class=p>(</span><span class=n>kpgdir</span><span class=p>));</span>   <span class=c1>// switch to the kernel page table
</span><span class=c1></span><span class=mi>153</span> <span class=p>}</span>
</code></pre></div></li><li><p>L152: <code>cr3</code>レジスタを更新</p><ul><li>PDTの変更、つまりメモリ空間を変える</li><li><code>cr3</code> を別のページディレクトリに切り替える = プロセス空間の切り替えに相当<ul><li><code>cr3</code>が<code>pde[0]</code>を指せばおっけ</li></ul></li></ul></li></ul><h3 id=v2p>V2P()</h3><ul><li><p><code>memlayout.h</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c> <span class=mi>8</span> <span class=err>#</span><span class=n>define</span> <span class=n>KERNBASE</span> <span class=mh>0x80000000</span>         <span class=c1>// First kernel virtual address
</span><span class=c1></span><span class=o>~~~</span>
<span class=mi>11</span> <span class=err>#</span><span class=n>define</span> <span class=n>V2P</span><span class=p>(</span><span class=n>a</span><span class=p>)</span> <span class=p>(((</span><span class=n>uint</span><span class=p>)</span> <span class=p>(</span><span class=n>a</span><span class=p>))</span> <span class=o>-</span> <span class=n>KERNBASE</span><span class=p>)</span>
</code></pre></div></li><li><p>L11: カーネルの物理メモリは決め打ちでわかる</p></li><li><blockquote></blockquote></li></ul><p>Source: <a href=https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf>commentary/textbook</a> + 赤色書き加え</p><h3 id=setupkvm>setupkvm()</h3><p>カーネルのPDEを作成</p><ul><li><p><code>vm.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>103</span> <span class=c1>// This table defines the kernel&#39;s mappings, which are present in
</span><span class=c1></span><span class=mi>104</span> <span class=c1>// every process&#39;s page table.
</span><span class=c1></span><span class=mi>105</span> <span class=k>static</span> <span class=k>struct</span> <span class=n>kmap</span> <span class=p>{</span>
<span class=mi>106</span>   <span class=kt>void</span> <span class=o>*</span><span class=n>virt</span><span class=p>;</span>
<span class=mi>107</span>   <span class=n>uint</span> <span class=n>phys_start</span><span class=p>;</span>
<span class=mi>108</span>   <span class=n>uint</span> <span class=n>phys_end</span><span class=p>;</span>
<span class=mi>109</span>   <span class=kt>int</span> <span class=n>perm</span><span class=p>;</span>
<span class=mi>110</span> <span class=p>}</span> <span class=n>kmap</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
<span class=mi>111</span>  <span class=p>{</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>KERNBASE</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span>             <span class=n>EXTMEM</span><span class=p>,</span>    <span class=n>PTE_W</span><span class=p>},</span> <span class=c1>// I/O space
</span><span class=c1></span><span class=mi>112</span>  <span class=p>{</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>KERNLINK</span><span class=p>,</span> <span class=n>V2P</span><span class=p>(</span><span class=n>KERNLINK</span><span class=p>),</span> <span class=n>V2P</span><span class=p>(</span><span class=n>data</span><span class=p>),</span> <span class=mi>0</span><span class=p>},</span>     <span class=c1>// kern text+rodata
</span><span class=c1></span><span class=mi>113</span>  <span class=p>{</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>data</span><span class=p>,</span>     <span class=n>V2P</span><span class=p>(</span><span class=n>data</span><span class=p>),</span>     <span class=n>PHYSTOP</span><span class=p>,</span>   <span class=n>PTE_W</span><span class=p>},</span> <span class=c1>// kern data+memory
</span><span class=c1></span><span class=mi>114</span>  <span class=p>{</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>DEVSPACE</span><span class=p>,</span> <span class=n>DEVSPACE</span><span class=p>,</span>      <span class=mi>0</span><span class=p>,</span>         <span class=n>PTE_W</span><span class=p>},</span> <span class=c1>// more devices
</span><span class=c1></span><span class=mi>115</span> <span class=p>};</span>
<span class=mi>116</span>
<span class=mi>117</span> <span class=c1>// Set up kernel part of a page table.
</span><span class=c1></span><span class=mi>118</span> <span class=n>pde_t</span><span class=o>*</span>
<span class=mi>119</span> <span class=n>setupkvm</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=mi>120</span> <span class=p>{</span>
<span class=mi>121</span>   <span class=n>pde_t</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>;</span>
<span class=mi>122</span>   <span class=k>struct</span> <span class=n>kmap</span> <span class=o>*</span><span class=n>k</span><span class=p>;</span>
<span class=mi>123</span>
<span class=mi>124</span>   <span class=nf>if</span><span class=p>((</span><span class=n>pgdir</span> <span class=o>=</span> <span class=p>(</span><span class=n>pde_t</span><span class=o>*</span><span class=p>)</span><span class=n>kalloc</span><span class=p>())</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>125</span>     <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>126</span>   <span class=nf>memset</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>);</span>
<span class=mi>127</span>   <span class=nf>if</span> <span class=p>(</span><span class=n>P2V</span><span class=p>(</span><span class=n>PHYSTOP</span><span class=p>)</span> <span class=o>&gt;</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>DEVSPACE</span><span class=p>)</span>
<span class=mi>128</span>     <span class=n>panic</span><span class=p>(</span><span class=s>&#34;PHYSTOP too high&#34;</span><span class=p>);</span>
<span class=mi>129</span>   <span class=k>for</span><span class=p>(</span><span class=n>k</span> <span class=o>=</span> <span class=n>kmap</span><span class=p>;</span> <span class=n>k</span> <span class=o>&lt;</span> <span class=o>&amp;</span><span class=n>kmap</span><span class=p>[</span><span class=n>NELEM</span><span class=p>(</span><span class=n>kmap</span><span class=p>)];</span> <span class=n>k</span><span class=o>++</span><span class=p>)</span>
<span class=mi>130</span>     <span class=k>if</span><span class=p>(</span><span class=n>mappages</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>k</span><span class=o>-&gt;</span><span class=n>virt</span><span class=p>,</span> <span class=n>k</span><span class=o>-&gt;</span><span class=n>phys_end</span> <span class=o>-</span> <span class=n>k</span><span class=o>-&gt;</span><span class=n>phys_start</span><span class=p>,</span>
<span class=mi>131</span>                 <span class=p>(</span><span class=n>uint</span><span class=p>)</span><span class=n>k</span><span class=o>-&gt;</span><span class=n>phys_start</span><span class=p>,</span> <span class=n>k</span><span class=o>-&gt;</span><span class=n>perm</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
<span class=mi>132</span>       <span class=n>freevm</span><span class=p>(</span><span class=n>pgdir</span><span class=p>);</span>
<span class=mi>133</span>       <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>134</span>     <span class=p>}</span>
<span class=mi>135</span>   <span class=k>return</span> <span class=n>pgdir</span><span class=p>;</span>
<span class=mi>136</span> <span class=p>}</span>
</code></pre></div></li><li><p>L105 - 115: <code>kmap[]</code>はカーネル用のページングの設定</p><ul><li>メモリレイアウトの図(Fig2.2)と照らし合わせるとわかりやすい</li></ul></li><li><p>L124 - 126: <code>pgdir</code>の領域を確保</p><ul><li>4096/32 = 128 pte<ul><li>4エントリしか使用しない(<code>kmap[]</code>より)</li></ul></li><li><code>kalloc()</code>: カーネルは未使用のページのリスト(<code>freelist</code>)で管理している<ul><li><p>詳細は次章</p></li><li><p><code>kalloc.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>79</span> <span class=c1>// Allocate one 4096-byte page of physical memory.
</span><span class=c1></span><span class=mi>80</span> <span class=c1>// Returns a pointer that the kernel can use.
</span><span class=c1></span><span class=mi>81</span> <span class=c1>// Returns 0 if the memory cannot be allocated.
</span><span class=c1></span><span class=mi>82</span> <span class=kt>char</span><span class=o>*</span>
<span class=mi>83</span> <span class=n>kalloc</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=mi>84</span> <span class=p>{</span>
<span class=mi>85</span>   <span class=k>struct</span> <span class=n>run</span> <span class=o>*</span><span class=n>r</span><span class=p>;</span>
<span class=mi>86</span>
<span class=mi>87</span>   <span class=nf>if</span><span class=p>(</span><span class=n>kmem</span><span class=p>.</span><span class=n>use_lock</span><span class=p>)</span>
<span class=mi>88</span>     <span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
<span class=mi>89</span>   <span class=n>r</span> <span class=o>=</span> <span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span><span class=p>;</span>
<span class=mi>90</span>   <span class=nf>if</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
<span class=mi>91</span>     <span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span> <span class=o>=</span> <span class=n>r</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
<span class=mi>92</span>   <span class=nf>if</span><span class=p>(</span><span class=n>kmem</span><span class=p>.</span><span class=n>use_lock</span><span class=p>)</span>
<span class=mi>93</span>     <span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
<span class=mi>94</span>   <span class=nf>return</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>r</span><span class=p>;</span>
<span class=mi>95</span> <span class=p>}</span>
</code></pre></div></li></ul><pre><code></code></pre></li></ul></li><li><p>L129 - 134: <code>pgdir</code>を<code>kmap[]</code>にあわせていく</p></li></ul><h3 id=mappages>mappages()</h3><p>仮想アドレスと物理アドレスを紐づける</p><ul><li><p><code>vm.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>57</span> <span class=c1>// Create PTEs for virtual addresses starting at va that refer to
</span><span class=c1></span><span class=mi>58</span> <span class=c1>// physical addresses starting at pa. va and size might not
</span><span class=c1></span><span class=mi>59</span> <span class=c1>// be page-aligned.
</span><span class=c1></span><span class=mi>60</span> <span class=k>static</span> <span class=kt>int</span>
<span class=mi>61</span> <span class=n>mappages</span><span class=p>(</span><span class=n>pde_t</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>va</span><span class=p>,</span> <span class=n>uint</span> <span class=n>size</span><span class=p>,</span> <span class=n>uint</span> <span class=n>pa</span><span class=p>,</span> <span class=kt>int</span> <span class=n>perm</span><span class=p>)</span>
<span class=mi>62</span> <span class=p>{</span>
<span class=mi>63</span>   <span class=kt>char</span> <span class=o>*</span><span class=n>a</span><span class=p>,</span> <span class=o>*</span><span class=n>last</span><span class=p>;</span>
<span class=mi>64</span>   <span class=n>pte_t</span> <span class=o>*</span><span class=n>pte</span><span class=p>;</span>
<span class=mi>65</span>
<span class=mi>66</span>   <span class=n>a</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>PGROUNDDOWN</span><span class=p>((</span><span class=n>uint</span><span class=p>)</span><span class=n>va</span><span class=p>);</span>
<span class=mi>67</span>   <span class=n>last</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>PGROUNDDOWN</span><span class=p>(((</span><span class=n>uint</span><span class=p>)</span><span class=n>va</span><span class=p>)</span> <span class=o>+</span> <span class=n>size</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
<span class=mi>68</span>   <span class=k>for</span><span class=p>(;;){</span>
<span class=mi>69</span>     <span class=k>if</span><span class=p>((</span><span class=n>pte</span> <span class=o>=</span> <span class=n>walkpgdir</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=mi>1</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>70</span>       <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
<span class=mi>71</span>     <span class=nf>if</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span> <span class=o>&amp;</span> <span class=n>PTE_P</span><span class=p>)</span>
<span class=mi>72</span>       <span class=n>panic</span><span class=p>(</span><span class=s>&#34;remap&#34;</span><span class=p>);</span>
<span class=mi>73</span>     <span class=o>*</span><span class=n>pte</span> <span class=o>=</span> <span class=n>pa</span> <span class=o>|</span> <span class=n>perm</span> <span class=o>|</span> <span class=n>PTE_P</span><span class=p>;</span>
<span class=mi>74</span>     <span class=nf>if</span><span class=p>(</span><span class=n>a</span> <span class=o>==</span> <span class=n>last</span><span class=p>)</span>
<span class=mi>75</span>       <span class=k>break</span><span class=p>;</span>
<span class=mi>76</span>     <span class=n>a</span> <span class=o>+=</span> <span class=n>PGSIZE</span><span class=p>;</span>
<span class=mi>77</span>     <span class=n>pa</span> <span class=o>+=</span> <span class=n>PGSIZE</span><span class=p>;</span>
<span class=mi>78</span>   <span class=p>}</span>
<span class=mi>79</span>   <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>80</span> <span class=p>}</span>
</code></pre></div></li><li><p>引数</p><ul><li><code>pgdir</code>: ページディレクトリテーブルの先頭アドレス</li><li><code>va</code>: 仮想アドレス</li><li><code>size</code>: マッピングするサイズ</li><li><code>pa</code>: 物理アドレス</li><li><code>perm</code>: permission</li></ul></li><li><p>L66 - 67: PGSIZEにそろえる</p><ul><li>ex) <code>PGROUNDDOWN(8193)</code> => 8192(PGSIZE * 2)</li></ul></li><li><p>L69: <code>va</code>に対応するページエントリを見つける</p></li><li><p>L73: ページテーブルエントリを更新(<code>pa</code> + <code>perm</code>)</p><ul><li><p><code>|</code>で下位12bitの<code>pa</code>を上書き(4*3=12byte)</p></li><li><p><code>mmu.h</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>93</span> <span class=c1>// Page table/directory entry flags.
</span><span class=c1></span><span class=mi>94</span> <span class=err>#</span><span class=n>define</span> <span class=n>PTE_P</span>           <span class=mh>0x001</span>   <span class=c1>// Present
</span><span class=c1></span><span class=mi>95</span> <span class=err>#</span><span class=n>define</span> <span class=n>PTE_W</span>           <span class=mh>0x002</span>   <span class=c1>// Writeable
</span><span class=c1></span><span class=mi>96</span> <span class=err>#</span><span class=n>define</span> <span class=n>PTE_U</span>           <span class=mh>0x004</span>   <span class=c1>// User
</span><span class=c1></span><span class=mi>97</span> <span class=err>#</span><span class=n>define</span> <span class=n>PTE_PS</span>          <span class=mh>0x080</span>   <span class=c1>// Page Size
</span></code></pre></div></li></ul></li><li><p>L76 - 77: <code>PGSIZE</code>を増やして繰り返す</p></li></ul><h3 id=walkpgdir>walkpgdir()</h3><p><code>pgdir</code>の<code>va</code>に対応するPTEを見つける</p><ul><li><p><code>vm.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>32</span> <span class=c1>// Return the address of the PTE in page table pgdir
</span><span class=c1></span><span class=mi>33</span> <span class=c1>// that corresponds to virtual address va.  If alloc!=0,
</span><span class=c1></span><span class=mi>34</span> <span class=c1>// create any required page table pages.
</span><span class=c1></span><span class=mi>35</span> <span class=k>static</span> <span class=n>pte_t</span> <span class=o>*</span>
<span class=mi>36</span> <span class=n>walkpgdir</span><span class=p>(</span><span class=n>pde_t</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>va</span><span class=p>,</span> <span class=kt>int</span> <span class=n>alloc</span><span class=p>)</span>
<span class=mi>37</span> <span class=p>{</span>
<span class=mi>38</span>   <span class=n>pde_t</span> <span class=o>*</span><span class=n>pde</span><span class=p>;</span>
<span class=mi>39</span>   <span class=n>pte_t</span> <span class=o>*</span><span class=n>pgtab</span><span class=p>;</span>
<span class=mi>40</span>
<span class=mi>41</span>   <span class=n>pde</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>pgdir</span><span class=p>[</span><span class=n>PDX</span><span class=p>(</span><span class=n>va</span><span class=p>)];</span>
<span class=mi>42</span>   <span class=nf>if</span><span class=p>(</span><span class=o>*</span><span class=n>pde</span> <span class=o>&amp;</span> <span class=n>PTE_P</span><span class=p>){</span>
<span class=mi>43</span>     <span class=n>pgtab</span> <span class=o>=</span> <span class=p>(</span><span class=n>pte_t</span><span class=o>*</span><span class=p>)</span><span class=n>P2V</span><span class=p>(</span><span class=n>PTE_ADDR</span><span class=p>(</span><span class=o>*</span><span class=n>pde</span><span class=p>));</span>
<span class=mi>44</span>   <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<span class=mi>45</span>     <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>alloc</span> <span class=o>||</span> <span class=p>(</span><span class=n>pgtab</span> <span class=o>=</span> <span class=p>(</span><span class=n>pte_t</span><span class=o>*</span><span class=p>)</span><span class=n>kalloc</span><span class=p>())</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>46</span>       <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>47</span>     <span class=c1>// Make sure all those PTE_P bits are zero.
</span><span class=c1></span><span class=mi>48</span>     <span class=n>memset</span><span class=p>(</span><span class=n>pgtab</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>);</span>
<span class=mi>49</span>     <span class=c1>// The permissions here are overly generous, but they can
</span><span class=c1></span><span class=mi>50</span>     <span class=c1>// be further restricted by the permissions in the page table
</span><span class=c1></span><span class=mi>51</span>     <span class=c1>// entries, if necessary.
</span><span class=c1></span><span class=mi>52</span>     <span class=o>*</span><span class=n>pde</span> <span class=o>=</span> <span class=n>V2P</span><span class=p>(</span><span class=n>pgtab</span><span class=p>)</span> <span class=o>|</span> <span class=n>PTE_P</span> <span class=o>|</span> <span class=n>PTE_W</span> <span class=o>|</span> <span class=n>PTE_U</span><span class=p>;</span>
<span class=mi>53</span>   <span class=p>}</span>
<span class=mi>54</span>   <span class=k>return</span> <span class=o>&amp;</span><span class=n>pgtab</span><span class=p>[</span><span class=n>PTX</span><span class=p>(</span><span class=n>va</span><span class=p>)];</span>
<span class=mi>55</span> <span class=p>}</span>
</code></pre></div></li><li><p>L41: PDEを取得</p><ul><li><p><code>mmu.h</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>65</span> <span class=c1>// A virtual address &#39;la&#39; has a three-part structure as follows:
</span><span class=c1></span><span class=mi>66</span> <span class=c1>//
</span><span class=c1></span><span class=mi>67</span> <span class=c1>// +--------10------+-------10-------+---------12----------+
</span><span class=c1></span><span class=mi>68</span> <span class=c1>// | Page Directory |   Page Table   | Offset within Page  |
</span><span class=c1></span><span class=mi>69</span> <span class=c1>// |      Index     |      Index     |                     |
</span><span class=c1></span><span class=mi>70</span> <span class=c1>// +----------------+----------------+---------------------+
</span><span class=c1></span><span class=mi>71</span> <span class=c1>//  \--- PDX(va) --/ \--- PTX(va) --/
</span><span class=c1></span><span class=mi>72</span>
<span class=mi>73</span> <span class=c1>// page directory index
</span><span class=c1></span><span class=mi>74</span> <span class=err>#</span><span class=n>define</span> <span class=n>PDX</span><span class=p>(</span><span class=n>va</span><span class=p>)</span>         <span class=p>(((</span><span class=n>uint</span><span class=p>)(</span><span class=n>va</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=n>PDXSHIFT</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x3FF</span><span class=p>)</span>
<span class=mi>75</span>
<span class=mi>76</span> <span class=c1>// page table index
</span><span class=c1></span><span class=mi>77</span> <span class=err>#</span><span class=n>define</span> <span class=n>PTX</span><span class=p>(</span><span class=n>va</span><span class=p>)</span>         <span class=p>(((</span><span class=n>uint</span><span class=p>)(</span><span class=n>va</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=n>PTXSHIFT</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x3FF</span><span class=p>)</span>
<span class=o>~~~</span>
<span class=mi>87</span> <span class=err>#</span><span class=n>define</span> <span class=n>PTXSHIFT</span>        <span class=mi>12</span>      <span class=c1>// offset of PTX in a linear address
</span><span class=c1></span><span class=mi>88</span> <span class=err>#</span><span class=n>define</span> <span class=n>PDXSHIFT</span>        <span class=mi>22</span>      <span class=c1>// offset of PDX in a linear address
</span></code></pre></div></li><li><p>L67 - 71: 仮想アドレスの構成</p><ul><li>前半10bitがPDEのインデックス</li><li>次の10bitがPTEのインデックス</li></ul></li><li><p><code>pgdir[PDX(va)]</code>: 該当するPDEを見つける</p></li><li><p><code>pgtab[PTX(va)]</code>: 該当のPTEを見つける</p></li></ul></li><li><p>L42 - 43: PDEが存在した場合</p><ul><li><p><code>mmu.h</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c> <span class=mi>99</span> <span class=c1>// Address in page table or page directory entry
</span><span class=c1></span><span class=mi>100</span> <span class=err>#</span><span class=n>define</span> <span class=n>PTE_ADDR</span><span class=p>(</span><span class=n>pte</span><span class=p>)</span>   <span class=p>((</span><span class=n>uint</span><span class=p>)(</span><span class=n>pte</span><span class=p>)</span> <span class=o>&amp;</span> <span class=o>~</span><span class=mh>0xFFF</span><span class=p>)</span>
</code></pre></div></li><li><blockquote><p><a href=https://gyazo.com/1498fc91c4888457c8f88dca9f3c65d8><img src=https://gyazo.com/1498fc91c4888457c8f88dca9f3c65d8/thumb/1000 alt=Image></a>
Source: <a href=http://softwaretechnique.jp/OS_Development/kernel_development07.html>０から作るOS開発　ページングその１　ページとPTEとPDE</a></p></blockquote></li></ul></li><li><p>L44 - 53: 引数の<code>alloc</code>が真ならば新たにページテーブルを作成し<code>pde</code>を更新</p></li></ul><h3 id=まとめ>まとめ</h3><hr><p>コメントや間違いなどがある場合は<a href=https://twitter.com/utam0k>Twitter</a>に連絡してもらうか
<a href=https://github.com/utam0k/utam0k.github.io/issues/1>Issue</a>に書いていただくと助かります。</p></section><section><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"utam0k"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></article></div><div id=side class="pr-1 bg-white"><aside class=pr-3><div id=toc class="Box Box--blue mb-3"><b>詳解xv6 Page tables 1</b><nav id=TableOfContents><ul><li><ul><li></li></ul></li></ul><ul><li><ul><li><a href=#シーケンス図>シーケンス図</a></li><li><a href=#main>main()</a></li><li><a href=#kvmalloc>kvmalloc()</a></li><li><a href=#switchkvm>switchkvm()</a></li><li><a href=#v2p>V2P()</a></li><li><a href=#setupkvm>setupkvm()</a></li><li><a href=#mappages>mappages()</a></li><li><a href=#walkpgdir>walkpgdir()</a></li><li><a href=#まとめ>まとめ</a></li></ul></li></ul></nav></div><div><a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class=twitter-share-button data-show-count=false>Tweet</a><script async src=https://platform.twitter.com/widgets.js></script>
<iframe src="https://www.facebook.com/plugins/share_button.php?href=https%3A%2F%2Fdevelopers.facebook.com%2Fdocs%2Fplugins%2F&layout=button&size=small&mobile_iframe=true&width=61&height=20&appId" width=61 height=20 style=border:none;overflow:hidden scrolling=no frameborder=0 allowtransparency=true allow=encrypted-media></iframe>
<a href=http://b.hatena.ne.jp/entry/ class=hatena-bookmark-button data-hatena-bookmark-layout=basic-label-counter data-hatena-bookmark-lang=ja title=このエントリーをはてなブックマークに追加><img src=https://b.st-hatena.com/images/entry-button/button-only@2x.png alt=このエントリーをはてなブックマークに追加 width=20 height=20 style=border:none></a><script type=text/javascript src=https://b.st-hatena.com/js/bookmark_button.js async></script></div></aside></div><div id=footer class="pt-2 pb-3 bg-white text-center"></div></div><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script></body></html>