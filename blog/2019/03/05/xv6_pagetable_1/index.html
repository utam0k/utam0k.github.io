<!doctype html><html lang=ja itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>詳解xv6 Page tables 1 - うたもく</title><meta name=author content="Toru Komatsu"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"うたもく","url":"https:\/\/www.utam0k.jp\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/www.utam0k.jp\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/www.utam0k.jp\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/www.utam0k.jp\/blog\/2019\/03\/05\/xv6_pagetable_1\/","name":"詳解xv6 page tables 1"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Toru Komatsu"},"headline":"詳解xv6 Page tables 1","description":"","inLanguage":"ja","wordCount":2455,"datePublished":"2019-03-05T18:35:02","dateModified":"2019-03-05T18:35:02","image":"https:\/\/www.utam0k.jp\/img\/logo.jpg","keywords":["xv6, os"],"mainEntityOfPage":"https:\/\/www.utam0k.jp\/blog\/2019\/03\/05\/xv6_pagetable_1\/","publisher":{"@type":"Organization","name":"https:\/\/www.utam0k.jp\/","logo":{"@type":"ImageObject","url":"https:\/\/www.utam0k.jp\/img\/logo.jpg","height":60,"width":60}}}</script><meta property="og:title" content="詳解xv6 Page tables 1"><meta property="og:image" content="https://www.utam0k.jp/img/logo.jpg"><meta property="og:url" content="https://www.utam0k.jp/blog/2019/03/05/xv6_pagetable_1/"><meta property="og:type" content="website"><meta property="og:site_name" content="うたもく"><meta name=twitter:title content="詳解xv6 Page tables 1"><meta name=twitter:image content="https://www.utam0k.jp/img/logo.jpg"><meta name=twitter:card content="summary"><meta name=twitter:site content="@utam0k"><meta name=twitter:creator content="@utam0k"><link href=https://www.utam0k.jp/img/favicon.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.68.3"><link rel=alternate href=https://www.utam0k.jp/index.xml type=application/rss+xml title=うたもく><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://www.utam0k.jp/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://www.utam0k.jp/css/syntax.css><link rel=stylesheet href=https://www.utam0k.jp/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-119773781-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>メニューを切り替え</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://www.utam0k.jp/>うたもく</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Posts href=https://www.utam0k.jp/post/>Posts</a></li><li><a title=Tags href=https://www.utam0k.jp/tags>Tags</a></li><li><a title=About href=https://www.utam0k.jp/page/about/>About</a></li><li><a title=Atom href=https://www.utam0k.jp/index.xml>Atom</a></li><li><a href=https://www.utam0k.jp/en lang=en>en</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title=うたもく href=https://www.utam0k.jp/><img class=avatar-img src=https://www.utam0k.jp/img/logo.jpg alt=うたもく></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>詳解xv6 Page tables 1</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;March 5, 2019に投稿
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;5&nbsp;分間
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Toru Komatsu</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p><a href=https://www.utam0k.jp/blog/2019/03/05/xv6_index/>詳解xv6の目次</a><br><a href=https://www.utam0k.jp/blog/2019/04/25/xv6_pagetable_2/>次の記事</a></p><hr><h1 id=単語説明>単語説明</h1><ul><li>PA(Physical Address): 物理アドレス</li><li>VA(Virtual Address): 仮想アドレス</li></ul><h4 id=ページング関係>ページング関係</h4><ul><li><a href=http://softwaretechnique.jp/OS_Development/kernel_development07.html>ページングについて参考にしたサイト</a></li><li>PTE: ページテーブルエントリ<ul><li><p>xv6では1PTEで4KBのアドレス空間を表現する</p></li><li><blockquote><p><a href=https://gyazo.com/76f1ccd02fb190c6e714b3f2cca72e2e><img src=https://gyazo.com/76f1ccd02fb190c6e714b3f2cca72e2e/thumb/1000 alt=Image></a>
Source: <a href=http://softwaretechnique.jp/OS_Development/kernel_development07.html>０から作るOS開発　ページングその１　ページとPTEとPDE</a></p></blockquote></li><li><p>4KB分のメモリの最初のアドレスを設定する</p></li><li><p>ページテーブルはPTEが1024個で構成されている</p><ul><li>1ページテーブルで4KB * 1024 = 4MBのアドレス空間を表現できる</li></ul></li></ul></li><li>PDE: ページディレクトリエントリ<ul><li><p>ページテーブルを指す</p></li><li><blockquote><p><a href=https://gyazo.com/1498fc91c4888457c8f88dca9f3c65d8><img src=https://gyazo.com/1498fc91c4888457c8f88dca9f3c65d8/thumb/1000 alt=Image></a>
Source: <a href=http://softwaretechnique.jp/OS_Development/kernel_development07.html>０から作るOS開発　ページングその１　ページとPTEとPDE</a></p></blockquote></li></ul></li><li>PDT: ページディレクトリテーブル<ul><li>ソースコード内では<code>pgdir</code>で表される</li><li>PDEを1024個で構成されるテーブル</li><li>1PDTで4MB * 1024 = 4GBのアドレス空間を表現できる</li></ul></li></ul><pre><code>Page Directory Table         4MB*1024=4GB
+-------------------------------------------------------------------+
| +---------+           +---------+                    +---------+  |
| | PDE[0]  |           | PDE[1]  |         ...        |PDE[1023]|  |
| +----+----+           +----+----+                    +----+----+  |
|      |                     |                              |       |
+-------------------------------------------------------------------+
       |                     |                              |
       v                     v                              v
+--------------+      +--------------+               +--------------+  +--+
| +----------+ |      | +----------+ |               | +----------+ |     |
| |  PTE[0]  | |      | |  PTE[0]  | |               | |  PTE[0]  | |     |
| +----------+ |      | +----------+ |               | +----------+ |     |
| +----------+ |      | +----------+ |               | +----------+ |     |
| |  PTE[1]  | |      | |  PTE[1]  | |      ...      | |  PTE[1]  | |     |
| +----------+ |      | +----------+ |               | +----------+ |     | 4KB*1024=4MB
|       .      |      |       .      |               |       .      |     |
|       .      |      |       .      |               |       .      |     |
|       .      |      |       .      |               |       .      |     |
| +----------+ |      | +----------+ |               | +----------+ |     |
| | PTE[1023]| |      | | PTE[1023]| |               | | PTE[1023]| |     |
| +----------+ |      | +----------+ |               | +----------+ |     |
+--------------+      +--------------+               +--------------+  +--+
   Page Table            Page Table                     Page Table
</code></pre><h1 id=code-creating-an-address-space>Code: creating an address space</h1><p>本章ではxv6が作るカーネルのアドレス空間、つまりページングの設定を行うコードの解説です。
カーネルのアドレス空間のVAとPAは図のようにマッピングしていきます。<br><strong>本章の解説するコードの目的は図のマッピングを作ることです。</strong></p><blockquote></blockquote><p>Source: <a href=https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf>commentary/textbook</a></p><p>どのプロセスにもカーネル用の仮想アドレス空間が設定されています。
図のように1プロセスには4GBの仮想メモリ空間が割り当てられますが、
KERNBASE~4GBまではカーネル用の仮想アドレス空間になっています。
カーネル用のアドレス空間はVAとPAが必ず図のように固定でマッピングされます。</p><h3 id=シーケンス図>シーケンス図</h3><p>エラー処理等を省いたざっくりとしたシーケンスです。
今見ている関数はどこから呼ばれるんだっけとなったときに見てもらえればと思います。</p><h3 id=main>main()</h3><p>メイン関数</p><ul><li><p><code>main.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>14</span> <span class=c1>// Bootstrap processor starts running C code here.
</span><span class=c1></span><span class=mi>15</span> <span class=c1>// Allocate a real stack and switch to it, first
</span><span class=c1></span><span class=mi>16</span> <span class=c1>// doing some setup required for memory allocator to work.
</span><span class=c1></span><span class=mi>17</span> <span class=kt>int</span>
<span class=mi>18</span> <span class=n>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=mi>19</span> <span class=p>{</span>
<span class=mi>20</span>   <span class=n>kinit1</span><span class=p>(</span><span class=n>end</span><span class=p>,</span> <span class=n>P2V</span><span class=p>(</span><span class=mi>4</span><span class=o>*</span><span class=mi>1024</span><span class=o>*</span><span class=mi>1024</span><span class=p>));</span> <span class=c1>// phys page allocator
</span><span class=c1></span><span class=mi>21</span>   <span class=nf>kvmalloc</span><span class=p>();</span>      <span class=c1>// kernel page table
</span><span class=c1></span><span class=o>~~~</span>
<span class=mi>37</span>   <span class=n>mpmain</span><span class=p>();</span>        <span class=c1>// finish this processor&#39;s setup
</span><span class=c1></span><span class=mi>38</span> <span class=p>}</span>
</code></pre></div></li><li><p>L21: カーネル用ページテーブルの作成</p></li></ul><h3 id=kvmalloc>kvmalloc()</h3><p>カーネル用のページテーブルを作成して作成したページテーブルに切り替える</p><ul><li><p>作成するのはページディレクトリエントリを1つのみ</p></li><li><p><a href=#setupkvm>setupkvm()</a>はPDEを返すがそれを先頭アドレスとしたPDTとも見れる</p></li><li><p><code>vm.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>138</span> <span class=c1>// Allocate one page table for the machine for the kernel address
</span><span class=c1></span><span class=mi>139</span> <span class=c1>// space for scheduler processes.
</span><span class=c1></span><span class=mi>140</span> <span class=kt>void</span>
<span class=mi>141</span> <span class=n>kvmalloc</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=mi>142</span> <span class=p>{</span>
<span class=mi>143</span>   <span class=n>kpgdir</span> <span class=o>=</span> <span class=n>setupkvm</span><span class=p>();</span>
<span class=mi>144</span>   <span class=nf>switchkvm</span><span class=p>();</span>
<span class=mi>145</span> <span class=p>}</span>
</code></pre></div></li></ul><h3 id=switchkvm>switchkvm()</h3><p>カーネル用のページテーブルに切り替え</p><ul><li><p><code>vm.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>147</span> <span class=c1>// Switch h/w page table register to the kernel-only page table,
</span><span class=c1></span><span class=mi>148</span> <span class=c1>// for when no process is running.
</span><span class=c1></span><span class=mi>149</span> <span class=kt>void</span>
<span class=mi>150</span> <span class=n>switchkvm</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=mi>151</span> <span class=p>{</span>
<span class=mi>152</span>   <span class=n>lcr3</span><span class=p>(</span><span class=n>V2P</span><span class=p>(</span><span class=n>kpgdir</span><span class=p>));</span>   <span class=c1>// switch to the kernel page table
</span><span class=c1></span><span class=mi>153</span> <span class=p>}</span>
</code></pre></div></li><li><p>L152: <code>cr3</code>レジスタを更新</p><ul><li>PDTの変更、つまりメモリ空間を変える</li><li><code>cr3</code> を別のページディレクトリに切り替える = プロセス空間の切り替えに相当<ul><li><code>cr3</code>が<code>pde[0]</code>を指せばおっけ</li></ul></li></ul></li></ul><h3 id=v2p>V2P()</h3><ul><li><p><code>memlayout.h</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c> <span class=mi>8</span> <span class=err>#</span><span class=n>define</span> <span class=n>KERNBASE</span> <span class=mh>0x80000000</span>         <span class=c1>// First kernel virtual address
</span><span class=c1></span><span class=o>~~~</span>
<span class=mi>11</span> <span class=err>#</span><span class=n>define</span> <span class=n>V2P</span><span class=p>(</span><span class=n>a</span><span class=p>)</span> <span class=p>(((</span><span class=n>uint</span><span class=p>)</span> <span class=p>(</span><span class=n>a</span><span class=p>))</span> <span class=o>-</span> <span class=n>KERNBASE</span><span class=p>)</span>
</code></pre></div></li><li><p>L11: カーネルの物理メモリは決め打ちでわかる</p></li><li><blockquote></blockquote></li></ul><p>Source: <a href=https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf>commentary/textbook</a> + 赤色書き加え</p><h3 id=setupkvm>setupkvm()</h3><p>カーネルのPDEを作成</p><ul><li><p><code>vm.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>103</span> <span class=c1>// This table defines the kernel&#39;s mappings, which are present in
</span><span class=c1></span><span class=mi>104</span> <span class=c1>// every process&#39;s page table.
</span><span class=c1></span><span class=mi>105</span> <span class=k>static</span> <span class=k>struct</span> <span class=n>kmap</span> <span class=p>{</span>
<span class=mi>106</span>   <span class=kt>void</span> <span class=o>*</span><span class=n>virt</span><span class=p>;</span>
<span class=mi>107</span>   <span class=n>uint</span> <span class=n>phys_start</span><span class=p>;</span>
<span class=mi>108</span>   <span class=n>uint</span> <span class=n>phys_end</span><span class=p>;</span>
<span class=mi>109</span>   <span class=kt>int</span> <span class=n>perm</span><span class=p>;</span>
<span class=mi>110</span> <span class=p>}</span> <span class=n>kmap</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
<span class=mi>111</span>  <span class=p>{</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>KERNBASE</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span>             <span class=n>EXTMEM</span><span class=p>,</span>    <span class=n>PTE_W</span><span class=p>},</span> <span class=c1>// I/O space
</span><span class=c1></span><span class=mi>112</span>  <span class=p>{</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>KERNLINK</span><span class=p>,</span> <span class=n>V2P</span><span class=p>(</span><span class=n>KERNLINK</span><span class=p>),</span> <span class=n>V2P</span><span class=p>(</span><span class=n>data</span><span class=p>),</span> <span class=mi>0</span><span class=p>},</span>     <span class=c1>// kern text+rodata
</span><span class=c1></span><span class=mi>113</span>  <span class=p>{</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>data</span><span class=p>,</span>     <span class=n>V2P</span><span class=p>(</span><span class=n>data</span><span class=p>),</span>     <span class=n>PHYSTOP</span><span class=p>,</span>   <span class=n>PTE_W</span><span class=p>},</span> <span class=c1>// kern data+memory
</span><span class=c1></span><span class=mi>114</span>  <span class=p>{</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>DEVSPACE</span><span class=p>,</span> <span class=n>DEVSPACE</span><span class=p>,</span>      <span class=mi>0</span><span class=p>,</span>         <span class=n>PTE_W</span><span class=p>},</span> <span class=c1>// more devices
</span><span class=c1></span><span class=mi>115</span> <span class=p>};</span>
<span class=mi>116</span>
<span class=mi>117</span> <span class=c1>// Set up kernel part of a page table.
</span><span class=c1></span><span class=mi>118</span> <span class=n>pde_t</span><span class=o>*</span>
<span class=mi>119</span> <span class=n>setupkvm</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=mi>120</span> <span class=p>{</span>
<span class=mi>121</span>   <span class=n>pde_t</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>;</span>
<span class=mi>122</span>   <span class=k>struct</span> <span class=n>kmap</span> <span class=o>*</span><span class=n>k</span><span class=p>;</span>
<span class=mi>123</span>
<span class=mi>124</span>   <span class=nf>if</span><span class=p>((</span><span class=n>pgdir</span> <span class=o>=</span> <span class=p>(</span><span class=n>pde_t</span><span class=o>*</span><span class=p>)</span><span class=n>kalloc</span><span class=p>())</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>125</span>     <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>126</span>   <span class=nf>memset</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>);</span>
<span class=mi>127</span>   <span class=nf>if</span> <span class=p>(</span><span class=n>P2V</span><span class=p>(</span><span class=n>PHYSTOP</span><span class=p>)</span> <span class=o>&gt;</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>DEVSPACE</span><span class=p>)</span>
<span class=mi>128</span>     <span class=n>panic</span><span class=p>(</span><span class=s>&#34;PHYSTOP too high&#34;</span><span class=p>);</span>
<span class=mi>129</span>   <span class=k>for</span><span class=p>(</span><span class=n>k</span> <span class=o>=</span> <span class=n>kmap</span><span class=p>;</span> <span class=n>k</span> <span class=o>&lt;</span> <span class=o>&amp;</span><span class=n>kmap</span><span class=p>[</span><span class=n>NELEM</span><span class=p>(</span><span class=n>kmap</span><span class=p>)];</span> <span class=n>k</span><span class=o>++</span><span class=p>)</span>
<span class=mi>130</span>     <span class=k>if</span><span class=p>(</span><span class=n>mappages</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>k</span><span class=o>-&gt;</span><span class=n>virt</span><span class=p>,</span> <span class=n>k</span><span class=o>-&gt;</span><span class=n>phys_end</span> <span class=o>-</span> <span class=n>k</span><span class=o>-&gt;</span><span class=n>phys_start</span><span class=p>,</span>
<span class=mi>131</span>                 <span class=p>(</span><span class=n>uint</span><span class=p>)</span><span class=n>k</span><span class=o>-&gt;</span><span class=n>phys_start</span><span class=p>,</span> <span class=n>k</span><span class=o>-&gt;</span><span class=n>perm</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
<span class=mi>132</span>       <span class=n>freevm</span><span class=p>(</span><span class=n>pgdir</span><span class=p>);</span>
<span class=mi>133</span>       <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>134</span>     <span class=p>}</span>
<span class=mi>135</span>   <span class=k>return</span> <span class=n>pgdir</span><span class=p>;</span>
<span class=mi>136</span> <span class=p>}</span>
</code></pre></div></li><li><p>L105 - 115: <code>kmap[]</code>はカーネル用のページングの設定</p><ul><li>メモリレイアウトの図(Fig2.2)と照らし合わせるとわかりやすい</li></ul></li><li><p>L124 - 126: <code>pgdir</code>の領域を確保</p><ul><li>4096/32 = 128 pte<ul><li>4エントリしか使用しない(<code>kmap[]</code>より)</li></ul></li><li><code>kalloc()</code>: カーネルは未使用のページのリスト(<code>freelist</code>)で管理している<ul><li><p>詳細は次章</p></li><li><p><code>kalloc.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>79</span> <span class=c1>// Allocate one 4096-byte page of physical memory.
</span><span class=c1></span><span class=mi>80</span> <span class=c1>// Returns a pointer that the kernel can use.
</span><span class=c1></span><span class=mi>81</span> <span class=c1>// Returns 0 if the memory cannot be allocated.
</span><span class=c1></span><span class=mi>82</span> <span class=kt>char</span><span class=o>*</span>
<span class=mi>83</span> <span class=n>kalloc</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=mi>84</span> <span class=p>{</span>
<span class=mi>85</span>   <span class=k>struct</span> <span class=n>run</span> <span class=o>*</span><span class=n>r</span><span class=p>;</span>
<span class=mi>86</span>
<span class=mi>87</span>   <span class=nf>if</span><span class=p>(</span><span class=n>kmem</span><span class=p>.</span><span class=n>use_lock</span><span class=p>)</span>
<span class=mi>88</span>     <span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
<span class=mi>89</span>   <span class=n>r</span> <span class=o>=</span> <span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span><span class=p>;</span>
<span class=mi>90</span>   <span class=nf>if</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
<span class=mi>91</span>     <span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span> <span class=o>=</span> <span class=n>r</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
<span class=mi>92</span>   <span class=nf>if</span><span class=p>(</span><span class=n>kmem</span><span class=p>.</span><span class=n>use_lock</span><span class=p>)</span>
<span class=mi>93</span>     <span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
<span class=mi>94</span>   <span class=nf>return</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>r</span><span class=p>;</span>
<span class=mi>95</span> <span class=p>}</span>
</code></pre></div></li></ul><pre><code></code></pre></li></ul></li><li><p>L129 - 134: <code>pgdir</code>を<code>kmap[]</code>にあわせていく</p></li></ul><h3 id=mappages>mappages()</h3><p>仮想アドレスと物理アドレスを紐づける</p><ul><li><p><code>vm.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>57</span> <span class=c1>// Create PTEs for virtual addresses starting at va that refer to
</span><span class=c1></span><span class=mi>58</span> <span class=c1>// physical addresses starting at pa. va and size might not
</span><span class=c1></span><span class=mi>59</span> <span class=c1>// be page-aligned.
</span><span class=c1></span><span class=mi>60</span> <span class=k>static</span> <span class=kt>int</span>
<span class=mi>61</span> <span class=n>mappages</span><span class=p>(</span><span class=n>pde_t</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>va</span><span class=p>,</span> <span class=n>uint</span> <span class=n>size</span><span class=p>,</span> <span class=n>uint</span> <span class=n>pa</span><span class=p>,</span> <span class=kt>int</span> <span class=n>perm</span><span class=p>)</span>
<span class=mi>62</span> <span class=p>{</span>
<span class=mi>63</span>   <span class=kt>char</span> <span class=o>*</span><span class=n>a</span><span class=p>,</span> <span class=o>*</span><span class=n>last</span><span class=p>;</span>
<span class=mi>64</span>   <span class=n>pte_t</span> <span class=o>*</span><span class=n>pte</span><span class=p>;</span>
<span class=mi>65</span>
<span class=mi>66</span>   <span class=n>a</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>PGROUNDDOWN</span><span class=p>((</span><span class=n>uint</span><span class=p>)</span><span class=n>va</span><span class=p>);</span>
<span class=mi>67</span>   <span class=n>last</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>PGROUNDDOWN</span><span class=p>(((</span><span class=n>uint</span><span class=p>)</span><span class=n>va</span><span class=p>)</span> <span class=o>+</span> <span class=n>size</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
<span class=mi>68</span>   <span class=k>for</span><span class=p>(;;){</span>
<span class=mi>69</span>     <span class=k>if</span><span class=p>((</span><span class=n>pte</span> <span class=o>=</span> <span class=n>walkpgdir</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=mi>1</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>70</span>       <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
<span class=mi>71</span>     <span class=nf>if</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span> <span class=o>&amp;</span> <span class=n>PTE_P</span><span class=p>)</span>
<span class=mi>72</span>       <span class=n>panic</span><span class=p>(</span><span class=s>&#34;remap&#34;</span><span class=p>);</span>
<span class=mi>73</span>     <span class=o>*</span><span class=n>pte</span> <span class=o>=</span> <span class=n>pa</span> <span class=o>|</span> <span class=n>perm</span> <span class=o>|</span> <span class=n>PTE_P</span><span class=p>;</span>
<span class=mi>74</span>     <span class=nf>if</span><span class=p>(</span><span class=n>a</span> <span class=o>==</span> <span class=n>last</span><span class=p>)</span>
<span class=mi>75</span>       <span class=k>break</span><span class=p>;</span>
<span class=mi>76</span>     <span class=n>a</span> <span class=o>+=</span> <span class=n>PGSIZE</span><span class=p>;</span>
<span class=mi>77</span>     <span class=n>pa</span> <span class=o>+=</span> <span class=n>PGSIZE</span><span class=p>;</span>
<span class=mi>78</span>   <span class=p>}</span>
<span class=mi>79</span>   <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>80</span> <span class=p>}</span>
</code></pre></div></li><li><p>引数</p><ul><li><code>pgdir</code>: ページディレクトリテーブルの先頭アドレス</li><li><code>va</code>: 仮想アドレス</li><li><code>size</code>: マッピングするサイズ</li><li><code>pa</code>: 物理アドレス</li><li><code>perm</code>: permission</li></ul></li><li><p>L66 - 67: PGSIZEにそろえる</p><ul><li>ex) <code>PGROUNDDOWN(8193)</code> => 8192(PGSIZE * 2)</li></ul></li><li><p>L69: <code>va</code>に対応するページエントリを見つける</p></li><li><p>L73: ページテーブルエントリを更新(<code>pa</code> + <code>perm</code>)</p><ul><li><p><code>|</code>で下位12bitの<code>pa</code>を上書き(4*3=12byte)</p></li><li><p><code>mmu.h</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>93</span> <span class=c1>// Page table/directory entry flags.
</span><span class=c1></span><span class=mi>94</span> <span class=err>#</span><span class=n>define</span> <span class=n>PTE_P</span>           <span class=mh>0x001</span>   <span class=c1>// Present
</span><span class=c1></span><span class=mi>95</span> <span class=err>#</span><span class=n>define</span> <span class=n>PTE_W</span>           <span class=mh>0x002</span>   <span class=c1>// Writeable
</span><span class=c1></span><span class=mi>96</span> <span class=err>#</span><span class=n>define</span> <span class=n>PTE_U</span>           <span class=mh>0x004</span>   <span class=c1>// User
</span><span class=c1></span><span class=mi>97</span> <span class=err>#</span><span class=n>define</span> <span class=n>PTE_PS</span>          <span class=mh>0x080</span>   <span class=c1>// Page Size
</span></code></pre></div></li></ul></li><li><p>L76 - 77: <code>PGSIZE</code>を増やして繰り返す</p></li></ul><h3 id=walkpgdir>walkpgdir()</h3><p><code>pgdir</code>の<code>va</code>に対応するPTEを見つける</p><ul><li><p><code>vm.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>32</span> <span class=c1>// Return the address of the PTE in page table pgdir
</span><span class=c1></span><span class=mi>33</span> <span class=c1>// that corresponds to virtual address va.  If alloc!=0,
</span><span class=c1></span><span class=mi>34</span> <span class=c1>// create any required page table pages.
</span><span class=c1></span><span class=mi>35</span> <span class=k>static</span> <span class=n>pte_t</span> <span class=o>*</span>
<span class=mi>36</span> <span class=n>walkpgdir</span><span class=p>(</span><span class=n>pde_t</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>va</span><span class=p>,</span> <span class=kt>int</span> <span class=n>alloc</span><span class=p>)</span>
<span class=mi>37</span> <span class=p>{</span>
<span class=mi>38</span>   <span class=n>pde_t</span> <span class=o>*</span><span class=n>pde</span><span class=p>;</span>
<span class=mi>39</span>   <span class=n>pte_t</span> <span class=o>*</span><span class=n>pgtab</span><span class=p>;</span>
<span class=mi>40</span>
<span class=mi>41</span>   <span class=n>pde</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>pgdir</span><span class=p>[</span><span class=n>PDX</span><span class=p>(</span><span class=n>va</span><span class=p>)];</span>
<span class=mi>42</span>   <span class=nf>if</span><span class=p>(</span><span class=o>*</span><span class=n>pde</span> <span class=o>&amp;</span> <span class=n>PTE_P</span><span class=p>){</span>
<span class=mi>43</span>     <span class=n>pgtab</span> <span class=o>=</span> <span class=p>(</span><span class=n>pte_t</span><span class=o>*</span><span class=p>)</span><span class=n>P2V</span><span class=p>(</span><span class=n>PTE_ADDR</span><span class=p>(</span><span class=o>*</span><span class=n>pde</span><span class=p>));</span>
<span class=mi>44</span>   <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<span class=mi>45</span>     <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>alloc</span> <span class=o>||</span> <span class=p>(</span><span class=n>pgtab</span> <span class=o>=</span> <span class=p>(</span><span class=n>pte_t</span><span class=o>*</span><span class=p>)</span><span class=n>kalloc</span><span class=p>())</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>46</span>       <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>47</span>     <span class=c1>// Make sure all those PTE_P bits are zero.
</span><span class=c1></span><span class=mi>48</span>     <span class=n>memset</span><span class=p>(</span><span class=n>pgtab</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>);</span>
<span class=mi>49</span>     <span class=c1>// The permissions here are overly generous, but they can
</span><span class=c1></span><span class=mi>50</span>     <span class=c1>// be further restricted by the permissions in the page table
</span><span class=c1></span><span class=mi>51</span>     <span class=c1>// entries, if necessary.
</span><span class=c1></span><span class=mi>52</span>     <span class=o>*</span><span class=n>pde</span> <span class=o>=</span> <span class=n>V2P</span><span class=p>(</span><span class=n>pgtab</span><span class=p>)</span> <span class=o>|</span> <span class=n>PTE_P</span> <span class=o>|</span> <span class=n>PTE_W</span> <span class=o>|</span> <span class=n>PTE_U</span><span class=p>;</span>
<span class=mi>53</span>   <span class=p>}</span>
<span class=mi>54</span>   <span class=k>return</span> <span class=o>&amp;</span><span class=n>pgtab</span><span class=p>[</span><span class=n>PTX</span><span class=p>(</span><span class=n>va</span><span class=p>)];</span>
<span class=mi>55</span> <span class=p>}</span>
</code></pre></div></li><li><p>L41: PDEを取得</p><ul><li><p><code>mmu.h</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>65</span> <span class=c1>// A virtual address &#39;la&#39; has a three-part structure as follows:
</span><span class=c1></span><span class=mi>66</span> <span class=c1>//
</span><span class=c1></span><span class=mi>67</span> <span class=c1>// +--------10------+-------10-------+---------12----------+
</span><span class=c1></span><span class=mi>68</span> <span class=c1>// | Page Directory |   Page Table   | Offset within Page  |
</span><span class=c1></span><span class=mi>69</span> <span class=c1>// |      Index     |      Index     |                     |
</span><span class=c1></span><span class=mi>70</span> <span class=c1>// +----------------+----------------+---------------------+
</span><span class=c1></span><span class=mi>71</span> <span class=c1>//  \--- PDX(va) --/ \--- PTX(va) --/
</span><span class=c1></span><span class=mi>72</span>
<span class=mi>73</span> <span class=c1>// page directory index
</span><span class=c1></span><span class=mi>74</span> <span class=err>#</span><span class=n>define</span> <span class=n>PDX</span><span class=p>(</span><span class=n>va</span><span class=p>)</span>         <span class=p>(((</span><span class=n>uint</span><span class=p>)(</span><span class=n>va</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=n>PDXSHIFT</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x3FF</span><span class=p>)</span>
<span class=mi>75</span>
<span class=mi>76</span> <span class=c1>// page table index
</span><span class=c1></span><span class=mi>77</span> <span class=err>#</span><span class=n>define</span> <span class=n>PTX</span><span class=p>(</span><span class=n>va</span><span class=p>)</span>         <span class=p>(((</span><span class=n>uint</span><span class=p>)(</span><span class=n>va</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=n>PTXSHIFT</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x3FF</span><span class=p>)</span>
<span class=o>~~~</span>
<span class=mi>87</span> <span class=err>#</span><span class=n>define</span> <span class=n>PTXSHIFT</span>        <span class=mi>12</span>      <span class=c1>// offset of PTX in a linear address
</span><span class=c1></span><span class=mi>88</span> <span class=err>#</span><span class=n>define</span> <span class=n>PDXSHIFT</span>        <span class=mi>22</span>      <span class=c1>// offset of PDX in a linear address
</span></code></pre></div></li><li><p>L67 - 71: 仮想アドレスの構成</p><ul><li>前半10bitがPDEのインデックス</li><li>次の10bitがPTEのインデックス</li></ul></li><li><p><code>pgdir[PDX(va)]</code>: 該当するPDEを見つける</p></li><li><p><code>pgtab[PTX(va)]</code>: 該当のPTEを見つける</p></li></ul></li><li><p>L42 - 43: PDEが存在した場合</p><ul><li><p><code>mmu.h</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c> <span class=mi>99</span> <span class=c1>// Address in page table or page directory entry
</span><span class=c1></span><span class=mi>100</span> <span class=err>#</span><span class=n>define</span> <span class=n>PTE_ADDR</span><span class=p>(</span><span class=n>pte</span><span class=p>)</span>   <span class=p>((</span><span class=n>uint</span><span class=p>)(</span><span class=n>pte</span><span class=p>)</span> <span class=o>&amp;</span> <span class=o>~</span><span class=mh>0xFFF</span><span class=p>)</span>
</code></pre></div></li><li><blockquote><p><a href=https://gyazo.com/1498fc91c4888457c8f88dca9f3c65d8><img src=https://gyazo.com/1498fc91c4888457c8f88dca9f3c65d8/thumb/1000 alt=Image></a>
Source: <a href=http://softwaretechnique.jp/OS_Development/kernel_development07.html>０から作るOS開発　ページングその１　ページとPTEとPDE</a></p></blockquote></li></ul></li><li><p>L44 - 53: 引数の<code>alloc</code>が真ならば新たにページテーブルを作成し<code>pde</code>を更新</p></li></ul><h3 id=まとめ>まとめ</h3><hr><p>コメントや間違いなどがある場合は<a href=https://twitter.com/utam0k>Twitter</a>に連絡してもらうか
<a href=https://github.com/utam0k/utam0k.github.io/issues/1>Issue</a>に書いていただくと助かります。</p><div class=blog-tags><a href=https://www.utam0k.jp//tags/xv6/>xv6</a>&nbsp;
<a href=https://www.utam0k.jp//tags/os/>os</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f03%2f05%2fxv6_pagetable_1%2f&text=%e8%a9%b3%e8%a7%a3xv6%20Page%20tables%201&via=utam0k" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f03%2f05%2fxv6_pagetable_1%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f03%2f05%2fxv6_pagetable_1%2f&title=%e8%a9%b3%e8%a7%a3xv6%20Page%20tables%201" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f03%2f05%2fxv6_pagetable_1%2f&title=%e8%a9%b3%e8%a7%a3xv6%20Page%20tables%201" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f03%2f05%2fxv6_pagetable_1%2f&title=%e8%a9%b3%e8%a7%a3xv6%20Page%20tables%201" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f03%2f05%2fxv6_pagetable_1%2f&description=%e8%a9%b3%e8%a7%a3xv6%20Page%20tables%201" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section></article><ul class="pager blog-pager"><li class=previous><a href=https://www.utam0k.jp/blog/2019/03/05/xv6_intro/ data-toggle=tooltip data-placement=top title="詳解xv6 はじめに">&larr; 前ページ</a></li><li class=next><a href=https://www.utam0k.jp/blog/2019/04/25/xv6_pagetable_2/ data-toggle=tooltip data-placement=top title="詳解xv6 Page tables 2">次ページ &rarr;</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:k0ma@utam0k.jp title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/utam0k title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/utam0k title=Twitter><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">Toru Komatsu
&nbsp;&bull;&nbsp;&copy;
2020
&nbsp;&bull;&nbsp;
<a href=https://www.utam0k.jp/>うたもく</a></p><p class="credits theme-by text-muted">起動力に<a href=https://gohugo.io>Hugo v0.68.3</a> &nbsp;&bull;&nbsp; テーマに<a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a>に基づいている<a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://www.utam0k.jp/js/main.js></script><script>renderMathInElement(document.body);</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://www.utam0k.jp/js/load-photoswipe.js></script></body></html>