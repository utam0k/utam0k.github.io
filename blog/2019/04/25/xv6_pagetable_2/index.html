<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>詳解xv6 Page tables 2 | うたもく</title><meta name=description content><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:site_name" content="うたもく"><meta property="og:url" content="https://www.utam0k.jp/blog/2019/04/25/xv6_pagetable_2/"><meta property="og:title" content="詳解xv6 Page tables 2"><meta property="og:image" content="https://www.utam0k.jp/img/og/post-xv6_pagetable_2-index-ja.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.utam0k.jp/img/og/post-xv6_pagetable_2-index-ja.png"><link rel=alternate type=application/rss+xml href=https://www.utam0k.jp/index.xml><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/hack-font/3.3.0/web/hack.min.css crossorigin=anonymous><link rel=stylesheet href=https://www.utam0k.jp/css/main.min.862e9d09f4d2a40c6c40b7190a65e9517797caeb85326d81f46cc98d4fbd23c8.css integrity="sha256-hi6dCfTSpAxsQLcZCmXpUXeXyuuFMm2B9GzJjU+9I8g="><script>(()=>{const e=window.matchMedia("(prefers-color-scheme: dark)"),n=e=>{const s=document.querySelectorAll(".theme-option");s.forEach(t=>{const n=t.dataset.mode===e;t.setAttribute("aria-pressed",n?"true":"false")});const t=document.querySelector(".theme-toggle");t&&t.setAttribute("aria-pressed",e==="dark"?"true":"false");const o=document.querySelectorAll(".theme-choice");o.forEach(t=>t.setAttribute("aria-checked",t.dataset.mode===e?"true":"false"));const n=document.querySelector("[data-theme-icon]");if(n){const t=e==="system"?document.documentElement.dataset.theme||"light":e;n.dataset.state=t}},s=t=>t==="system"?e.matches?"dark":"light":t,t=e=>{const t=s(e);document.documentElement.dataset.theme=t,document.body&&(document.body.dataset.theme=t,document.body.classList.toggle("theme-dark",t==="dark"),document.body.classList.toggle("theme-light",t==="light")),n(e)},o=()=>{const e=localStorage.getItem("color-scheme"),n=e||"system";t(n)};e.addEventListener("change",e=>{const n=localStorage.getItem("color-scheme");(!n||n==="system")&&t("system")}),window.__setTheme=e=>{const n=e||(document.documentElement.dataset.theme==="dark"?"light":"dark");localStorage.setItem("color-scheme",n),t(n)},window.__toggleTheme=()=>window.__setTheme(),window.__toggleThemeMenu=e=>{const t=e?.nextElementSibling;if(!t)return;const n=!t.hidden;document.querySelectorAll(".theme-popover").forEach(e=>e.hidden=!0),document.querySelectorAll(".theme-trigger").forEach(e=>e.setAttribute("aria-expanded","false")),n||(t.hidden=!1,e.setAttribute("aria-expanded","true"))},document.addEventListener("click",e=>{const t=document.querySelector(".theme-popover");if(!t)return;if(e.target.closest(".theme-menu"))return;t.hidden=!0;const n=document.querySelector(".theme-trigger");n?.setAttribute("aria-expanded","false")}),window.__toggleLangMenu=e=>{const t=e?.nextElementSibling;if(!t)return;const n=!t.hidden;document.querySelectorAll(".lang-popover").forEach(e=>e.hidden=!0),document.querySelectorAll(".lang-trigger").forEach(e=>e.setAttribute("aria-expanded","false")),n||(t.hidden=!1,e.setAttribute("aria-expanded","true"))},window.__switchLang=(e)=>{if(!e)return;window.location.href=e},document.addEventListener("click",e=>{const t=document.querySelector(".lang-popover");if(!t)return;if(e.target.closest(".lang-menu"))return;t.hidden=!0;const n=document.querySelector(".lang-trigger");n?.setAttribute("aria-expanded","false")}),o(),document.addEventListener("DOMContentLoaded",()=>{const t=document.documentElement.dataset.theme||(e.matches?"dark":"light");n(t)})})()</script><meta name=generator content="Hugo 0.152.2"><script async src="https://www.googletagmanager.com/gtag/js?id=G-F75YLEHSJN"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F75YLEHSJN")</script></head><body class=page data-has-toc=true><div class=page-shell><header class=site-header><a class=brand href=https://www.utam0k.jp/><span class=brand-mark aria-hidden=true style=background-image:url(https://www.utam0k.jp/img/logo.png)></span><div class=brand-text><span class=brand-name>Toru Komatsu</span>
<span class=brand-tagline>@utam0k</span></div></a><div class=header-actions><nav class=main-nav aria-label=Primary><a class="nav-item is-active" href=https://www.utam0k.jp/blog/>Blog</a>
<a class=nav-item href=https://www.utam0k.jp/tmp/>/tmp</a>
<a class=nav-item href=https://www.utam0k.jp/slides/>Slides</a>
<a class=nav-item href=https://www.utam0k.jp/page/about/>About</a></nav><span class=header-divider aria-hidden=true></span><div class=header-social><a class=social-btn href=https://github.com/utam0k target=_blank rel="noopener noreferrer" aria-label=GitHub><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .5A12 12 0 008.21 23.9c.6.1.82-.26.82-.58.0-.29-.01-1.05-.02-2.06-3.34.73-4.04-1.61-4.04-1.61-.54-1.37-1.32-1.73-1.32-1.73-1.08-.74.08-.73.08-.73 1.19.08 1.81 1.22 1.81 1.22 1.06 1.8 2.79 1.28 3.47.98.1-.77.42-1.28.76-1.58-2.66-.3-5.47-1.34-5.47-5.95.0-1.32.47-2.4 1.24-3.25-.13-.3-.54-1.52.12-3.16.0.0 1.01-.32 3.3 1.24a11.5 11.5.0 016 0c2.28-1.56 3.29-1.24 3.29-1.24.66 1.64.25 2.86.12 3.16.77.85 1.23 1.93 1.23 3.25.0 4.62-2.81 5.64-5.49 5.94.43.37.81 1.11.81 2.24.0 1.62-.02 2.93-.02 3.33.0.32.21.7.83.58A12 12 0 0012 .5z"/></svg>
</a><a class=social-btn href=https://x.com/utam0k target=_blank rel="noopener noreferrer" aria-label="X (Twitter)"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h5.3l3.4 4.8L14.8 3H21l-6.8 9.2L21 21h-5.3L12 15.8 8.2 21H3l6.8-8.9L3 3z"/></svg></a></div><span class=header-divider aria-hidden=true></span><div class=lang-menu><button class=lang-trigger type=button aria-haspopup=true aria-expanded=false onclick=window.__toggleLangMenu&&window.__toggleLangMenu(this)>
<span class=lang-trigger__label>JA</span></button><div class=lang-popover hidden role=menu><button class=lang-choice type=button data-lang=JA aria-checked=true role=menuitemradio onclick='window.__switchLang&&window.__switchLang("/","JA")'>日本語</button>
<button class=lang-choice type=button data-lang=EN aria-checked=false role=menuitemradio onclick='window.__switchLang&&window.__switchLang("/en/blog/2019/04/25/xv6_pagetable_2/","EN")'>English</button></div></div><div class=theme-menu><button class=theme-trigger type=button aria-haspopup=true aria-expanded=false onclick=window.__toggleThemeMenu&&window.__toggleThemeMenu(this)>
<span class=theme-trigger__icon aria-hidden=true data-theme-icon data-state=system></span>
<span class=sr-only data-theme-label>Theme</span></button><div class=theme-popover hidden><button class=theme-choice type=button data-mode=system aria-checked=false role=menuitemradio onclick='window.__setTheme&&window.__setTheme("system")'>Auto (System)</button>
<button class=theme-choice type=button data-mode=light aria-checked=false role=menuitemradio onclick='window.__setTheme&&window.__setTheme("light")'>Light</button>
<button class=theme-choice type=button data-mode=dark aria-checked=false role=menuitemradio onclick='window.__setTheme&&window.__setTheme("dark")'>Dark</button></div></div><button class=menu-toggle type=button aria-expanded=false aria-controls=mobile-menu data-menu-toggle>
<span class=sr-only>Menu</span>
<span class=menu-toggle__icon aria-hidden=true><span></span></span></button></div><div class=mobile-menu id=mobile-menu hidden><div class=mobile-menu__header><span class=mobile-menu__title>Menu</span>
<button class=menu-close type=button aria-label="Close menu" data-menu-close>
<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button></div><nav class=mobile-menu__links aria-label="Primary mobile"><a class="mobile-menu__item is-active" href=https://www.utam0k.jp/blog/>Blog</a>
<a class=mobile-menu__item href=https://www.utam0k.jp/tmp/>/tmp</a>
<a class=mobile-menu__item href=https://www.utam0k.jp/slides/>Slides</a>
<a class=mobile-menu__item href=https://www.utam0k.jp/page/about/>About</a></nav><div class=mobile-menu__footer><div class=mobile-menu__langs><button class="lang-chip is-active" type=button onclick='window.__switchLang&&window.__switchLang("/","JA")'>JA</button>
<button class=lang-chip type=button onclick='window.__switchLang&&window.__switchLang("/en/blog/2019/04/25/xv6_pagetable_2/","EN")'>EN</button></div><div class=mobile-menu__icons><button class=social-btn type=button aria-label="Toggle theme" onclick=window.__toggleTheme&&window.__toggleTheme()>
<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="4" fill="currentColor"/><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
</button>
<a class=social-btn href=https://github.com/utam0k target=_blank rel="noopener noreferrer" aria-label=GitHub><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .5A12 12 0 008.21 23.9c.6.1.82-.26.82-.58.0-.29-.01-1.05-.02-2.06-3.34.73-4.04-1.61-4.04-1.61-.54-1.37-1.32-1.73-1.32-1.73-1.08-.74.08-.73.08-.73 1.19.08 1.81 1.22 1.81 1.22 1.06 1.8 2.79 1.28 3.47.98.1-.77.42-1.28.76-1.58-2.66-.3-5.47-1.34-5.47-5.95.0-1.32.47-2.4 1.24-3.25-.13-.3-.54-1.52.12-3.16.0.0 1.01-.32 3.3 1.24a11.5 11.5.0 016 0c2.28-1.56 3.29-1.24 3.29-1.24.66 1.64.25 2.86.12 3.16.77.85 1.23 1.93 1.23 3.25.0 4.62-2.81 5.64-5.49 5.94.43.37.81 1.11.81 2.24.0 1.62-.02 2.93-.02 3.33.0.32.21.7.83.58A12 12 0 0012 .5z"/></svg></a>
<a class=social-btn href=https://x.com/utam0k target=_blank rel="noopener noreferrer" aria-label="X (Twitter)"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h5.3l3.4 4.8L14.8 3H21l-6.8 9.2L21 21h-5.3L12 15.8 8.2 21H3l6.8-8.9L3 3z"/></svg></a></div></div></div><div class=mobile-menu__overlay data-menu-overlay hidden></div></header><main class=layout><div class=article-layout><article class=article><header class="article-hero article-hero--stack"><h1 class=article-title>詳解xv6 Page tables 2</h1><div class="share-block share-block--mobile"><div class=toc-share aria-label="Share this post"><button type=button class="share-btn share-btn--native" data-share-native data-share-url=https://www.utam0k.jp/blog/2019/04/25/xv6_pagetable_2/ data-share-title="詳解xv6 Page tables 2" aria-label=ネイティブ共有 hidden>
<svg viewBox="0 -960 960 960" aria-hidden="true"><path d="M680-80q-50 0-85-35t-35-85q0-6 3-28L282-392q-16 15-37 23.5t-45 8.5q-50 0-85-35t-35-85 35-85 85-35q24 0 45 8.5t37 23.5l281-164q-2-7-2.5-13.5T560-760q0-50 35-85t85-35 85 35 35 85-35 85-85 35q-24 0-45-8.5T598-672L317-508q2 7 2.5 13.5t.5 14.5-.5 14.5T317-452l281 164q16-15 37-23.5t45-8.5q50 0 85 35t35 85-35 85-85 35zm0-80q17 0 28.5-11.5T720-2e2t-11.5-28.5T680-240t-28.5 11.5T640-2e2t11.5 28.5T680-160zM2e2-440q17 0 28.5-11.5T240-480t-11.5-28.5T2e2-520t-28.5 11.5T160-480t11.5 28.5T2e2-440zm480-280q17 0 28.5-11.5T720-760t-11.5-28.5T680-8e2t-28.5 11.5T640-760t11.5 28.5T680-720zm0 520zM2e2-480zm480-280z"/></svg>
<span class=sr-only>共有</span>
</button>
<a class=share-btn href="https://twitter.com/intent/tweet?text=%e8%a9%b3%e8%a7%a3xv6%20Page%20tables%202&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f04%2f25%2fxv6_pagetable_2%2f" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h5.3l3.4 4.8L14.8 3H21l-6.8 9.2L21 21h-5.3L12 15.8 8.2 21H3l6.8-8.9L3 3z"/></svg>
<span class=sr-only>Share on X</span>
</a><a class=share-btn href="http://b.hatena.ne.jp/add?mode=confirm&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f04%2f25%2fxv6_pagetable_2%2f&title=%e8%a9%b3%e8%a7%a3xv6%20Page%20tables%202" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.47.0C22.42.0 24 1.58 24 3.53v16.94c0 1.95-1.58 3.53-3.53 3.53H3.53C1.58 24 0 22.42.0 20.47V3.53C0 1.58 1.58.0 3.53.0h16.94zM8.61 17.25c1.2.0 2.06-.04 2.58-.12.53-.08.98-.22 1.32-.41.45-.23.78-.56 1.02-.99.24-.43.36-.91.36-1.48.0-.78-.21-1.4-.63-1.87-.42-.48-.99-.74-1.74-.79.66-.18 1.16-.45 1.46-.81.32-.34.47-.82.47-1.42.0-.48-.1-.88-.3-1.26-.21-.36-.5-.65-.88-.87-.35-.2-.74-.32-1.22-.4-.46-.08-1.29-.12-2.48-.12H5.65v10.46H8.6zm.74-4.19c.7.0 1.18.09 1.44.27.27.18.4.5.4.93.0.4-.14.69-.42.86-.27.18-.76.25-1.44.25H8.31v-2.31h1.03zm8.66.71V6.71h-2.46v7.06h2.46zM8.93 9.08c.71.0 1.19.08 1.43.24.25.16.37.44.37.84.0.38-.13.65-.39.8-.27.16-.75.24-1.45.24h-.57V9.08h.61z"/></svg>
<span class=sr-only>はてなブックマーク</span>
</a><a class=share-btn href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f04%2f25%2fxv6_pagetable_2%2f&title=%e8%a9%b3%e8%a7%a3xv6%20Page%20tables%202" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.45 3.5H3.55A1.55 1.55.0 002 5.05v13.9A1.55 1.55.0 003.55 20.5h16.9A1.55 1.55.0 0022 18.95V5.05A1.55 1.55.0 0020.45 3.5zM7.14 18.1H4.54V9.88h2.6V18.1zm-1.3-9.36a1.51 1.51.0 110-3.02 1.51 1.51.0 010 3.02zM19 18.1h-2.6v-4.96c0-1.18-.42-1.99-1.48-1.99-.81.0-1.3.55-1.51 1.09-.08.19-.1.46-.1.73v5.13H10.7s.03-8.32.0-9.18h2.6v1.3c.35-.54.98-1.31 2.39-1.31 1.74.0 3.31 1.13 3.31 3.56V18.1z"/></svg>
<span class=sr-only>Share on LinkedIn</span></a></div></div><div class="article-meta article-meta--stack"><div class=meta-row>date: <time datetime=2019-04-25>Thu, 25 Apr 2019 09:00:00 +0900</time></div><div class=meta-row>author: <a class=meta-link href=https://www.utam0k.jp/page/about/>@utam0k</a></div><div class=meta-row>tags: [<a class=meta-link href=https://www.utam0k.jp/tags/xv6>xv6</a>, <a class=meta-link href=https://www.utam0k.jp/tags/os>os</a>]</div><div class=meta-row>languages: [
<span class=meta-lang-current>JA</span>
,
<a class=meta-link href=https://www.utam0k.jp/en/blog/2019/04/25/xv6_pagetable_2/>EN</a>
]</div></div></header><div class=meta-separator aria-hidden=true>---</div><details class=toc-inline id=mobile-toc-inline><summary>目次を開く</summary><nav class=toc aria-label="Table of contents"><p class=toc__title>目次</p><div class=toc__body><nav id=TableOfContents><ul><li><a href=#code-physical-memory-allocator>Code: Physical memory allocator</a><ul><li><a href=#大雑把にやろうとしていること>大雑把にやろうとしていること</a><ul><li><a href=#シーケンス図>シーケンス図</a></li><li><a href=#メモリレイアウト再掲載>メモリレイアウト(再掲載)</a></li><li><a href=#main>main()</a></li><li><a href=#kinit1>kinit1()</a></li><li><a href=#freerange>freerange()</a></li><li><a href=#kfree>kfree()</a></li><li><a href=#kinit2>kinit2()</a></li><li><a href=#kalloc>kalloc()</a></li></ul></li></ul></li><li><a href=#code-sbrk>Code: sbrk</a><ul><li><ul><li><a href=#sys_sbrk>sys_sbrk()</a></li><li><a href=#growproc>growproc()</a></li><li><a href=#deallocuvm>deallocuvm()</a></li><li><a href=#allocuvm>allocuvm()</a></li></ul></li></ul></li><li><a href=#code-exec>Code: exec</a><ul><li><ul><li><a href=#loaduvm>loaduvm()</a></li></ul></li></ul></li></ul></nav></div></nav></details><div class=toc-modal id=mobile-toc-modal hidden><div class=toc-modal__handle aria-hidden=true></div><div class=toc-modal__header><span>目次</span>
<button type=button class=toc-modal__close data-toc-close aria-label=Close>&#215;</button></div><div class=toc-modal__body><nav class=toc aria-label="Table of contents"><p class=toc__title>目次</p><div class=toc__body><nav id=TableOfContents><ul><li><a href=#code-physical-memory-allocator>Code: Physical memory allocator</a><ul><li><a href=#大雑把にやろうとしていること>大雑把にやろうとしていること</a><ul><li><a href=#シーケンス図>シーケンス図</a></li><li><a href=#メモリレイアウト再掲載>メモリレイアウト(再掲載)</a></li><li><a href=#main>main()</a></li><li><a href=#kinit1>kinit1()</a></li><li><a href=#freerange>freerange()</a></li><li><a href=#kfree>kfree()</a></li><li><a href=#kinit2>kinit2()</a></li><li><a href=#kalloc>kalloc()</a></li></ul></li></ul></li><li><a href=#code-sbrk>Code: sbrk</a><ul><li><ul><li><a href=#sys_sbrk>sys_sbrk()</a></li><li><a href=#growproc>growproc()</a></li><li><a href=#deallocuvm>deallocuvm()</a></li><li><a href=#allocuvm>allocuvm()</a></li></ul></li></ul></li><li><a href=#code-exec>Code: exec</a><ul><li><ul><li><a href=#loaduvm>loaduvm()</a></li></ul></li></ul></li></ul></nav></div></nav></div></div><div class=toc-modal__overlay hidden></div><div class=article-body><p><a href=https://www.utam0k.jp/blog/2019/03/05/xv6_index/>詳解xv6の目次</a><br><a href=https://www.utam0k.jp/blog/2019/03/05/xv6_pagetable_1/>前の記事</a>
<a href=https://www.utam0k.jp/blog/2019/07/08/xv6_traps_interrupts_drivers_1/>次の記事</a></p><hr><h1 id=code-physical-memory-allocator>Code: Physical memory allocator</h1><h2 id=大雑把にやろうとしていること>大雑把にやろうとしていること</h2><ul><li>連結リスト<code>freelist</code>に物理メモリをページ単位で登録する。(<a href=#kinit1>kinit1()</a>, <a href=#kinit2>kinit2()</a>)<ul><li><p><code>kalloc.c</code></p><div class=code-block><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>16</span> <span class=k>struct</span> <span class=n>run</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>17</span>   <span class=k>struct</span> <span class=n>run</span> <span class=o>*</span><span class=n>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>18</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=mi>19</span> 
</span></span><span class=line><span class=cl><span class=mi>20</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>21</span>   <span class=k>struct</span> <span class=n>spinlock</span> <span class=n>lock</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>22</span>   <span class=kt>int</span> <span class=n>use_lock</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>23</span>   <span class=k>struct</span> <span class=n>run</span> <span class=o>*</span><span class=n>freelist</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>24</span> <span class=p>}</span> <span class=n>kmem</span><span class=p>;</span></span></span></code></pre></div></div></li></ul></li><li>メモリをほしい人に割り当てができるようにする。(<a href=#kalloc>kalloc()</a>)</li></ul><h3 id=シーケンス図>シーケンス図</h3><p>ざっくりとした流れです。
関数の中身をみていていま自分がどこにいるのかわからなくなったら適宜見るとよいかもしれません。</p><figure><img src=https://www.utam0k.jp/blog/2019/04/25/xv6_pagetable_2/sequence.png></figure><h3 id=メモリレイアウト再掲載>メモリレイアウト(再掲載)</h3><p><a href=https://www.utam0k.jp/blog/2019/03/05/xv6_pagetable_1/>前の記事</a>で説明したメモリレイアウトの図です。
本章でもかなり使うので載せておきます。適宜確認してください。</p><figure><img src=https://www.utam0k.jp/blog/2019/04/25/xv6_pagetable_2/memorylayout.png></figure><p>Source: <a href=https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf>commentary/textbook</a></p><p>VAとPAの関係表です。</p><table><thead><tr><th style=text-align:center>名前</th><th style=text-align:center>仮想アドレス</th><th style=text-align:center>物理アドレス</th></tr></thead><tbody><tr><td style=text-align:center>end</td><td style=text-align:center>end</td><td style=text-align:center>V2P(end)</td></tr><tr><td style=text-align:center>PHYSTOP</td><td style=text-align:center>P2V(PHYSTOP)</td><td style=text-align:center>PHYSTOP</td></tr><tr><td style=text-align:center>KERNBASE</td><td style=text-align:center>KERNBASE</td><td style=text-align:center>V2P(KERNBASE)</td></tr></tbody></table><h3 id=main>main()</h3><ul><li><p><code>main.c</code></p><div class=code-block><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>17</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=mi>18</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>19</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>20</span>   <span class=nf>kinit1</span><span class=p>(</span><span class=n>end</span><span class=p>,</span> <span class=nf>P2V</span><span class=p>(</span><span class=mi>4</span><span class=o>*</span><span class=mi>1024</span><span class=o>*</span><span class=mi>1024</span><span class=p>));</span> <span class=c1>// phys page allocator
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>21</span>   <span class=nf>kvmalloc</span><span class=p>();</span>      <span class=c1>// kernel page table
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>~~~</span>
</span></span><span class=line><span class=cl><span class=mi>35</span>   <span class=nf>kinit2</span><span class=p>(</span><span class=nf>P2V</span><span class=p>(</span><span class=mi>4</span><span class=o>*</span><span class=mi>1024</span><span class=o>*</span><span class=mi>1024</span><span class=p>),</span> <span class=nf>P2V</span><span class=p>(</span><span class=n>PHYSTOP</span><span class=p>));</span> <span class=c1>// must come after startothers()
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=o>~~~</span>
</span></span><span class=line><span class=cl><span class=mi>38</span> <span class=p>}</span></span></span></code></pre></div></div><ul><li>L20: end~4MBまでをページアロケータに登録</li><li>L20までのPDTは<code>entrypgdir</code><ul><li><p><code>main.c</code></p><div class=code-block><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>  <span class=mi>97</span> <span class=c1>// The boot page table used in entry.S and entryother.S.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=mi>98</span> <span class=c1>// Page directories (and page tables) must start on page boundaries,
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=mi>99</span> <span class=c1>// hence the __aligned__ attribute.
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=mi>100</span> <span class=c1>// PTE_PS in a page directory entry enables 4Mbyte pages.
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=mi>101</span>
</span></span><span class=line><span class=cl> <span class=mi>102</span> <span class=nf>__attribute__</span><span class=p>((</span><span class=nf>__aligned__</span><span class=p>(</span><span class=n>PGSIZE</span><span class=p>)))</span>
</span></span><span class=line><span class=cl> <span class=mi>103</span> <span class=kt>pde_t</span> <span class=n>entrypgdir</span><span class=p>[</span><span class=n>NPDENTRIES</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>104</span>   <span class=c1>// Map VA&#39;s [0, 4MB) to PA&#39;s [0, 4MB)
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=mi>105</span>   <span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>|</span> <span class=n>PTE_P</span> <span class=o>|</span> <span class=n>PTE_W</span> <span class=o>|</span> <span class=n>PTE_PS</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>106</span>   <span class=c1>// Map VA&#39;s [KERNBASE, KERNBASE+4MB) to PA&#39;s [0, 4MB)
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=mi>107</span>   <span class=p>[</span><span class=n>KERNBASE</span><span class=o>&gt;&gt;</span><span class=n>PDXSHIFT</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>|</span> <span class=n>PTE_P</span> <span class=o>|</span> <span class=n>PTE_W</span> <span class=o>|</span> <span class=n>PTE_PS</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>108</span> <span class=p>};</span></span></span></code></pre></div></div><ul><li>L105: VA: [0 ~ 4MB)→ PA: [0 ~ 4MB)</li><li>L106: VA: [KERNBASE ~ KERNBASE+4MB)→ PA[0 ~ 4MB)<br>両方とも同じPAにマッピングしている</li></ul></li></ul></li><li>L21: カーネルのPDTを作成、設定</li><li>L22: 4MB~PHYSTOPまでをページアロケータに登録</li><li><a href=#kinit1>kinit1()</a>と<a href=#kinit2>kinit2()</a>の2回にわけてページアロケータに登録している理由<ul><li><code>entry.S</code>では物理アドレス0<del>4MBしかマッピングしていない(物理アドレス0</del>4MBまでしか使えない)</li><li><a href=#kinit1>kinit1()</a>と後で<code>kvmalloc()</code>を読んで本来のページングを行っている<ul><li><code>kvmalloc()</code>はメモリアロケータが必要(ブートストラップ問題)</li></ul></li><li><a href=#kinit2>kinit2()</a>で4MB以上も登録する</li></ul></li></ul></li></ul><h3 id=kinit1>kinit1()</h3><ul><li><p><code>kallo.c</code></p><div class=code-block><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>26</span> <span class=c1>// Initialization happens in two phases.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>27</span> <span class=c1>// 1. main() calls kinit1() while still using entrypgdir to place just
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>28</span> <span class=c1>// the pages mapped by entrypgdir on free list.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>29</span> <span class=c1>// 2. main() calls kinit2() with the rest of the physical pages
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>30</span> <span class=c1>// after installing a full page table that maps them on all cores.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>31</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=mi>32</span> <span class=nf>kinit1</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>vstart</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>vend</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>33</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>34</span>   <span class=nf>initlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>,</span> <span class=s>&#34;kmem&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>35</span>   <span class=n>kmem</span><span class=p>.</span><span class=n>use_lock</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>36</span>   <span class=nf>freerange</span><span class=p>(</span><span class=n>vstart</span><span class=p>,</span> <span class=n>vend</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>37</span> <span class=p>}</span></span></span></code></pre></div></div><ul><li><code>vstart</code>: end, <code>vend</code>: P2V(4<em>1024</em>1024)</li><li>L34 - 35: ロックを初期化してオフにする(詳細はLocking)<br>ロックを使用するにはメモリアロケータが必要になるのでまだ使えない</li><li>L36:<code> freelist</code>に領域(<code>vstart</code> ~ <code>vend</code>)を登録する</li></ul></li></ul><h3 id=freerange>freerange()</h3><ul><li><p><code>kalloc.c</code></p><div class=code-block><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>46</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=mi>47</span> <span class=nf>freerange</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>vstart</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>vend</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>48</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>49</span>   <span class=kt>char</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>50</span>   <span class=n>p</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=nf>PGROUNDUP</span><span class=p>((</span><span class=n>uint</span><span class=p>)</span><span class=n>vstart</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>51</span>   <span class=k>for</span><span class=p>(;</span> <span class=n>p</span> <span class=o>+</span> <span class=n>PGSIZE</span> <span class=o>&lt;=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>vend</span><span class=p>;</span> <span class=n>p</span> <span class=o>+=</span> <span class=n>PGSIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>52</span>     <span class=nf>kfree</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>53</span> <span class=p>}</span></span></span></code></pre></div></div><ul><li>L50: <code>PGSIZE</code>に合わせてアライン</li><li>L51 - 52: ページサイズごとに<a href=#kfree>kfree()</a>を呼び出す</li></ul></li></ul><h3 id=kfree>kfree()</h3><p>引数のアドレス(ページの先頭アドレス)を<code>freelist</code>から消去</p><ul><li><p><code>kalloc.c</code></p><div class=code-block><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>54</span> <span class=c1>//PAGEBREAK: 21
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>55</span> <span class=c1>// Free the page of physical memory pointed at by v,
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>56</span> <span class=c1>// which normally should have been returned by a
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>57</span> <span class=c1>// call to kalloc().  (The exception is when
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>58</span> <span class=c1>// initializing the allocator; see kinit above.)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>59</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=mi>60</span> <span class=nf>kfree</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>61</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>62</span>   <span class=k>struct</span> <span class=n>run</span> <span class=o>*</span><span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>63</span>
</span></span><span class=line><span class=cl><span class=mi>64</span>   <span class=nf>if</span><span class=p>((</span><span class=n>uint</span><span class=p>)</span><span class=n>v</span> <span class=o>%</span> <span class=n>PGSIZE</span> <span class=o>||</span> <span class=n>v</span> <span class=o>&lt;</span> <span class=n>end</span> <span class=o>||</span> <span class=nf>V2P</span><span class=p>(</span><span class=n>v</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>PHYSTOP</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>65</span>     <span class=nf>panic</span><span class=p>(</span><span class=s>&#34;kfree&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>66</span>
</span></span><span class=line><span class=cl><span class=mi>67</span>   <span class=c1>// Fill with junk to catch dangling refs.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>68</span>   <span class=nf>memset</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>69</span>
</span></span><span class=line><span class=cl><span class=mi>70</span>   <span class=nf>if</span><span class=p>(</span><span class=n>kmem</span><span class=p>.</span><span class=n>use_lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>71</span>     <span class=nf>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>72</span>   <span class=n>r</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>run</span><span class=o>*</span><span class=p>)</span><span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>73</span>   <span class=n>r</span><span class=o>-&gt;</span><span class=n>next</span> <span class=o>=</span> <span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>74</span>   <span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span> <span class=o>=</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>75</span>   <span class=nf>if</span><span class=p>(</span><span class=n>kmem</span><span class=p>.</span><span class=n>use_lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>76</span>     <span class=nf>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>77</span> <span class=p>}</span></span></span></code></pre></div></div><ul><li>L64: エラーチェック<br>開始のアドレス(<code>v</code>)が<code>PGSIZE</code>の倍数であるか
<code>v</code>がFree memory(end ~ P2V(PHYSTOP)の範囲)であるか</li><li>L68: v+PAGESIZEまで1で埋める</li><li>L72 ~ 74: vを<code>freelist</code>に登録</li><li>L70 ~ 71, L75 ~ 76: 詳しくはLockingで<br><code>freelist</code>を変更中にほかのスレッドに変更されるとリストが壊れるため</li></ul></li></ul><h3 id=kinit2>kinit2()</h3><ul><li><p><code>kalloc.c</code></p><div class=code-block><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>39</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=mi>40</span> <span class=nf>kinit2</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>vstart</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>vend</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>41</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>42</span>   <span class=nf>freerange</span><span class=p>(</span><span class=n>vstart</span><span class=p>,</span> <span class=n>vend</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>43</span>   <span class=n>kmem</span><span class=p>.</span><span class=n>use_lock</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>44</span> <span class=p>}</span></span></span></code></pre></div></div><ul><li>L42: 4MB~PHYSTOPまでの物理アドレス空間をフリーリストに登録</li><li>L44: 詳しくはLockingで<br>ロックを有効化</li></ul></li></ul><h3 id=kalloc>kalloc()</h3><p>物理メモリ(PGSIZE分)提供</p><ul><li><p><code>kalloc.c</code></p><div class=code-block><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>79</span> <span class=c1>// Allocate one 4096-byte page of physical memory.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>80</span> <span class=c1>// Returns a pointer that the kernel can use.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>81</span> <span class=c1>// Returns 0 if the memory cannot be allocated.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>82</span> <span class=kt>char</span><span class=o>*</span>
</span></span><span class=line><span class=cl><span class=mi>83</span> <span class=nf>kalloc</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>84</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>85</span>   <span class=k>struct</span> <span class=n>run</span> <span class=o>*</span><span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>86</span>
</span></span><span class=line><span class=cl><span class=mi>87</span>   <span class=nf>if</span><span class=p>(</span><span class=n>kmem</span><span class=p>.</span><span class=n>use_lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>88</span>     <span class=nf>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>89</span>   <span class=n>r</span> <span class=o>=</span> <span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>90</span>   <span class=nf>if</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>91</span>     <span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span> <span class=o>=</span> <span class=n>r</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>92</span>   <span class=nf>if</span><span class=p>(</span><span class=n>kmem</span><span class=p>.</span><span class=n>use_lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>93</span>     <span class=nf>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>94</span>   <span class=nf>return</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>95</span> <span class=p>}</span></span></span></code></pre></div></div><ul><li>L89 - 91: <code>freelist</code>から1つ取り出す</li><li>L87 - 88, L92- 93: 詳しくはLockingで</li></ul></li></ul><h1 id=code-sbrk>Code: sbrk</h1><h3 id=sys_sbrk>sys_sbrk()</h3><p>実行中のプロセスのメモリのサイズを増やしたり減らしたりするシステムコール</p><ul><li><p><code>sysproc.c</code></p><div class=code-block><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>45</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=mi>46</span> <span class=nf>sys_sbrk</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>47</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>48</span>   <span class=kt>int</span> <span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>49</span>   <span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>50</span>
</span></span><span class=line><span class=cl><span class=mi>51</span>   <span class=k>if</span><span class=p>(</span><span class=nf>argint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>n</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>52</span>     <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>53</span>   <span class=n>addr</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>54</span>   <span class=k>if</span><span class=p>(</span><span class=nf>growproc</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>55</span>     <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>56</span>   <span class=k>return</span> <span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>57</span> <span class=p>}</span></span></span></code></pre></div></div><ul><li>L51 - 52: 引数の処理(詳細は後の章)</li><li>L54: メモリを増やす(<a href=#growproc>growproc()</a>)</li></ul></li></ul><h3 id=growproc>growproc()</h3><p>実行中のプロセスに割り当てるメモリを増やす。
つまり、ページングの設定を追加する</p><ul><li><p><code>proc.c</code></p><div class=code-block><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>156</span> <span class=c1>// Grow current process&#39;s memory by n bytes.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>157</span> <span class=c1>// Return 0 on success, -1 on failure.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>158</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=mi>159</span> <span class=nf>growproc</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>160</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>161</span>   <span class=n>uint</span> <span class=n>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>162</span>   <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>curproc</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=mi>163</span>
</span></span><span class=line><span class=cl><span class=mi>164</span>   <span class=n>sz</span> <span class=o>=</span> <span class=n>curproc</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>165</span>   <span class=nf>if</span><span class=p>(</span><span class=n>n</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=mi>166</span>     <span class=k>if</span><span class=p>((</span><span class=n>sz</span> <span class=o>=</span> <span class=nf>allocuvm</span><span class=p>(</span><span class=n>curproc</span><span class=o>-&gt;</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>sz</span> <span class=o>+</span> <span class=n>n</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>167</span>       <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>168</span>   <span class=p>}</span> <span class=k>else</span> <span class=nf>if</span><span class=p>(</span><span class=n>n</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=mi>169</span>     <span class=k>if</span><span class=p>((</span><span class=n>sz</span> <span class=o>=</span> <span class=nf>deallocuvm</span><span class=p>(</span><span class=n>curproc</span><span class=o>-&gt;</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>sz</span> <span class=o>+</span> <span class=n>n</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>170</span>       <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>171</span>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=mi>172</span>   <span class=n>curproc</span><span class=o>-&gt;</span><span class=n>sz</span> <span class=o>=</span> <span class=n>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>173</span>   <span class=nf>switchuvm</span><span class=p>(</span><span class=n>curproc</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>174</span>   <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>175</span> <span class=p>}</span></span></span></code></pre></div></div><ul><li>L162: 実行中のプロセスの取得</li><li>L165 - 167: 割り当てているメモリを増やす場合(<a href=#allocuvm>allocuvm()</a>)</li><li>L168 - 171: 割り当てているメモリを減らす場合(<a href=#deallocuvm>deallocuvm()</a>)</li></ul></li></ul><h3 id=deallocuvm>deallocuvm()</h3><p>割り当てている物理メモリを<code>freelist</code>から消去</p><ul><li><p><code>vm.c</code></p><div class=code-block><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>251</span> <span class=c1>// Deallocate user pages to bring the process size from oldsz to
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>252</span> <span class=c1>// newsz.  oldsz and newsz need not be page-aligned, nor does newsz
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>253</span> <span class=c1>// need to be less than oldsz.  oldsz can be larger than the actual
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>254</span> <span class=c1>// process size.  Returns the new process size.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>255</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=mi>256</span> <span class=nf>deallocuvm</span><span class=p>(</span><span class=kt>pde_t</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>uint</span> <span class=n>oldsz</span><span class=p>,</span> <span class=n>uint</span> <span class=n>newsz</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>257</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>258</span>   <span class=kt>pte_t</span> <span class=o>*</span><span class=n>pte</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>259</span>   <span class=n>uint</span> <span class=n>a</span><span class=p>,</span> <span class=n>pa</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>260</span>
</span></span><span class=line><span class=cl><span class=mi>261</span>   <span class=nf>if</span><span class=p>(</span><span class=n>newsz</span> <span class=o>&gt;=</span> <span class=n>oldsz</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>262</span>     <span class=k>return</span> <span class=n>oldsz</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>263</span>
</span></span><span class=line><span class=cl><span class=mi>264</span>   <span class=n>a</span> <span class=o>=</span> <span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>newsz</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>265</span>   <span class=k>for</span><span class=p>(;</span> <span class=n>a</span>  <span class=o>&lt;</span> <span class=n>oldsz</span><span class=p>;</span> <span class=n>a</span> <span class=o>+=</span> <span class=n>PGSIZE</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=mi>266</span>     <span class=n>pte</span> <span class=o>=</span> <span class=nf>walkpgdir</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>a</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>267</span>     <span class=nf>if</span><span class=p>(</span><span class=o>!</span><span class=n>pte</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>268</span>       <span class=n>a</span> <span class=o>=</span> <span class=nf>PGADDR</span><span class=p>(</span><span class=nf>PDX</span><span class=p>(</span><span class=n>a</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>-</span> <span class=n>PGSIZE</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>269</span>     <span class=k>else</span> <span class=nf>if</span><span class=p>((</span><span class=o>*</span><span class=n>pte</span> <span class=o>&amp;</span> <span class=n>PTE_P</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=mi>270</span>       <span class=n>pa</span> <span class=o>=</span> <span class=nf>PTE_ADDR</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>271</span>       <span class=k>if</span><span class=p>(</span><span class=n>pa</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>272</span>         <span class=nf>panic</span><span class=p>(</span><span class=s>&#34;kfree&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>273</span>       <span class=kt>char</span> <span class=o>*</span><span class=n>v</span> <span class=o>=</span> <span class=nf>P2V</span><span class=p>(</span><span class=n>pa</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>274</span>       <span class=nf>kfree</span><span class=p>(</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>275</span>       <span class=o>*</span><span class=n>pte</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>276</span>     <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=mi>277</span>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=mi>278</span>   <span class=k>return</span> <span class=n>newsz</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>279</span> <span class=p>}</span></span></span></code></pre></div></div><ul><li><p>L264: <code>PGSIZE</code>にそろえる</p></li><li><p>L266: 該当のPTEの捜索</p><ul><li>ユーザの仮想アドレスは0からスタートしているので<code>oldsz</code>や<code>newsz</code>はそのまま仮想アドレスを示す</li><li>もし、なかった場合に<a href=https://www.utam0k.jp/blog/2019/03/05/xv6_pagetable_1/#walkpgdir>walkpgidr()</a>が割り当てることはしない(3個目の引数が0であるため)</li></ul></li><li><p>L267 - 268: 該当のPTEが存在していなかった場合</p><ul><li><code>PDX(a) + 1</code>: 仮想アドレス<code>a</code>が対応付けられているPDE(<code>PDE_a</code>)のインデックス + 1</li><li><code>PGADDR(PDX(a) + 1, 0, 0) - PGSIZE</code>: <code>PDE_a</code>の次のPDEが対応付けている先頭の仮想アドレス - <code>PGSIZE</code><ul><li><code>PGSIZE</code>が引かれているのは次のfor分で<code>a += PGSIZE</code>されるため</li></ul></li></ul></li><li><p>L269 - 275: 該当するPTEが存在していた<br><code>PTE_P</code>: ページが物理メモリに存在しているかどうか(物理メモリが割り当てられているかどうか)</p></li><li><p>L270: ページの先頭物理アドレス</p><ul><li><p><code>mmu.h</code></p><div class=code-block><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl> <span class=mi>99</span> <span class=c1>// Address in page table or page directory entry
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>100</span> <span class=err>#</span><span class=n>define</span> <span class=nf>PTE_ADDR</span><span class=p>(</span><span class=n>pte</span><span class=p>)</span>   <span class=p>((</span><span class=n>uint</span><span class=p>)(</span><span class=n>pte</span><span class=p>)</span> <span class=o>&amp;</span> <span class=o>~</span><span class=mh>0xFFF</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>101</span> <span class=err>#</span><span class=n>define</span> <span class=nf>PTE_FLAGS</span><span class=p>(</span><span class=n>pte</span><span class=p>)</span>  <span class=p>((</span><span class=n>uint</span><span class=p>)(</span><span class=n>pte</span><span class=p>)</span> <span class=o>&amp;</span>  <span class=mh>0xFFF</span><span class=p>)</span>     
</span></span></code></pre></div></div></li></ul></li><li><p>L271 - 272, L275: 初期化されたPTEは0なので0だった場合はエラー</p></li><li><p>L273: 物理メモリの管理(<code>freelist</code>)はカーネル領域で管理しているので<code>P2V()</code>が使える</p></li><li><p>L274: 物理メモリの使用を解放</p></li></ul></li></ul><h3 id=allocuvm>allocuvm()</h3><p>新しく物理メモリを割り当てる</p><ul><li><p><code>vm.c</code></p><div class=code-block><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>219</span> <span class=c1>// Allocate page tables and physical memory to grow process from oldsz to
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>220</span> <span class=c1>// newsz, which need not be page aligned.  Returns new size or 0 on error.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>221</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=mi>222</span> <span class=nf>allocuvm</span><span class=p>(</span><span class=kt>pde_t</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>uint</span> <span class=n>oldsz</span><span class=p>,</span> <span class=n>uint</span> <span class=n>newsz</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>223</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>224</span>   <span class=kt>char</span> <span class=o>*</span><span class=n>mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>225</span>   <span class=n>uint</span> <span class=n>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>226</span>
</span></span><span class=line><span class=cl><span class=mi>227</span>   <span class=nf>if</span><span class=p>(</span><span class=n>newsz</span> <span class=o>&gt;=</span> <span class=n>KERNBASE</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>228</span>     <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>229</span>   <span class=nf>if</span><span class=p>(</span><span class=n>newsz</span> <span class=o>&lt;</span> <span class=n>oldsz</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>230</span>     <span class=k>return</span> <span class=n>oldsz</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>231</span>
</span></span><span class=line><span class=cl><span class=mi>232</span>   <span class=n>a</span> <span class=o>=</span> <span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>oldsz</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>233</span>   <span class=k>for</span><span class=p>(;</span> <span class=n>a</span> <span class=o>&lt;</span> <span class=n>newsz</span><span class=p>;</span> <span class=n>a</span> <span class=o>+=</span> <span class=n>PGSIZE</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=mi>234</span>     <span class=n>mem</span> <span class=o>=</span> <span class=nf>kalloc</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=mi>235</span>     <span class=nf>if</span><span class=p>(</span><span class=n>mem</span> <span class=o>==</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=mi>236</span>       <span class=nf>cprintf</span><span class=p>(</span><span class=s>&#34;allocuvm out of memory</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>237</span>       <span class=nf>deallocuvm</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>newsz</span><span class=p>,</span> <span class=n>oldsz</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>238</span>       <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>239</span>     <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=mi>240</span>     <span class=nf>memset</span><span class=p>(</span><span class=n>mem</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>241</span>     <span class=nf>if</span><span class=p>(</span><span class=nf>mappages</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>a</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>,</span> <span class=nf>V2P</span><span class=p>(</span><span class=n>mem</span><span class=p>),</span> <span class=n>PTE_W</span><span class=o>|</span><span class=n>PTE_U</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=mi>242</span>       <span class=nf>cprintf</span><span class=p>(</span><span class=s>&#34;allocuvm out of memory (2)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>243</span>       <span class=nf>deallocuvm</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>newsz</span><span class=p>,</span> <span class=n>oldsz</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>244</span>       <span class=nf>kfree</span><span class=p>(</span><span class=n>mem</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>245</span>       <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>246</span>     <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=mi>247</span>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=mi>248</span>   <span class=k>return</span> <span class=n>newsz</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>249</span> <span class=p>}</span></span></span></code></pre></div></div><ul><li>L227 - 230: エラーチェック</li><li>L232: PGSIZEにアライメント</li><li>L233 - 247: PGSIZE毎に必要なだけ割り当てる</li><li>L234: 割り当てる物理メモリの先頭アドレス取得(PGSIZE分)<ul><li><a href=#kalloc>kalloc()</a></li></ul></li><li>L234 - 239: もう割り当てるメモリがなかった場合</li><li>L240: 0で初期化</li><li>L241 - 246: 仮想アドレスと取得した物理メモリをマッピング<ul><li><a href=https://www.utam0k.jp/blog/2019/03/05/xv6_pagetable_1/#mappages>mappages()</a></li><li><a href=#deallocuvm>deallocuvm()</a></li><li><a href=#kfree>kfree()</a></li></ul></li></ul></li></ul><h1 id=code-exec>Code: exec</h1><p>ユーザのカーネル空間を作るシステムコール</p><ul><li><p><code>exec.c</code></p><div class=code-block><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>10</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=mi>11</span> <span class=nf>exec</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>path</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>12</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>13</span>   <span class=kt>char</span> <span class=o>*</span><span class=n>s</span><span class=p>,</span> <span class=o>*</span><span class=n>last</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>14</span>   <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>15</span>   <span class=n>uint</span> <span class=n>argc</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>sp</span><span class=p>,</span> <span class=n>ustack</span><span class=p>[</span><span class=mi>3</span><span class=o>+</span><span class=n>MAXARG</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=mi>16</span>   <span class=k>struct</span> <span class=n>elfhdr</span> <span class=n>elf</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>17</span>   <span class=k>struct</span> <span class=n>inode</span> <span class=o>*</span><span class=n>ip</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>18</span>   <span class=k>struct</span> <span class=n>proghdr</span> <span class=n>ph</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>19</span>   <span class=kt>pde_t</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>,</span> <span class=o>*</span><span class=n>oldpgdir</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>20</span>   <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>curproc</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>     <span class=o>~~~</span> <span class=n>pathをもとに該当するinodeを取得</span>
</span></span><span class=line><span class=cl><span class=mi>30</span>   <span class=n>pgdir</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>31</span>
</span></span><span class=line><span class=cl><span class=mi>32</span>   <span class=c1>// Check ELF header
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=o>~~~</span>  <span class=n>ELFがエラーかチェック</span>
</span></span><span class=line><span class=cl><span class=mi>38</span>   <span class=k>if</span><span class=p>((</span><span class=n>pgdir</span> <span class=o>=</span> <span class=nf>setupkvm</span><span class=p>())</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>39</span>     <span class=k>goto</span> <span class=n>bad</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>40</span>
</span></span><span class=line><span class=cl><span class=mi>41</span>   <span class=c1>// Load program into memory.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>42</span>   <span class=n>sz</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>43</span>   <span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>off</span><span class=o>=</span><span class=n>elf</span><span class=p>.</span><span class=n>phoff</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>elf</span><span class=p>.</span><span class=n>phnum</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>,</span> <span class=n>off</span><span class=o>+=</span><span class=k>sizeof</span><span class=p>(</span><span class=n>ph</span><span class=p>)){</span>
</span></span><span class=line><span class=cl><span class=mi>44</span>     <span class=k>if</span><span class=p>(</span><span class=nf>readi</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>ph</span><span class=p>,</span> <span class=n>off</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>ph</span><span class=p>))</span> <span class=o>!=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>ph</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=mi>45</span>       <span class=k>goto</span> <span class=n>bad</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>~~~</span> <span class=err>エラーチェック</span>
</span></span><span class=line><span class=cl><span class=mi>52</span>     <span class=k>if</span><span class=p>((</span><span class=n>sz</span> <span class=o>=</span> <span class=nf>allocuvm</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>ph</span><span class=p>.</span><span class=n>vaddr</span> <span class=o>+</span> <span class=n>ph</span><span class=p>.</span><span class=n>memsz</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>53</span>       <span class=k>goto</span> <span class=n>bad</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>54</span>     <span class=k>if</span><span class=p>(</span><span class=n>ph</span><span class=p>.</span><span class=n>vaddr</span> <span class=o>%</span> <span class=n>PGSIZE</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>55</span>       <span class=k>goto</span> <span class=n>bad</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>56</span>     <span class=k>if</span><span class=p>(</span><span class=nf>loaduvm</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>ph</span><span class=p>.</span><span class=n>vaddr</span><span class=p>,</span> <span class=n>ip</span><span class=p>,</span> <span class=n>ph</span><span class=p>.</span><span class=n>off</span><span class=p>,</span> <span class=n>ph</span><span class=p>.</span><span class=n>filesz</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>57</span>       <span class=k>goto</span> <span class=n>bad</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>58</span>   <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=o>~~~</span>
</span></span><span class=line><span class=cl><span class=mi>63</span>   <span class=c1>// Allocate two pages at the next page boundary.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>64</span>   <span class=c1>// Make the first inaccessible.  Use the second as the user stack.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>65</span>   <span class=n>sz</span> <span class=o>=</span> <span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>66</span>   <span class=k>if</span><span class=p>((</span><span class=n>sz</span> <span class=o>=</span> <span class=nf>allocuvm</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>sz</span> <span class=o>+</span> <span class=mi>2</span><span class=o>*</span><span class=n>PGSIZE</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>67</span>     <span class=k>goto</span> <span class=n>bad</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>68</span>   <span class=nf>clearpteu</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)(</span><span class=n>sz</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>PGSIZE</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=mi>69</span>   <span class=n>sp</span> <span class=o>=</span> <span class=n>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>70</span>
</span></span><span class=line><span class=cl><span class=mi>71</span>   <span class=c1>// Push argument strings, prepare rest of stack in ustack.
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=o>~~~</span> <span class=err>引数などのスタックを設定</span>
</span></span><span class=line><span class=cl><span class=mi>90</span>   <span class=c1>// Save program name for debugging.
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=o>~~~</span> <span class=err>デバッグ用の諸々</span>
</span></span><span class=line><span class=cl><span class=mi>95</span>
</span></span><span class=line><span class=cl><span class=mi>96</span>   <span class=c1>// Commit to the user image.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>97</span>   <span class=n>oldpgdir</span> <span class=o>=</span> <span class=n>curproc</span><span class=o>-&gt;</span><span class=n>pgdir</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>98</span>   <span class=n>curproc</span><span class=o>-&gt;</span><span class=n>pgdir</span> <span class=o>=</span> <span class=n>pgdir</span><span class=p>;</span>
</span></span><span class=line><span class=cl>     <span class=o>~~~</span> <span class=err>諸々</span><span class=n>curprocの設定</span>
</span></span><span class=line><span class=cl><span class=mi>102</span>   <span class=nf>switchuvm</span><span class=p>(</span><span class=n>curproc</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>103</span>   <span class=nf>freevm</span><span class=p>(</span><span class=n>oldpgdir</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>104</span>   <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>105</span>
</span></span><span class=line><span class=cl><span class=mi>106</span>  <span class=nl>bad</span><span class=p>:</span>
</span></span><span class=line><span class=cl>     <span class=o>~~~</span> <span class=err>エラー時の処理</span></span></span></code></pre></div></div><ul><li>L38: カーネル空間のメモリをマッピング</li><li>L43 - 58: ELFのセグメント毎にメモリにロード</li><li>L52: 物理メモリの割り当てる<br><code>sz</code>: oldsize<br><code>ph.vaddr + ph.memsz</code>: newsize</li><li>L56: <code>ip</code>(inode)をELFを元に所定の仮想アドレスに展開(<a href=#loaduvm>loaduvm()</a>)</li><li>L65 - 67: サイズがでかすぎる引数(ページを跨ぐサイズ)をきちんとエラーとして扱うために2ページ分を割り当てる</li><li>L68: ユーザモードではアクセスできなくする<ul><li><p><code>vm.c</code></p><div class=code-block><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>300</span> <span class=c1>// Clear PTE_U on a page. Used to create an inaccessible
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>301</span> <span class=c1>// page beneath the user stack.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>302</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=mi>303</span> <span class=nf>clearpteu</span><span class=p>(</span><span class=kt>pde_t</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>uva</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>304</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>305</span>   <span class=kt>pte_t</span> <span class=o>*</span><span class=n>pte</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>306</span>
</span></span><span class=line><span class=cl><span class=mi>307</span>   <span class=n>pte</span> <span class=o>=</span> <span class=nf>walkpgdir</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>uva</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>308</span>   <span class=nf>if</span><span class=p>(</span><span class=n>pte</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>309</span>     <span class=nf>panic</span><span class=p>(</span><span class=s>&#34;clearpteu&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>310</span>   <span class=o>*</span><span class=n>pte</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>PTE_U</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>311</span> <span class=p>}</span></span></span></code></pre></div></div><ul><li><a href=https://www.utam0k.jp/blog/2019/03/05/xv6_pagetable_1/#walkpgdir>walkpgidr()</a></li></ul></li></ul></li><li>L97, 103: 元々割り当てていた物理メモリを解放</li><li>L98: 新しく設定したページングを割り当てる</li><li>L102: 新しく設定したページテーブルに切り替える</li></ul></li></ul><h3 id=loaduvm>loaduvm()</h3><p>メモリ上にinodeのデータを展開</p><ul><li><p><code>vm.c</code></p><div class=code-block><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>195</span> <span class=c1>// Load a program segment into pgdir.  addr must be page-aligned
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>196</span> <span class=c1>// and the pages from addr to addr+sz must already be mapped.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>197</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=mi>198</span> <span class=nf>loaduvm</span><span class=p>(</span><span class=kt>pde_t</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>addr</span><span class=p>,</span> <span class=k>struct</span> <span class=n>inode</span> <span class=o>*</span><span class=n>ip</span><span class=p>,</span> <span class=n>uint</span> <span class=n>offset</span><span class=p>,</span> <span class=n>uint</span> <span class=n>sz</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>199</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>200</span>   <span class=n>uint</span> <span class=n>i</span><span class=p>,</span> <span class=n>pa</span><span class=p>,</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>201</span>   <span class=kt>pte_t</span> <span class=o>*</span><span class=n>pte</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>202</span>
</span></span><span class=line><span class=cl><span class=mi>203</span>   <span class=nf>if</span><span class=p>((</span><span class=n>uint</span><span class=p>)</span> <span class=n>addr</span> <span class=o>%</span> <span class=n>PGSIZE</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>204</span>     <span class=nf>panic</span><span class=p>(</span><span class=s>&#34;loaduvm: addr must be page aligned&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>205</span>   <span class=k>for</span><span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>sz</span><span class=p>;</span> <span class=n>i</span> <span class=o>+=</span> <span class=n>PGSIZE</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=mi>206</span>     <span class=k>if</span><span class=p>((</span><span class=n>pte</span> <span class=o>=</span> <span class=nf>walkpgdir</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>addr</span><span class=o>+</span><span class=n>i</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>207</span>       <span class=nf>panic</span><span class=p>(</span><span class=s>&#34;loaduvm: address should exist&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>208</span>     <span class=n>pa</span> <span class=o>=</span> <span class=nf>PTE_ADDR</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>209</span>     <span class=nf>if</span><span class=p>(</span><span class=n>sz</span> <span class=o>-</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>PGSIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>210</span>       <span class=n>n</span> <span class=o>=</span> <span class=n>sz</span> <span class=o>-</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>211</span>     <span class=k>else</span>
</span></span><span class=line><span class=cl><span class=mi>212</span>       <span class=n>n</span> <span class=o>=</span> <span class=n>PGSIZE</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>213</span>     <span class=nf>if</span><span class=p>(</span><span class=nf>readi</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span> <span class=nf>P2V</span><span class=p>(</span><span class=n>pa</span><span class=p>),</span> <span class=n>offset</span><span class=o>+</span><span class=n>i</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span> <span class=o>!=</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>214</span>       <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>215</span>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=mi>216</span>   <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>217</span> <span class=p>}</span></span></span></code></pre></div></div><ul><li>L203: アライメントされているかチェック</li><li>L205 - 215: PGSIZE毎に物理メモリにinodeのデータを展開</li><li>L206 - 208: 該当する物理アドレスを仮想アドレスから探す<ul><li><a href=https://www.utam0k.jp/blog/2019/03/05/xv6_pagetable_1/#walkpgdir>walkpgidr()</a></li></ul></li><li>L209 - 212: 読み込むサイズがPGSIZEよりも大きければPGSIZE分読み込む</li><li>L213 - 214: データを展開(詳細はファイルシステムの章)<ul><li><code>ip</code>: inode</li><li><code>P2V(pa)</code>: 読み込む先(<code>dst</code>)</li><li><code>offset+i</code>: <code>dst</code>から何バイト先に読み込むか</li><li><code>n</code>: 読み込むサイズ</li></ul></li></ul></li></ul><hr><p>コメントや間違いなどがある場合は<a href=https://twitter.com/utam0k>Twitter</a>に連絡してもらうか
<a href=https://github.com/utam0k/utam0k.github.io/issues/1>Issue</a>に書いていただくと助かります。</p></div><div class=follow-cta><a class=follow-cta__link href="https://x.com/utam0k?utm_source=blog&utm_medium=follow_cta&utm_campaign=article_footer" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h5.3l3.4 4.8L14.8 3H21l-6.8 9.2L21 21h-5.3L12 15.8 8.2 21H3l6.8-8.9L3 3z"/></svg>
Follow @utam0k</a></div><div class=article-footer><a class=muted href=https://www.utam0k.jp/blog/>← Back to blog</a><div class=article-nav><a class=nav-arrow href=https://www.utam0k.jp/blog/2019/03/05/xv6_pagetable_1/>← 詳解xv6 Page tables 1</a>
<a class=nav-arrow href=https://www.utam0k.jp/blog/2019/07/08/xv6_traps_interrupts_drivers_1/>詳解xv6 Traps, interrupts, and drivers 1 →</a></div></div></article><aside class=toc-desktop><nav class=toc aria-label="Table of contents"><p class=toc__title>目次</p><div class=toc__body><nav id=TableOfContents><ul><li><a href=#code-physical-memory-allocator>Code: Physical memory allocator</a><ul><li><a href=#大雑把にやろうとしていること>大雑把にやろうとしていること</a><ul><li><a href=#シーケンス図>シーケンス図</a></li><li><a href=#メモリレイアウト再掲載>メモリレイアウト(再掲載)</a></li><li><a href=#main>main()</a></li><li><a href=#kinit1>kinit1()</a></li><li><a href=#freerange>freerange()</a></li><li><a href=#kfree>kfree()</a></li><li><a href=#kinit2>kinit2()</a></li><li><a href=#kalloc>kalloc()</a></li></ul></li></ul></li><li><a href=#code-sbrk>Code: sbrk</a><ul><li><ul><li><a href=#sys_sbrk>sys_sbrk()</a></li><li><a href=#growproc>growproc()</a></li><li><a href=#deallocuvm>deallocuvm()</a></li><li><a href=#allocuvm>allocuvm()</a></li></ul></li></ul></li><li><a href=#code-exec>Code: exec</a><ul><li><ul><li><a href=#loaduvm>loaduvm()</a></li></ul></li></ul></li></ul></nav></div></nav><div class=sidebar-profile><a class=sidebar-profile__name href=https://www.utam0k.jp/about/>Toru Komatsu</a><div class=sidebar-profile__links><a class=social-btn href=https://github.com/utam0k target=_blank rel="noopener noreferrer" aria-label=GitHub><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .5A12 12 0 008.21 23.9c.6.1.82-.26.82-.58.0-.29-.01-1.05-.02-2.06-3.34.73-4.04-1.61-4.04-1.61-.54-1.37-1.32-1.73-1.32-1.73-1.08-.74.08-.73.08-.73 1.19.08 1.81 1.22 1.81 1.22 1.06 1.8 2.79 1.28 3.47.98.1-.77.42-1.28.76-1.58-2.66-.3-5.47-1.34-5.47-5.95.0-1.32.47-2.4 1.24-3.25-.13-.3-.54-1.52.12-3.16.0.0 1.01-.32 3.3 1.24a11.5 11.5.0 016 0c2.28-1.56 3.29-1.24 3.29-1.24.66 1.64.25 2.86.12 3.16.77.85 1.23 1.93 1.23 3.25.0 4.62-2.81 5.64-5.49 5.94.43.37.81 1.11.81 2.24.0 1.62-.02 2.93-.02 3.33.0.32.21.7.83.58A12 12 0 0012 .5z"/></svg></a>
<a class=social-btn href=https://x.com/utam0k target=_blank rel="noopener noreferrer" aria-label="X (Twitter)"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h5.3l3.4 4.8L14.8 3H21l-6.8 9.2L21 21h-5.3L12 15.8 8.2 21H3l6.8-8.9L3 3z"/></svg></a></div></div><div class="share-block share-block--desktop"><div class=toc-share aria-label="Share this post"><button type=button class="share-btn share-btn--native" data-share-native data-share-url=https://www.utam0k.jp/blog/2019/04/25/xv6_pagetable_2/ data-share-title="詳解xv6 Page tables 2" aria-label=ネイティブ共有 hidden>
<svg viewBox="0 -960 960 960" aria-hidden="true"><path d="M680-80q-50 0-85-35t-35-85q0-6 3-28L282-392q-16 15-37 23.5t-45 8.5q-50 0-85-35t-35-85 35-85 85-35q24 0 45 8.5t37 23.5l281-164q-2-7-2.5-13.5T560-760q0-50 35-85t85-35 85 35 35 85-35 85-85 35q-24 0-45-8.5T598-672L317-508q2 7 2.5 13.5t.5 14.5-.5 14.5T317-452l281 164q16-15 37-23.5t45-8.5q50 0 85 35t35 85-35 85-85 35zm0-80q17 0 28.5-11.5T720-2e2t-11.5-28.5T680-240t-28.5 11.5T640-2e2t11.5 28.5T680-160zM2e2-440q17 0 28.5-11.5T240-480t-11.5-28.5T2e2-520t-28.5 11.5T160-480t11.5 28.5T2e2-440zm480-280q17 0 28.5-11.5T720-760t-11.5-28.5T680-8e2t-28.5 11.5T640-760t11.5 28.5T680-720zm0 520zM2e2-480zm480-280z"/></svg>
<span class=sr-only>共有</span>
</button>
<a class=share-btn href="https://twitter.com/intent/tweet?text=%e8%a9%b3%e8%a7%a3xv6%20Page%20tables%202&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f04%2f25%2fxv6_pagetable_2%2f" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h5.3l3.4 4.8L14.8 3H21l-6.8 9.2L21 21h-5.3L12 15.8 8.2 21H3l6.8-8.9L3 3z"/></svg>
<span class=sr-only>Share on X</span>
</a><a class=share-btn href="http://b.hatena.ne.jp/add?mode=confirm&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f04%2f25%2fxv6_pagetable_2%2f&title=%e8%a9%b3%e8%a7%a3xv6%20Page%20tables%202" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.47.0C22.42.0 24 1.58 24 3.53v16.94c0 1.95-1.58 3.53-3.53 3.53H3.53C1.58 24 0 22.42.0 20.47V3.53C0 1.58 1.58.0 3.53.0h16.94zM8.61 17.25c1.2.0 2.06-.04 2.58-.12.53-.08.98-.22 1.32-.41.45-.23.78-.56 1.02-.99.24-.43.36-.91.36-1.48.0-.78-.21-1.4-.63-1.87-.42-.48-.99-.74-1.74-.79.66-.18 1.16-.45 1.46-.81.32-.34.47-.82.47-1.42.0-.48-.1-.88-.3-1.26-.21-.36-.5-.65-.88-.87-.35-.2-.74-.32-1.22-.4-.46-.08-1.29-.12-2.48-.12H5.65v10.46H8.6zm.74-4.19c.7.0 1.18.09 1.44.27.27.18.4.5.4.93.0.4-.14.69-.42.86-.27.18-.76.25-1.44.25H8.31v-2.31h1.03zm8.66.71V6.71h-2.46v7.06h2.46zM8.93 9.08c.71.0 1.19.08 1.43.24.25.16.37.44.37.84.0.38-.13.65-.39.8-.27.16-.75.24-1.45.24h-.57V9.08h.61z"/></svg>
<span class=sr-only>はてなブックマーク</span>
</a><a class=share-btn href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2019%2f04%2f25%2fxv6_pagetable_2%2f&title=%e8%a9%b3%e8%a7%a3xv6%20Page%20tables%202" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.45 3.5H3.55A1.55 1.55.0 002 5.05v13.9A1.55 1.55.0 003.55 20.5h16.9A1.55 1.55.0 0022 18.95V5.05A1.55 1.55.0 0020.45 3.5zM7.14 18.1H4.54V9.88h2.6V18.1zm-1.3-9.36a1.51 1.51.0 110-3.02 1.51 1.51.0 010 3.02zM19 18.1h-2.6v-4.96c0-1.18-.42-1.99-1.48-1.99-.81.0-1.3.55-1.51 1.09-.08.19-.1.46-.1.73v5.13H10.7s.03-8.32.0-9.18h2.6v1.3c.35-.54.98-1.31 2.39-1.31 1.74.0 3.31 1.13 3.31 3.56V18.1z"/></svg>
<span class=sr-only>Share on LinkedIn</span></a></div></div></aside></div><button type=button class=mobile-toc-fab data-toc-modal=#mobile-toc-modal aria-pressed=false>
<span class=mobile-toc-fab__label>目次</span>
<svg class="mobile-toc-fab__icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 14l6-6 6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button></main><footer class=site-footer><div class=footer-meta><span>&copy; 2025 Toru Komatsu</span>
<a href=https://x.com/utam0k target=_blank rel=noopener class=muted>@utam0k</a></div><div class=footer-links><a class=muted href=https://www.utam0k.jp/index.xml>RSS</a>
<a class=muted href=https://github.com/utam0k target=_blank rel=noopener>GitHub</a></div></footer></div><script defer src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script defer type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script><script>(()=>{const e=()=>{const e=window.matchMedia("(max-width: 1024px)").matches,t=/Mobi|Android/i.test(navigator.userAgent),n=e||t;document.body.dataset.isMobile=n?"true":"false"};e(),window.addEventListener("resize",e,{passive:!0})})(),(()=>{const t=()=>Array.from(document.querySelectorAll("[data-toc-modal]")),n=()=>Array.from(document.querySelectorAll(".toc-modal")),u=()=>Array.from(document.querySelectorAll(".toc-modal__overlay")),r=e=>t().filter(t=>t.dataset.tocModal===`#${e?.id}`),s=(e,t)=>{r(e).forEach(e=>{e.classList.toggle("is-active",t),e.setAttribute("aria-pressed",t?"true":"false")})},c=e=>{if(!e)return;e.classList.add("is-open"),e.hidden=!1,document.body.classList.add("toc-open"),s(e,!0)},e=e=>{if(!e)return;e.style.transform="",e.classList.remove("is-open"),e.hidden=!0,document.body.classList.remove("toc-open"),s(e,!1)},o=()=>n().forEach(t=>e(t)),l=t=>{if(!t)return;t.classList.contains("is-open")?e(t):c(t)},i=()=>{t().forEach(e=>e.classList.add("is-visible"))},d=t=>{let n=0,s=0,o=!1;const i=80,a=e=>{const i=t.querySelector(".toc-modal__handle"),a=t.querySelector(".toc-modal__header"),r=i?.contains(e.target)||a?.contains(e.target),c=t.scrollTop<=0;if(!r&&!c)return;o=!0,n=e.touches[0].clientY,s=n,t.style.transition="none"},r=e=>{if(!o)return;s=e.touches[0].clientY;const i=s-n;i>0&&(t.style.transform=`translateY(${i}px)`,e.preventDefault())},c=()=>{if(!o)return;o=!1,t.style.transition="";const a=s-n;a>i?e(t):t.style.transform=""};t.addEventListener("touchstart",a,{passive:!0}),t.addEventListener("touchmove",r,{passive:!1}),t.addEventListener("touchend",c,{passive:!0})},a=()=>{t().forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tocModal,n=t?document.querySelector(t):null;l(n)})}),n().forEach(e=>d(e)),document.addEventListener("click",t=>{if(t.target?.classList?.contains("toc-modal__overlay")&&o(),t.target?.matches("[data-toc-close]")){const n=t.target.closest(".toc-modal");e(n)}t.target?.closest(".toc-modal")&&t.target.tagName==="A"&&o()}),window.addEventListener("scroll",i,{passive:!0}),i()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",a):a()})(),(()=>{const e=document.querySelector(".site-header");if(!e)return;const s=()=>document.body.dataset.isMobile==="true";if(s())return;let t=window.scrollY,n=!1;const o=8,i=()=>{const n=window.scrollY;if(n<80){e.classList.remove("is-hidden"),t=n;return}if(Math.abs(n-t)<o)return;n>t?e.classList.add("is-hidden"):e.classList.remove("is-hidden"),t=n};window.addEventListener("scroll",()=>{if(n)return;n=!0,requestAnimationFrame(()=>{i(),n=!1})},{passive:!0})})(),(()=>{const e=document.querySelector(".share-block--mobile");if(!e)return;const o=()=>document.body.dataset.isMobile==="true";let t=window.scrollY,s=!1;const i=4,a=80,r=()=>{if(e.classList.contains("is-floating"))return;e.classList.add("is-floating"),document.body.classList.add("has-mobile-share")},c=()=>{e.classList.remove("is-floating","is-visible"),document.body.classList.remove("has-mobile-share")},n=()=>{if(!o()){c();return}r();const n=window.scrollY;if(n<a){e.classList.add("is-visible"),t=n;return}if(Math.abs(n-t)<i)return;const s=n<t;s?e.classList.add("is-visible"):e.classList.remove("is-visible"),t=n};window.addEventListener("scroll",()=>{if(s)return;s=!0,requestAnimationFrame(()=>{n(),s=!1})},{passive:!0}),window.addEventListener("resize",n,{passive:!0}),window.addEventListener("orientationchange",n,{passive:!0}),n()})(),(()=>{const e=document.querySelector("[data-share-native]");if(!e)return;const n=e.dataset.shareUrl||location.href,s=e.dataset.shareTitle||document.title,o=()=>document.body.dataset.isMobile==="true",i=()=>{e.hidden=!1,e.addEventListener("click",async e=>{e.preventDefault();try{await navigator.share({title:s,url:n})}catch(e){if(e&&e.name==="AbortError")return;console.warn("Native share failed",e)}})},t=()=>{navigator.share&&o()?i():e.remove()};t(),window.addEventListener("resize",t,{passive:!0}),window.addEventListener("orientationchange",t,{passive:!0})})(),(()=>{const e=document.querySelector("[data-menu-toggle]"),s=document.getElementById("mobile-menu"),t=document.querySelector("[data-menu-overlay]");if(!e||!s)return;const i=()=>document.body.dataset.isMobile==="true",o=n=>{e.classList.toggle("is-open",n),e.setAttribute("aria-expanded",n?"true":"false"),s.hidden=!n,s.classList.toggle("is-open",n),t&&(t.hidden=!n,t.classList.toggle("is-open",n)),document.body.classList.toggle("menu-open",n)},a=()=>o(e.getAttribute("aria-expanded")!=="true"),n=()=>o(!1);e.addEventListener("click",e=>{e.stopPropagation(),a()}),document.querySelectorAll("[data-menu-close]").forEach(e=>e.addEventListener("click",n)),document.addEventListener("click",t=>{!s.contains(t.target)&&!e.contains(t.target)&&n()}),t&&t.addEventListener("click",n),document.addEventListener("keydown",e=>{e.key==="Escape"&&n()}),window.addEventListener("resize",()=>{i()||n()},{passive:!0})})()</script><script>(()=>{const s=Array.from(document.querySelectorAll(".toc__body a"));if(!s.length)return;const r=e=>decodeURIComponent(e.hash.replace("#","")),o=new Map;s.forEach(e=>{const t=r(e),n=o.get(t)||[];n.push(e),o.set(t,n)});const t=Array.from(new Set(s.map(e=>document.getElementById(r(e))).filter(Boolean)));if(!t.length)return;const i=e=>{o.forEach((t,n)=>{t.forEach(t=>t.classList.toggle("is-active",n===e))})},e=()=>{const n=window.scrollY+120;let e=t[0].id;for(const s of t)if(s.offsetTop<=n)e=s.id;else break;return i(e),e};let n=t[0].id;if(i(n),"IntersectionObserver"in window){const s=new Map,o=()=>{if(s.size){const e=Array.from(s.values()).sort((e,t)=>e.boundingClientRect.top-t.boundingClientRect.top)[0];n=e.target.id,i(n)}else n=e()},a=new IntersectionObserver(e=>{e.forEach(e=>{const t=e.target.id;e.isIntersecting?s.set(t,e):s.delete(t)}),o()},{rootMargin:"0px 0px -65% 0px",threshold:[0,.1,.5]});t.forEach(e=>a.observe(e)),window.addEventListener("load",o),window.addEventListener("resize",o,{passive:!0});return}let a=!1;const c=()=>{if(a)return;a=!0,requestAnimationFrame(()=>{e(),a=!1})};window.addEventListener("scroll",c,{passive:!0}),window.addEventListener("resize",e,{passive:!0}),window.addEventListener("load",e),document.querySelectorAll("img").forEach(t=>t.addEventListener("load",e,{once:!0})),e()})()</script><script>(()=>{const t=Array.from(document.querySelectorAll(".article-body img"));if(!t.length)return;const e=document.createElement("div");e.className="lightbox-backdrop",e.innerHTML='<img alt="">',document.body.appendChild(e);const n=e.querySelector("img"),s=()=>e.classList.remove("is-open");e.addEventListener("click",s),document.addEventListener("keydown",e=>{e.key==="Escape"&&s()}),t.forEach(t=>{t.addEventListener("click",()=>{n.src=t.src,n.alt=t.alt||"",e.classList.add("is-open")})})})()</script><script>(()=>{if(typeof gtag!="function")return;document.addEventListener("click",e=>{const t=e.target.closest("a[href]");if(!t)return;const n=new URL(t.href,location.origin);n.hostname!==location.hostname&&gtag("event","click",{event_category:"outbound",event_label:t.href,transport_type:"beacon"})});const d=[25,50,75,100],a=new Set,c=()=>{const t=window.scrollY,e=document.documentElement.scrollHeight-window.innerHeight;if(e<=0)return;const n=Math.round(t/e*100);d.forEach(e=>{n>=e&&!a.has(e)&&(a.add(e),gtag("event","scroll_depth",{event_category:"engagement",event_label:e+"%",value:e}))})};let n=!1;window.addEventListener("scroll",()=>{if(n)return;n=!0,requestAnimationFrame(()=>{c(),n=!1})},{passive:!0}),document.body.classList.contains("error404")&&gtag("event","page_not_found",{event_category:"error",event_label:location.pathname+location.search,page_referrer:document.referrer});const l=Date.now(),i=()=>{const e=Math.round((Date.now()-l)/1e3);e>5&&gtag("event","read_time",{event_category:"engagement",event_label:location.pathname,value:e})};window.addEventListener("beforeunload",i),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&i()}),document.addEventListener("click",e=>{const t=e.target.closest("a[href]");if(!t)return;const n=t.href,s=[{pattern:/github\.com\/utam0k/i,platform:"github"},{pattern:/x\.com\/utam0k|twitter\.com\/utam0k/i,platform:"x"},{pattern:/linkedin\.com\/in\/utam0k/i,platform:"linkedin"}];for(const{pattern:e,platform:t}of s)if(e.test(n)){gtag("event","author_social_click",{event_category:"engagement",event_label:t,link_url:n});break}}),document.addEventListener("click",e=>{const t=e.target.closest(".share-btn, [data-share], [data-share-native]");if(!t)return;const n=t.dataset.share||t.dataset.platform||t.getAttribute("aria-label")||"unknown";gtag("event","share",{event_category:"engagement",event_label:n.toLowerCase(),content_type:"article",item_id:location.pathname})});const t=document.referrer,s=new URLSearchParams(location.search),o=s.get("utm_source")||"",u=s.get("utm_medium")||"",h=s.get("utm_campaign")||"";let e="direct";if(o)e=o;else if(t)try{const n=new URL(t).hostname;/google\./i.test(n)?e="google":/bing\./i.test(n)?e="bing":/twitter\.com|x\.com/i.test(n)?e="x":/facebook\.com/i.test(n)?e="facebook":/linkedin\.com/i.test(n)?e="linkedin":/t\.co/i.test(n)?e="x":e=n}catch{e="referral"}gtag("event","traffic_source",{event_category:"acquisition",event_label:e,referrer:t||"direct",utm_source:o,utm_medium:u,utm_campaign:h}),document.addEventListener("copy",()=>{const e=window.getSelection()?.toString()||"";e.length>10&&gtag("event","text_copy",{event_category:"engagement",event_label:location.pathname,text_length:e.length})}),document.addEventListener("click",e=>{const t=e.target.closest("a[href]");if(!t)return;try{const e=new URL(t.href,location.origin);e.hostname===location.hostname&&e.pathname!==location.pathname&&gtag("event","internal_link",{event_category:"navigation",event_label:e.pathname,link_text:t.textContent?.trim().slice(0,50)||"",from_page:location.pathname})}catch{}});const r=window.__setTheme;r&&(window.__setTheme=e=>{r(e),gtag("event","theme_change",{event_category:"preference",event_label:e||document.documentElement.dataset.theme})}),document.addEventListener("click",e=>{const t=e.target.closest('.lang-choice, [data-lang], .meta-link[href*="/en/"], .meta-link[href*="/ja/"]');if(!t)return;const n=t.href||"",s=n.includes("/en/")?"en":"ja";gtag("event","language_switch",{event_category:"preference",event_label:s,from_lang:document.documentElement.lang||"unknown"})}),document.addEventListener("click",e=>{const t=e.target.closest(".toc a, .toc__body a");if(!t)return;gtag("event","toc_click",{event_category:"navigation",event_label:t.textContent?.trim().slice(0,50)||"",target_id:t.hash||""})}),document.addEventListener("click",e=>{const t=e.target.closest('a[href*="index.xml"], a[href*=".rss"], a[href*="/feed"]');if(!t)return;gtag("event","rss_click",{event_category:"engagement",event_label:location.pathname})}),window.addEventListener("beforeprint",()=>{gtag("event","page_print",{event_category:"engagement",event_label:location.pathname})})})()</script></body></html>