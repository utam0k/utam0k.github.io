<!doctype html><html><head><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-119773781-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>詳解xv6 Page tables 2 &ndash; うたもく</title><meta name=description property="og:description" content="|utam0k"><meta name=apple-mobile-web-app-title content="うたもく"><meta name=twitter:card content="summary"><meta name=twitter:site content="@utam0k"><meta name=twitter:creator content="@utam0k"><meta name=twitter:title content="詳解xv6 Page tables 2"><meta name=twitter:image content="https://www.utam0k.jp/img/logo.jpg"><link rel=stylesheet href=https://www.utam0k.jp/assets/syntax.css><link rel=stylesheet href=https://www.utam0k.jp/assets/primer-build.css><link rel=stylesheet href=https://www.utam0k.jp/assets/style.css><link rel=stylesheet href=https://www.utam0k.jp/assets/custom_style.css></head><body class=bg-gray><div id=holy class="container-lg bg-white h-100"><div id=header class="px-1 bg-white"><nav class="UnderlineNav UnderlineNav--right px-2"><a class="UnderlineNav-actions muted-link h2" href=https://www.utam0k.jp/>うたもく</a><div class=UnderlineNav-body><a class=UnderlineNav-item href=https://www.utam0k.jp/post/><span>Posts</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/page/about/><span>About</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/tags><span>Tags</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/en/><span>EN</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/index.xml><span>Atom</span></a></div></nav></div><div role=main id=main class="holy-main markdown-body px-4 bg-white"><div class=Subhead><div class=Subhead-heading><div class="h1 mt-3 mb-1">詳解xv6 Page tables 2</div></div><div class=Subhead-description><a href=https://www.utam0k.jp/tags/xv6 class=muted-link><span class="Label Label--gray">xv6</span></a>
<a href=https://www.utam0k.jp/tags/os class=muted-link><span class="Label Label--gray">os</span></a><div class=float-md-right><span title="Lastmod: 2019-04-25. Published at: 2019-04-25.">Published: 2019-04-25</span></div></div></div><article><section class="pb-6 mb-3 border-bottom"><p><a href=https://www.utam0k.jp/blog/2019/03/05/xv6_index/>詳解xv6の目次</a><br><a href=https://www.utam0k.jp/blog/2019/03/05/xv6_pagetable_1/>前の記事</a>
<a href=https://www.utam0k.jp/blog/2019/07/08/xv6_traps_interrupts_drivers_1/>次の記事</a></p><hr><h1 id=code-physical-memory-allocator>Code: Physical memory allocator</h1><h2 id=大雑把にやろうとしていること>大雑把にやろうとしていること</h2><ul><li>連結リスト<code>freelist</code>に物理メモリをページ単位で登録する。(<a href=#kinit1>kinit1()</a>, <a href=#kinit2>kinit2()</a>)<ul><li><p><code>kalloc.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>16</span> <span class=k>struct</span> <span class=n>run</span> <span class=p>{</span>
<span class=mi>17</span>   <span class=k>struct</span> <span class=n>run</span> <span class=o>*</span><span class=n>next</span><span class=p>;</span>
<span class=mi>18</span> <span class=p>};</span>
<span class=mi>19</span> 
<span class=mi>20</span> <span class=k>struct</span> <span class=p>{</span>
<span class=mi>21</span>   <span class=k>struct</span> <span class=n>spinlock</span> <span class=n>lock</span><span class=p>;</span>
<span class=mi>22</span>   <span class=kt>int</span> <span class=n>use_lock</span><span class=p>;</span>
<span class=mi>23</span>   <span class=k>struct</span> <span class=n>run</span> <span class=o>*</span><span class=n>freelist</span><span class=p>;</span>
<span class=mi>24</span> <span class=p>}</span> <span class=n>kmem</span><span class=p>;</span>
</code></pre></div></li></ul></li><li>メモリをほしい人に割り当てができるようにする。(<a href=#kalloc>kalloc()</a>)</li></ul><h3 id=シーケンス図>シーケンス図</h3><p>ざっくりとした流れです。
関数の中身をみていていま自分がどこにいるのかわからなくなったら適宜見るとよいかもしれません。</p><h3 id=メモリレイアウト再掲載>メモリレイアウト(再掲載)</h3><p><a href=https://www.utam0k.jp/blog/2019/03/05/xv6_pagetable_1/>前の記事</a>で説明したメモリレイアウトの図です。
本章でもかなり使うので載せておきます。適宜確認してください。</p><blockquote></blockquote><pre><code>&lt;img src=&quot;memorylayout.png&quot;/&gt; 
</code></pre><p>Source: <a href=https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf>commentary/textbook</a></p><p>VAとPAの関係表です。</p><table><thead><tr><th align=center>名前</th><th align=center>仮想アドレス</th><th align=center>物理アドレス</th></tr></thead><tbody><tr><td align=center>end</td><td align=center>end</td><td align=center>V2P(end)</td></tr><tr><td align=center>PHYSTOP</td><td align=center>P2V(PHYSTOP)</td><td align=center>PHYSTOP</td></tr><tr><td align=center>KERNBASE</td><td align=center>KERNBASE</td><td align=center>V2P(KERNBASE)</td></tr></tbody></table><h3 id=main>main()</h3><ul><li><p><code>main.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>17</span> <span class=kt>int</span>
<span class=mi>18</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=mi>19</span> <span class=p>{</span>
<span class=mi>20</span>   <span class=n>kinit1</span><span class=p>(</span><span class=n>end</span><span class=p>,</span> <span class=n>P2V</span><span class=p>(</span><span class=mi>4</span><span class=o>*</span><span class=mi>1024</span><span class=o>*</span><span class=mi>1024</span><span class=p>));</span> <span class=c1>// phys page allocator
</span><span class=c1></span><span class=mi>21</span>   <span class=n>kvmalloc</span><span class=p>();</span>      <span class=c1>// kernel page table
</span><span class=c1></span><span class=o>~~~</span>
<span class=mi>35</span>   <span class=n>kinit2</span><span class=p>(</span><span class=n>P2V</span><span class=p>(</span><span class=mi>4</span><span class=o>*</span><span class=mi>1024</span><span class=o>*</span><span class=mi>1024</span><span class=p>),</span> <span class=n>P2V</span><span class=p>(</span><span class=n>PHYSTOP</span><span class=p>));</span> <span class=c1>// must come after startothers()
</span><span class=c1></span>         <span class=o>~~~</span>
<span class=mi>38</span> <span class=p>}</span>
</code></pre></div><ul><li>L20: end~4MBまでをページアロケータに登録</li><li>L20までのPDTは<code>entrypgdir</code><ul><li><p><code>main.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c>  <span class=mi>97</span> <span class=c1>// The boot page table used in entry.S and entryother.S.
</span><span class=c1></span>  <span class=mi>98</span> <span class=c1>// Page directories (and page tables) must start on page boundaries,
</span><span class=c1></span>  <span class=mi>99</span> <span class=c1>// hence the __aligned__ attribute.
</span><span class=c1></span> <span class=mi>100</span> <span class=c1>// PTE_PS in a page directory entry enables 4Mbyte pages.
</span><span class=c1></span> <span class=mi>101</span>
 <span class=mi>102</span> <span class=n>__attribute__</span><span class=p>((</span><span class=n>__aligned__</span><span class=p>(</span><span class=n>PGSIZE</span><span class=p>)))</span>
 <span class=mi>103</span> <span class=n>pde_t</span> <span class=n>entrypgdir</span><span class=p>[</span><span class=n>NPDENTRIES</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
 <span class=mi>104</span>   <span class=c1>// Map VA&#39;s [0, 4MB) to PA&#39;s [0, 4MB)
</span><span class=c1></span> <span class=mi>105</span>   <span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>|</span> <span class=n>PTE_P</span> <span class=o>|</span> <span class=n>PTE_W</span> <span class=o>|</span> <span class=n>PTE_PS</span><span class=p>,</span>
 <span class=mi>106</span>   <span class=c1>// Map VA&#39;s [KERNBASE, KERNBASE+4MB) to PA&#39;s [0, 4MB)
</span><span class=c1></span> <span class=mi>107</span>   <span class=p>[</span><span class=n>KERNBASE</span><span class=o>&gt;&gt;</span><span class=n>PDXSHIFT</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>|</span> <span class=n>PTE_P</span> <span class=o>|</span> <span class=n>PTE_W</span> <span class=o>|</span> <span class=n>PTE_PS</span><span class=p>,</span>
 <span class=mi>108</span> <span class=p>};</span>
</code></pre></div><ul><li>L105: VA: [0 ~ 4MB)→ PA: [0 ~ 4MB)</li><li>L106: VA: [KERNBASE ~ KERNBASE+4MB)→ PA[0 ~ 4MB)<br>両方とも同じPAにマッピングしている</li></ul></li></ul></li><li>L21: カーネルのPDTを作成、設定</li><li>L22: 4MB~PHYSTOPまでをページアロケータに登録</li><li><a href=#kinit1>kinit1()</a>と<a href=#kinit2>kinit2()</a>の2回にわけてページアロケータに登録している理由<ul><li><code>entry.S</code>では物理アドレス0~4MBしかマッピングしていない(物理アドレス0~4MBまでしか使えない)</li><li><a href=#kinit1>kinit1()</a>と後で<code>kvmalloc()</code>を読んで本来のページングを行っている<ul><li><code>kvmalloc()</code>はメモリアロケータが必要(ブートストラップ問題)</li></ul></li><li><a href=#kinit2>kinit2()</a>で4MB以上も登録する</li></ul></li></ul></li></ul><h3 id=kinit1>kinit1()</h3><ul><li><p><code>kallo.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>26</span> <span class=c1>// Initialization happens in two phases.
</span><span class=c1></span><span class=mi>27</span> <span class=c1>// 1. main() calls kinit1() while still using entrypgdir to place just
</span><span class=c1></span><span class=mi>28</span> <span class=c1>// the pages mapped by entrypgdir on free list.
</span><span class=c1></span><span class=mi>29</span> <span class=c1>// 2. main() calls kinit2() with the rest of the physical pages
</span><span class=c1></span><span class=mi>30</span> <span class=c1>// after installing a full page table that maps them on all cores.
</span><span class=c1></span><span class=mi>31</span> <span class=kt>void</span>
<span class=mi>32</span> <span class=n>kinit1</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>vstart</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>vend</span><span class=p>)</span>
<span class=mi>33</span> <span class=p>{</span>
<span class=mi>34</span>   <span class=n>initlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>,</span> <span class=s>&#34;kmem&#34;</span><span class=p>);</span>
<span class=mi>35</span>   <span class=n>kmem</span><span class=p>.</span><span class=n>use_lock</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>36</span>   <span class=nf>freerange</span><span class=p>(</span><span class=n>vstart</span><span class=p>,</span> <span class=n>vend</span><span class=p>);</span>
<span class=mi>37</span> <span class=p>}</span>
</code></pre></div><ul><li><code>vstart</code>: end, <code>vend</code>: P2V(4<em>1024</em>1024)</li><li>L34 - 35: ロックを初期化してオフにする(詳細はLocking)<br>ロックを使用するにはメモリアロケータが必要になるのでまだ使えない</li><li>L36:<code> freelist</code>に領域(<code>vstart</code> ~ <code>vend</code>)を登録する</li></ul></li></ul><h3 id=freerange>freerange()</h3><ul><li><p><code>kalloc.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>46</span> <span class=kt>void</span>
<span class=mi>47</span> <span class=nf>freerange</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>vstart</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>vend</span><span class=p>)</span>
<span class=mi>48</span> <span class=p>{</span>
<span class=mi>49</span>   <span class=kt>char</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span>
<span class=mi>50</span>   <span class=n>p</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>PGROUNDUP</span><span class=p>((</span><span class=n>uint</span><span class=p>)</span><span class=n>vstart</span><span class=p>);</span>
<span class=mi>51</span>   <span class=k>for</span><span class=p>(;</span> <span class=n>p</span> <span class=o>+</span> <span class=n>PGSIZE</span> <span class=o>&lt;=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>vend</span><span class=p>;</span> <span class=n>p</span> <span class=o>+=</span> <span class=n>PGSIZE</span><span class=p>)</span>
<span class=mi>52</span>     <span class=n>kfree</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
<span class=mi>53</span> <span class=p>}</span>
</code></pre></div><ul><li>L50: <code>PGSIZE</code>に合わせてアライン</li><li>L51 - 52: ページサイズごとに<a href=#kfree>kfree()</a>を呼び出す</li></ul></li></ul><h3 id=kfree>kfree()</h3><p>引数のアドレス(ページの先頭アドレス)を<code>freelist</code>から消去</p><ul><li><p><code>kalloc.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>54</span> <span class=c1>//PAGEBREAK: 21
</span><span class=c1></span><span class=mi>55</span> <span class=c1>// Free the page of physical memory pointed at by v,
</span><span class=c1></span><span class=mi>56</span> <span class=c1>// which normally should have been returned by a
</span><span class=c1></span><span class=mi>57</span> <span class=c1>// call to kalloc().  (The exception is when
</span><span class=c1></span><span class=mi>58</span> <span class=c1>// initializing the allocator; see kinit above.)
</span><span class=c1></span><span class=mi>59</span> <span class=kt>void</span>
<span class=mi>60</span> <span class=n>kfree</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>v</span><span class=p>)</span>
<span class=mi>61</span> <span class=p>{</span>
<span class=mi>62</span>   <span class=k>struct</span> <span class=n>run</span> <span class=o>*</span><span class=n>r</span><span class=p>;</span>
<span class=mi>63</span>
<span class=mi>64</span>   <span class=nf>if</span><span class=p>((</span><span class=n>uint</span><span class=p>)</span><span class=n>v</span> <span class=o>%</span> <span class=n>PGSIZE</span> <span class=o>||</span> <span class=n>v</span> <span class=o>&lt;</span> <span class=n>end</span> <span class=o>||</span> <span class=n>V2P</span><span class=p>(</span><span class=n>v</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>PHYSTOP</span><span class=p>)</span>
<span class=mi>65</span>     <span class=n>panic</span><span class=p>(</span><span class=s>&#34;kfree&#34;</span><span class=p>);</span>
<span class=mi>66</span>
<span class=mi>67</span>   <span class=c1>// Fill with junk to catch dangling refs.
</span><span class=c1></span><span class=mi>68</span>   <span class=n>memset</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>);</span>
<span class=mi>69</span>
<span class=mi>70</span>   <span class=nf>if</span><span class=p>(</span><span class=n>kmem</span><span class=p>.</span><span class=n>use_lock</span><span class=p>)</span>
<span class=mi>71</span>     <span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
<span class=mi>72</span>   <span class=n>r</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>run</span><span class=o>*</span><span class=p>)</span><span class=n>v</span><span class=p>;</span>
<span class=mi>73</span>   <span class=n>r</span><span class=o>-&gt;</span><span class=n>next</span> <span class=o>=</span> <span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span><span class=p>;</span>
<span class=mi>74</span>   <span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span> <span class=o>=</span> <span class=n>r</span><span class=p>;</span>
<span class=mi>75</span>   <span class=nf>if</span><span class=p>(</span><span class=n>kmem</span><span class=p>.</span><span class=n>use_lock</span><span class=p>)</span>
<span class=mi>76</span>     <span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
<span class=mi>77</span> <span class=p>}</span>
</code></pre></div><ul><li>L64: エラーチェック<br>開始のアドレス(<code>v</code>)が<code>PGSIZE</code>の倍数であるか
<code>v</code>がFree memory(end ~ P2V(PHYSTOP)の範囲)であるか</li><li>L68: v+PAGESIZEまで1で埋める</li><li>L72 ~ 74: vを<code>freelist</code>に登録</li><li>L70 ~ 71, L75 ~ 76: 詳しくはLockingで<br><code>freelist</code>を変更中にほかのスレッドに変更されるとリストが壊れるため</li></ul></li></ul><h3 id=kinit2>kinit2()</h3><ul><li><p><code>kalloc.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>39</span> <span class=kt>void</span>
<span class=mi>40</span> <span class=nf>kinit2</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>vstart</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>vend</span><span class=p>)</span>
<span class=mi>41</span> <span class=p>{</span>
<span class=mi>42</span>   <span class=n>freerange</span><span class=p>(</span><span class=n>vstart</span><span class=p>,</span> <span class=n>vend</span><span class=p>);</span>
<span class=mi>43</span>   <span class=n>kmem</span><span class=p>.</span><span class=n>use_lock</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
<span class=mi>44</span> <span class=p>}</span>
</code></pre></div><ul><li>L42: 4MB~PHYSTOPまでの物理アドレス空間をフリーリストに登録</li><li>L44: 詳しくはLockingで<br>ロックを有効化</li></ul></li></ul><h3 id=kalloc>kalloc()</h3><p>物理メモリ(PGSIZE分)提供</p><ul><li><p><code>kalloc.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>79</span> <span class=c1>// Allocate one 4096-byte page of physical memory.
</span><span class=c1></span><span class=mi>80</span> <span class=c1>// Returns a pointer that the kernel can use.
</span><span class=c1></span><span class=mi>81</span> <span class=c1>// Returns 0 if the memory cannot be allocated.
</span><span class=c1></span><span class=mi>82</span> <span class=kt>char</span><span class=o>*</span>
<span class=mi>83</span> <span class=n>kalloc</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=mi>84</span> <span class=p>{</span>
<span class=mi>85</span>   <span class=k>struct</span> <span class=n>run</span> <span class=o>*</span><span class=n>r</span><span class=p>;</span>
<span class=mi>86</span>
<span class=mi>87</span>   <span class=nf>if</span><span class=p>(</span><span class=n>kmem</span><span class=p>.</span><span class=n>use_lock</span><span class=p>)</span>
<span class=mi>88</span>     <span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
<span class=mi>89</span>   <span class=n>r</span> <span class=o>=</span> <span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span><span class=p>;</span>
<span class=mi>90</span>   <span class=nf>if</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
<span class=mi>91</span>     <span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span> <span class=o>=</span> <span class=n>r</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
<span class=mi>92</span>   <span class=nf>if</span><span class=p>(</span><span class=n>kmem</span><span class=p>.</span><span class=n>use_lock</span><span class=p>)</span>
<span class=mi>93</span>     <span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
<span class=mi>94</span>   <span class=nf>return</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>r</span><span class=p>;</span>
<span class=mi>95</span> <span class=p>}</span>
</code></pre></div><ul><li>L89 - 91: <code>freelist</code>から1つ取り出す</li><li>L87 - 88, L92- 93: 詳しくはLockingで</li></ul></li></ul><h1 id=code-sbrk>Code: sbrk</h1><h3 id=sys_sbrk>sys_sbrk()</h3><p>実行中のプロセスのメモリのサイズを増やしたり減らしたりするシステムコール</p><ul><li><p><code>sysproc.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>45</span> <span class=kt>int</span>
<span class=mi>46</span> <span class=nf>sys_sbrk</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=mi>47</span> <span class=p>{</span>
<span class=mi>48</span>   <span class=kt>int</span> <span class=n>addr</span><span class=p>;</span>
<span class=mi>49</span>   <span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
<span class=mi>50</span>
<span class=mi>51</span>   <span class=k>if</span><span class=p>(</span><span class=n>argint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>n</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>52</span>     <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
<span class=mi>53</span>   <span class=n>addr</span> <span class=o>=</span> <span class=n>myproc</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>;</span>
<span class=mi>54</span>   <span class=k>if</span><span class=p>(</span><span class=n>growproc</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>55</span>     <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
<span class=mi>56</span>   <span class=k>return</span> <span class=n>addr</span><span class=p>;</span>
<span class=mi>57</span> <span class=p>}</span>
</code></pre></div><ul><li>L51 - 52: 引数の処理(詳細は後の章)</li><li>L54: メモリを増やす(<a href=#growproc>growproc()</a>)</li></ul></li></ul><h3 id=growproc>growproc()</h3><p>実行中のプロセスに割り当てるメモリを増やす。
つまり、ページングの設定を追加する</p><ul><li><p><code>proc.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>156</span> <span class=c1>// Grow current process&#39;s memory by n bytes.
</span><span class=c1></span><span class=mi>157</span> <span class=c1>// Return 0 on success, -1 on failure.
</span><span class=c1></span><span class=mi>158</span> <span class=kt>int</span>
<span class=mi>159</span> <span class=n>growproc</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>)</span>
<span class=mi>160</span> <span class=p>{</span>
<span class=mi>161</span>   <span class=n>uint</span> <span class=n>sz</span><span class=p>;</span>
<span class=mi>162</span>   <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>curproc</span> <span class=o>=</span> <span class=n>myproc</span><span class=p>();</span>
<span class=mi>163</span>
<span class=mi>164</span>   <span class=n>sz</span> <span class=o>=</span> <span class=n>curproc</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>;</span>
<span class=mi>165</span>   <span class=nf>if</span><span class=p>(</span><span class=n>n</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>){</span>
<span class=mi>166</span>     <span class=k>if</span><span class=p>((</span><span class=n>sz</span> <span class=o>=</span> <span class=n>allocuvm</span><span class=p>(</span><span class=n>curproc</span><span class=o>-&gt;</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>sz</span> <span class=o>+</span> <span class=n>n</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>167</span>       <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
<span class=mi>168</span>   <span class=p>}</span> <span class=k>else</span> <span class=nf>if</span><span class=p>(</span><span class=n>n</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>){</span>
<span class=mi>169</span>     <span class=k>if</span><span class=p>((</span><span class=n>sz</span> <span class=o>=</span> <span class=n>deallocuvm</span><span class=p>(</span><span class=n>curproc</span><span class=o>-&gt;</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>sz</span> <span class=o>+</span> <span class=n>n</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>170</span>       <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
<span class=mi>171</span>   <span class=p>}</span>
<span class=mi>172</span>   <span class=n>curproc</span><span class=o>-&gt;</span><span class=n>sz</span> <span class=o>=</span> <span class=n>sz</span><span class=p>;</span>
<span class=mi>173</span>   <span class=nf>switchuvm</span><span class=p>(</span><span class=n>curproc</span><span class=p>);</span>
<span class=mi>174</span>   <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>175</span> <span class=p>}</span>
</code></pre></div><ul><li>L162: 実行中のプロセスの取得</li><li>L165 - 167: 割り当てているメモリを増やす場合(<a href=#allocuvm>allocuvm()</a>)</li><li>L168 - 171: 割り当てているメモリを減らす場合(<a href=#deallocuvm>deallocuvm()</a>)</li></ul></li></ul><h3 id=deallocuvm>deallocuvm()</h3><p>割り当てている物理メモリを<code>freelist</code>から消去</p><ul><li><p><code>vm.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>251</span> <span class=c1>// Deallocate user pages to bring the process size from oldsz to
</span><span class=c1></span><span class=mi>252</span> <span class=c1>// newsz.  oldsz and newsz need not be page-aligned, nor does newsz
</span><span class=c1></span><span class=mi>253</span> <span class=c1>// need to be less than oldsz.  oldsz can be larger than the actual
</span><span class=c1></span><span class=mi>254</span> <span class=c1>// process size.  Returns the new process size.
</span><span class=c1></span><span class=mi>255</span> <span class=kt>int</span>
<span class=mi>256</span> <span class=n>deallocuvm</span><span class=p>(</span><span class=n>pde_t</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>uint</span> <span class=n>oldsz</span><span class=p>,</span> <span class=n>uint</span> <span class=n>newsz</span><span class=p>)</span>
<span class=mi>257</span> <span class=p>{</span>
<span class=mi>258</span>   <span class=n>pte_t</span> <span class=o>*</span><span class=n>pte</span><span class=p>;</span>
<span class=mi>259</span>   <span class=n>uint</span> <span class=n>a</span><span class=p>,</span> <span class=n>pa</span><span class=p>;</span>
<span class=mi>260</span>
<span class=mi>261</span>   <span class=nf>if</span><span class=p>(</span><span class=n>newsz</span> <span class=o>&gt;=</span> <span class=n>oldsz</span><span class=p>)</span>
<span class=mi>262</span>     <span class=k>return</span> <span class=n>oldsz</span><span class=p>;</span>
<span class=mi>263</span>
<span class=mi>264</span>   <span class=n>a</span> <span class=o>=</span> <span class=n>PGROUNDUP</span><span class=p>(</span><span class=n>newsz</span><span class=p>);</span>
<span class=mi>265</span>   <span class=k>for</span><span class=p>(;</span> <span class=n>a</span>  <span class=o>&lt;</span> <span class=n>oldsz</span><span class=p>;</span> <span class=n>a</span> <span class=o>+=</span> <span class=n>PGSIZE</span><span class=p>){</span>
<span class=mi>266</span>     <span class=n>pte</span> <span class=o>=</span> <span class=n>walkpgdir</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>a</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
<span class=mi>267</span>     <span class=nf>if</span><span class=p>(</span><span class=o>!</span><span class=n>pte</span><span class=p>)</span>
<span class=mi>268</span>       <span class=n>a</span> <span class=o>=</span> <span class=n>PGADDR</span><span class=p>(</span><span class=n>PDX</span><span class=p>(</span><span class=n>a</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>-</span> <span class=n>PGSIZE</span><span class=p>;</span>
<span class=mi>269</span>     <span class=k>else</span> <span class=nf>if</span><span class=p>((</span><span class=o>*</span><span class=n>pte</span> <span class=o>&amp;</span> <span class=n>PTE_P</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>){</span>
<span class=mi>270</span>       <span class=n>pa</span> <span class=o>=</span> <span class=n>PTE_ADDR</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>);</span>
<span class=mi>271</span>       <span class=k>if</span><span class=p>(</span><span class=n>pa</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>272</span>         <span class=n>panic</span><span class=p>(</span><span class=s>&#34;kfree&#34;</span><span class=p>);</span>
<span class=mi>273</span>       <span class=kt>char</span> <span class=o>*</span><span class=n>v</span> <span class=o>=</span> <span class=n>P2V</span><span class=p>(</span><span class=n>pa</span><span class=p>);</span>
<span class=mi>274</span>       <span class=n>kfree</span><span class=p>(</span><span class=n>v</span><span class=p>);</span>
<span class=mi>275</span>       <span class=o>*</span><span class=n>pte</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>276</span>     <span class=p>}</span>
<span class=mi>277</span>   <span class=p>}</span>
<span class=mi>278</span>   <span class=k>return</span> <span class=n>newsz</span><span class=p>;</span>
<span class=mi>279</span> <span class=p>}</span>
</code></pre></div><ul><li><p>L264: <code>PGSIZE</code>にそろえる</p></li><li><p>L266: 該当のPTEの捜索</p><ul><li>ユーザの仮想アドレスは0からスタートしているので<code>oldsz</code>や<code>newsz</code>はそのまま仮想アドレスを示す</li><li>もし、なかった場合に<a href=https://www.utam0k.jp/blog/2019/03/05/xv6_pagetable_1/#walkpgdir>walkpgidr()</a>が割り当てることはしない(3個目の引数が0であるため)</li></ul></li><li><p>L267 - 268: 該当のPTEが存在していなかった場合</p><ul><li><code>PDX(a) + 1</code>: 仮想アドレス<code>a</code>が対応付けられているPDE(<code>PDE_a</code>)のインデックス + 1</li><li><code>PGADDR(PDX(a) + 1, 0, 0) - PGSIZE</code>: <code>PDE_a</code>の次のPDEが対応付けている先頭の仮想アドレス - <code>PGSIZE</code><ul><li><code>PGSIZE</code>が引かれているのは次のfor分で<code>a += PGSIZE</code>されるため</li></ul></li></ul></li><li><p>L269 - 275: 該当するPTEが存在していた<br><code>PTE_P</code>: ページが物理メモリに存在しているかどうか(物理メモリが割り当てられているかどうか)</p></li><li><p>L270: ページの先頭物理アドレス</p><ul><li><p><code>mmu.h</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c> <span class=mi>99</span> <span class=c1>// Address in page table or page directory entry
</span><span class=c1></span><span class=mi>100</span> <span class=err>#</span><span class=n>define</span> <span class=n>PTE_ADDR</span><span class=p>(</span><span class=n>pte</span><span class=p>)</span>   <span class=p>((</span><span class=n>uint</span><span class=p>)(</span><span class=n>pte</span><span class=p>)</span> <span class=o>&amp;</span> <span class=o>~</span><span class=mh>0xFFF</span><span class=p>)</span>
<span class=mi>101</span> <span class=err>#</span><span class=n>define</span> <span class=n>PTE_FLAGS</span><span class=p>(</span><span class=n>pte</span><span class=p>)</span>  <span class=p>((</span><span class=n>uint</span><span class=p>)(</span><span class=n>pte</span><span class=p>)</span> <span class=o>&amp;</span>  <span class=mh>0xFFF</span><span class=p>)</span>     
</code></pre></div></li></ul></li><li><p>L271 - 272, L275: 初期化されたPTEは0なので0だった場合はエラー</p></li><li><p>L273: 物理メモリの管理(<code>freelist</code>)はカーネル領域で管理しているので<code>P2V()</code>が使える</p></li><li><p>L274: 物理メモリの使用を解放</p></li></ul></li></ul><h3 id=allocuvm>allocuvm()</h3><p>新しく物理メモリを割り当てる</p><ul><li><p><code>vm.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>219</span> <span class=c1>// Allocate page tables and physical memory to grow process from oldsz to
</span><span class=c1></span><span class=mi>220</span> <span class=c1>// newsz, which need not be page aligned.  Returns new size or 0 on error.
</span><span class=c1></span><span class=mi>221</span> <span class=kt>int</span>
<span class=mi>222</span> <span class=n>allocuvm</span><span class=p>(</span><span class=n>pde_t</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>uint</span> <span class=n>oldsz</span><span class=p>,</span> <span class=n>uint</span> <span class=n>newsz</span><span class=p>)</span>
<span class=mi>223</span> <span class=p>{</span>
<span class=mi>224</span>   <span class=kt>char</span> <span class=o>*</span><span class=n>mem</span><span class=p>;</span>
<span class=mi>225</span>   <span class=n>uint</span> <span class=n>a</span><span class=p>;</span>
<span class=mi>226</span>
<span class=mi>227</span>   <span class=nf>if</span><span class=p>(</span><span class=n>newsz</span> <span class=o>&gt;=</span> <span class=n>KERNBASE</span><span class=p>)</span>
<span class=mi>228</span>     <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>229</span>   <span class=nf>if</span><span class=p>(</span><span class=n>newsz</span> <span class=o>&lt;</span> <span class=n>oldsz</span><span class=p>)</span>
<span class=mi>230</span>     <span class=k>return</span> <span class=n>oldsz</span><span class=p>;</span>
<span class=mi>231</span>
<span class=mi>232</span>   <span class=n>a</span> <span class=o>=</span> <span class=n>PGROUNDUP</span><span class=p>(</span><span class=n>oldsz</span><span class=p>);</span>
<span class=mi>233</span>   <span class=k>for</span><span class=p>(;</span> <span class=n>a</span> <span class=o>&lt;</span> <span class=n>newsz</span><span class=p>;</span> <span class=n>a</span> <span class=o>+=</span> <span class=n>PGSIZE</span><span class=p>){</span>
<span class=mi>234</span>     <span class=n>mem</span> <span class=o>=</span> <span class=n>kalloc</span><span class=p>();</span>
<span class=mi>235</span>     <span class=nf>if</span><span class=p>(</span><span class=n>mem</span> <span class=o>==</span> <span class=mi>0</span><span class=p>){</span>
<span class=mi>236</span>       <span class=n>cprintf</span><span class=p>(</span><span class=s>&#34;allocuvm out of memory</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
<span class=mi>237</span>       <span class=n>deallocuvm</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>newsz</span><span class=p>,</span> <span class=n>oldsz</span><span class=p>);</span>
<span class=mi>238</span>       <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>239</span>     <span class=p>}</span>
<span class=mi>240</span>     <span class=nf>memset</span><span class=p>(</span><span class=n>mem</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>);</span>
<span class=mi>241</span>     <span class=nf>if</span><span class=p>(</span><span class=n>mappages</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>a</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>,</span> <span class=n>V2P</span><span class=p>(</span><span class=n>mem</span><span class=p>),</span> <span class=n>PTE_W</span><span class=o>|</span><span class=n>PTE_U</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>){</span>
<span class=mi>242</span>       <span class=n>cprintf</span><span class=p>(</span><span class=s>&#34;allocuvm out of memory (2)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
<span class=mi>243</span>       <span class=n>deallocuvm</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>newsz</span><span class=p>,</span> <span class=n>oldsz</span><span class=p>);</span>
<span class=mi>244</span>       <span class=n>kfree</span><span class=p>(</span><span class=n>mem</span><span class=p>);</span>
<span class=mi>245</span>       <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>246</span>     <span class=p>}</span>
<span class=mi>247</span>   <span class=p>}</span>
<span class=mi>248</span>   <span class=k>return</span> <span class=n>newsz</span><span class=p>;</span>
<span class=mi>249</span> <span class=p>}</span>
</code></pre></div><ul><li>L227 - 230: エラーチェック</li><li>L232: PGSIZEにアライメント</li><li>L233 - 247: PGSIZE毎に必要なだけ割り当てる</li><li>L234: 割り当てる物理メモリの先頭アドレス取得(PGSIZE分)<ul><li><a href=#kalloc>kalloc()</a></li></ul></li><li>L234 - 239: もう割り当てるメモリがなかった場合</li><li>L240: 0で初期化</li><li>L241 - 246: 仮想アドレスと取得した物理メモリをマッピング<ul><li><a href=https://www.utam0k.jp/blog/2019/03/05/xv6_pagetable_1/#mappages>mappages()</a></li><li><a href=#deallocuvm>deallocuvm()</a></li><li><a href=#kfree>kfree()</a></li></ul></li></ul></li></ul><h1 id=code-exec>Code: exec</h1><p>ユーザのカーネル空間を作るシステムコール</p><ul><li><p><code>exec.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>10</span> <span class=kt>int</span>
<span class=mi>11</span> <span class=nf>exec</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>path</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span>
<span class=mi>12</span> <span class=p>{</span>
<span class=mi>13</span>   <span class=kt>char</span> <span class=o>*</span><span class=n>s</span><span class=p>,</span> <span class=o>*</span><span class=n>last</span><span class=p>;</span>
<span class=mi>14</span>   <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>off</span><span class=p>;</span>
<span class=mi>15</span>   <span class=n>uint</span> <span class=n>argc</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>sp</span><span class=p>,</span> <span class=n>ustack</span><span class=p>[</span><span class=mi>3</span><span class=o>+</span><span class=n>MAXARG</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
<span class=mi>16</span>   <span class=k>struct</span> <span class=n>elfhdr</span> <span class=n>elf</span><span class=p>;</span>
<span class=mi>17</span>   <span class=k>struct</span> <span class=n>inode</span> <span class=o>*</span><span class=n>ip</span><span class=p>;</span>
<span class=mi>18</span>   <span class=k>struct</span> <span class=n>proghdr</span> <span class=n>ph</span><span class=p>;</span>
<span class=mi>19</span>   <span class=n>pde_t</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>,</span> <span class=o>*</span><span class=n>oldpgdir</span><span class=p>;</span>
<span class=mi>20</span>   <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>curproc</span> <span class=o>=</span> <span class=n>myproc</span><span class=p>();</span>
     <span class=o>~~~</span> <span class=n>pathをもとに該当するinodeを取得</span>
<span class=mi>30</span>   <span class=n>pgdir</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>31</span>
<span class=mi>32</span>   <span class=c1>// Check ELF header
</span><span class=c1></span>     <span class=o>~~~</span>  <span class=n>ELFがエラーかチェック</span>
<span class=mi>38</span>   <span class=k>if</span><span class=p>((</span><span class=n>pgdir</span> <span class=o>=</span> <span class=n>setupkvm</span><span class=p>())</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>39</span>     <span class=k>goto</span> <span class=n>bad</span><span class=p>;</span>
<span class=mi>40</span>
<span class=mi>41</span>   <span class=c1>// Load program into memory.
</span><span class=c1></span><span class=mi>42</span>   <span class=n>sz</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>43</span>   <span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>off</span><span class=o>=</span><span class=n>elf</span><span class=p>.</span><span class=n>phoff</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>elf</span><span class=p>.</span><span class=n>phnum</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>,</span> <span class=n>off</span><span class=o>+=</span><span class=k>sizeof</span><span class=p>(</span><span class=n>ph</span><span class=p>)){</span>
<span class=mi>44</span>     <span class=k>if</span><span class=p>(</span><span class=n>readi</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>ph</span><span class=p>,</span> <span class=n>off</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>ph</span><span class=p>))</span> <span class=o>!=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>ph</span><span class=p>))</span>
<span class=mi>45</span>       <span class=k>goto</span> <span class=n>bad</span><span class=p>;</span>
    <span class=o>~~~</span> <span class=err>エラーチェック</span>
<span class=mi>52</span>     <span class=k>if</span><span class=p>((</span><span class=n>sz</span> <span class=o>=</span> <span class=n>allocuvm</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>ph</span><span class=p>.</span><span class=n>vaddr</span> <span class=o>+</span> <span class=n>ph</span><span class=p>.</span><span class=n>memsz</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>53</span>       <span class=k>goto</span> <span class=n>bad</span><span class=p>;</span>
<span class=mi>54</span>     <span class=k>if</span><span class=p>(</span><span class=n>ph</span><span class=p>.</span><span class=n>vaddr</span> <span class=o>%</span> <span class=n>PGSIZE</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>55</span>       <span class=k>goto</span> <span class=n>bad</span><span class=p>;</span>
<span class=mi>56</span>     <span class=k>if</span><span class=p>(</span><span class=n>loaduvm</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>ph</span><span class=p>.</span><span class=n>vaddr</span><span class=p>,</span> <span class=n>ip</span><span class=p>,</span> <span class=n>ph</span><span class=p>.</span><span class=n>off</span><span class=p>,</span> <span class=n>ph</span><span class=p>.</span><span class=n>filesz</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>57</span>       <span class=k>goto</span> <span class=n>bad</span><span class=p>;</span>
<span class=mi>58</span>   <span class=p>}</span>
     <span class=o>~~~</span>
<span class=mi>63</span>   <span class=c1>// Allocate two pages at the next page boundary.
</span><span class=c1></span><span class=mi>64</span>   <span class=c1>// Make the first inaccessible.  Use the second as the user stack.
</span><span class=c1></span><span class=mi>65</span>   <span class=n>sz</span> <span class=o>=</span> <span class=n>PGROUNDUP</span><span class=p>(</span><span class=n>sz</span><span class=p>);</span>
<span class=mi>66</span>   <span class=k>if</span><span class=p>((</span><span class=n>sz</span> <span class=o>=</span> <span class=n>allocuvm</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>sz</span> <span class=o>+</span> <span class=mi>2</span><span class=o>*</span><span class=n>PGSIZE</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>67</span>     <span class=k>goto</span> <span class=n>bad</span><span class=p>;</span>
<span class=mi>68</span>   <span class=n>clearpteu</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)(</span><span class=n>sz</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>PGSIZE</span><span class=p>));</span>
<span class=mi>69</span>   <span class=n>sp</span> <span class=o>=</span> <span class=n>sz</span><span class=p>;</span>
<span class=mi>70</span>
<span class=mi>71</span>   <span class=c1>// Push argument strings, prepare rest of stack in ustack.
</span><span class=c1></span>     <span class=o>~~~</span> <span class=err>引数などのスタックを設定</span>
<span class=mi>90</span>   <span class=c1>// Save program name for debugging.
</span><span class=c1></span>     <span class=o>~~~</span> <span class=err>デバッグ用の諸々</span>
<span class=mi>95</span>
<span class=mi>96</span>   <span class=c1>// Commit to the user image.
</span><span class=c1></span><span class=mi>97</span>   <span class=n>oldpgdir</span> <span class=o>=</span> <span class=n>curproc</span><span class=o>-&gt;</span><span class=n>pgdir</span><span class=p>;</span>
<span class=mi>98</span>   <span class=n>curproc</span><span class=o>-&gt;</span><span class=n>pgdir</span> <span class=o>=</span> <span class=n>pgdir</span><span class=p>;</span>
     <span class=o>~~~</span> <span class=err>諸々</span><span class=n>curprocの設定</span>
<span class=mi>102</span>   <span class=n>switchuvm</span><span class=p>(</span><span class=n>curproc</span><span class=p>);</span>
<span class=mi>103</span>   <span class=n>freevm</span><span class=p>(</span><span class=n>oldpgdir</span><span class=p>);</span>
<span class=mi>104</span>   <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>105</span>
<span class=mi>106</span>  <span class=nl>bad</span><span class=p>:</span>
     <span class=o>~~~</span> <span class=err>エラー時の処理</span>
</code></pre></div><ul><li>L38: カーネル空間のメモリをマッピング</li><li>L43 - 58: ELFのセグメント毎にメモリにロード</li><li>L52: 物理メモリの割り当てる<br><code>sz</code>: oldsize<br><code>ph.vaddr + ph.memsz</code>: newsize</li><li>L56: <code>ip</code>(inode)をELFを元に所定の仮想アドレスに展開(<a href=#loaduvm>loaduvm()</a>)</li><li>L65 - 67: サイズがでかすぎる引数(ページを跨ぐサイズ)をきちんとエラーとして扱うために2ページ分を割り当てる</li><li>L68: ユーザモードではアクセスできなくする<ul><li><p><code>vm.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>300</span> <span class=c1>// Clear PTE_U on a page. Used to create an inaccessible
</span><span class=c1></span><span class=mi>301</span> <span class=c1>// page beneath the user stack.
</span><span class=c1></span><span class=mi>302</span> <span class=kt>void</span>
<span class=mi>303</span> <span class=n>clearpteu</span><span class=p>(</span><span class=n>pde_t</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>uva</span><span class=p>)</span>
<span class=mi>304</span> <span class=p>{</span>
<span class=mi>305</span>   <span class=n>pte_t</span> <span class=o>*</span><span class=n>pte</span><span class=p>;</span>
<span class=mi>306</span>
<span class=mi>307</span>   <span class=n>pte</span> <span class=o>=</span> <span class=n>walkpgdir</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>uva</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
<span class=mi>308</span>   <span class=nf>if</span><span class=p>(</span><span class=n>pte</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>309</span>     <span class=n>panic</span><span class=p>(</span><span class=s>&#34;clearpteu&#34;</span><span class=p>);</span>
<span class=mi>310</span>   <span class=o>*</span><span class=n>pte</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>PTE_U</span><span class=p>;</span>
<span class=mi>311</span> <span class=p>}</span>
</code></pre></div><ul><li><a href=https://www.utam0k.jp/blog/2019/03/05/xv6_pagetable_1/#walkpgdir>walkpgidr()</a></li></ul></li></ul></li><li>L97, 103: 元々割り当てていた物理メモリを解放</li><li>L98: 新しく設定したページングを割り当てる</li><li>L102: 新しく設定したページテーブルに切り替える</li></ul></li></ul><h3 id=loaduvm>loaduvm()</h3><p>メモリ上にinodeのデータを展開</p><ul><li><p><code>vm.c</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=mi>195</span> <span class=c1>// Load a program segment into pgdir.  addr must be page-aligned
</span><span class=c1></span><span class=mi>196</span> <span class=c1>// and the pages from addr to addr+sz must already be mapped.
</span><span class=c1></span><span class=mi>197</span> <span class=kt>int</span>
<span class=mi>198</span> <span class=n>loaduvm</span><span class=p>(</span><span class=n>pde_t</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>addr</span><span class=p>,</span> <span class=k>struct</span> <span class=n>inode</span> <span class=o>*</span><span class=n>ip</span><span class=p>,</span> <span class=n>uint</span> <span class=n>offset</span><span class=p>,</span> <span class=n>uint</span> <span class=n>sz</span><span class=p>)</span>
<span class=mi>199</span> <span class=p>{</span>
<span class=mi>200</span>   <span class=n>uint</span> <span class=n>i</span><span class=p>,</span> <span class=n>pa</span><span class=p>,</span> <span class=n>n</span><span class=p>;</span>
<span class=mi>201</span>   <span class=n>pte_t</span> <span class=o>*</span><span class=n>pte</span><span class=p>;</span>
<span class=mi>202</span>
<span class=mi>203</span>   <span class=nf>if</span><span class=p>((</span><span class=n>uint</span><span class=p>)</span> <span class=n>addr</span> <span class=o>%</span> <span class=n>PGSIZE</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>204</span>     <span class=n>panic</span><span class=p>(</span><span class=s>&#34;loaduvm: addr must be page aligned&#34;</span><span class=p>);</span>
<span class=mi>205</span>   <span class=k>for</span><span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>sz</span><span class=p>;</span> <span class=n>i</span> <span class=o>+=</span> <span class=n>PGSIZE</span><span class=p>){</span>
<span class=mi>206</span>     <span class=k>if</span><span class=p>((</span><span class=n>pte</span> <span class=o>=</span> <span class=n>walkpgdir</span><span class=p>(</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>addr</span><span class=o>+</span><span class=n>i</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
<span class=mi>207</span>       <span class=n>panic</span><span class=p>(</span><span class=s>&#34;loaduvm: address should exist&#34;</span><span class=p>);</span>
<span class=mi>208</span>     <span class=n>pa</span> <span class=o>=</span> <span class=n>PTE_ADDR</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>);</span>
<span class=mi>209</span>     <span class=nf>if</span><span class=p>(</span><span class=n>sz</span> <span class=o>-</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>PGSIZE</span><span class=p>)</span>
<span class=mi>210</span>       <span class=n>n</span> <span class=o>=</span> <span class=n>sz</span> <span class=o>-</span> <span class=n>i</span><span class=p>;</span>
<span class=mi>211</span>     <span class=k>else</span>
<span class=mi>212</span>       <span class=n>n</span> <span class=o>=</span> <span class=n>PGSIZE</span><span class=p>;</span>
<span class=mi>213</span>     <span class=nf>if</span><span class=p>(</span><span class=n>readi</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span> <span class=n>P2V</span><span class=p>(</span><span class=n>pa</span><span class=p>),</span> <span class=n>offset</span><span class=o>+</span><span class=n>i</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span> <span class=o>!=</span> <span class=n>n</span><span class=p>)</span>
<span class=mi>214</span>       <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
<span class=mi>215</span>   <span class=p>}</span>
<span class=mi>216</span>   <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=mi>217</span> <span class=p>}</span>
</code></pre></div><ul><li>L203: アライメントされているかチェック</li><li>L205 - 215: PGSIZE毎に物理メモリにinodeのデータを展開</li><li>L206 - 208: 該当する物理アドレスを仮想アドレスから探す<ul><li><a href=https://www.utam0k.jp/blog/2019/03/05/xv6_pagetable_1/#walkpgdir>walkpgidr()</a></li></ul></li><li>L209 - 212: 読み込むサイズがPGSIZEよりも大きければPGSIZE分読み込む</li><li>L213 - 214: データを展開(詳細はファイルシステムの章)<ul><li><code>ip</code>: inode</li><li><code>P2V(pa)</code>: 読み込む先(<code>dst</code>)</li><li><code>offset+i</code>: <code>dst</code>から何バイト先に読み込むか</li><li><code>n</code>: 読み込むサイズ</li></ul></li></ul></li></ul><hr><p>コメントや間違いなどがある場合は<a href=https://twitter.com/utam0k>Twitter</a>に連絡してもらうか
<a href=https://github.com/utam0k/utam0k.github.io/issues/1>Issue</a>に書いていただくと助かります。</p></section><section><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"utam0k"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></article></div><div id=side class="pr-1 bg-white"><aside class=pr-3><div id=toc class="Box Box--blue mb-3"><b>詳解xv6 Page tables 2</b><nav id=TableOfContents><ul><li><a href=#大雑把にやろうとしていること>大雑把にやろうとしていること</a><ul><li><a href=#シーケンス図>シーケンス図</a></li><li><a href=#メモリレイアウト再掲載>メモリレイアウト(再掲載)</a></li><li><a href=#main>main()</a></li><li><a href=#kinit1>kinit1()</a></li><li><a href=#freerange>freerange()</a></li><li><a href=#kfree>kfree()</a></li><li><a href=#kinit2>kinit2()</a></li><li><a href=#kalloc>kalloc()</a></li></ul></li></ul><ul><li><ul><li><a href=#sys_sbrk>sys_sbrk()</a></li><li><a href=#growproc>growproc()</a></li><li><a href=#deallocuvm>deallocuvm()</a></li><li><a href=#allocuvm>allocuvm()</a></li></ul></li></ul><ul><li><ul><li><a href=#loaduvm>loaduvm()</a></li></ul></li></ul></nav></div><div><a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class=twitter-share-button data-show-count=false>Tweet</a><script async src=https://platform.twitter.com/widgets.js></script>
<iframe src="https://www.facebook.com/plugins/share_button.php?href=https%3A%2F%2Fdevelopers.facebook.com%2Fdocs%2Fplugins%2F&layout=button&size=small&mobile_iframe=true&width=61&height=20&appId" width=61 height=20 style=border:none;overflow:hidden scrolling=no frameborder=0 allowtransparency=true allow=encrypted-media></iframe>
<a href=http://b.hatena.ne.jp/entry/ class=hatena-bookmark-button data-hatena-bookmark-layout=basic-label-counter data-hatena-bookmark-lang=ja title=このエントリーをはてなブックマークに追加><img src=https://b.st-hatena.com/images/entry-button/button-only@2x.png alt=このエントリーをはてなブックマークに追加 width=20 height=20 style=border:none></a><script type=text/javascript src=https://b.st-hatena.com/js/bookmark_button.js async></script></div></aside></div><div id=footer class="pt-2 pb-3 bg-white text-center"></div></div><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script></body></html>