<!doctype html><html><head><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-119773781-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>FreeBSDのオンラインカーネルデバッグ with QEMU &ndash; うたもく</title><meta name=description property="og:description" content="|utam0k"><meta name=apple-mobile-web-app-title content="うたもく"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@utam0k"><meta name=twitter:creator content="@utam0k"><meta name=twitter:title content="FreeBSDのオンラインカーネルデバッグ with QEMU"><meta name=twitter:image content="https://www.utam0k.jp/img/logo.png"><meta property="og:title" content="FreeBSDのオンラインカーネルデバッグ with QEMU"><meta property="og:image" content="https://www.utam0k.jp/img/logo.png"><meta property="og:url" content="https://www.utam0k.jp/blog/2018/12/12/freebsd_on-line_debugging/"><meta property="og:type" content="website"><meta property="og:site_name" content="うたもく"><link rel=stylesheet href=https://www.utam0k.jp/assets/syntax.css><link rel=stylesheet href=https://www.utam0k.jp/assets/style.css><link rel=stylesheet href=https://www.utam0k.jp/assets/custom_style.css><link href=https://unpkg.com/@primer/css@^16.0.0/dist/primer.css rel=stylesheet></head><body class=bg-gray><div id=holy class="container-lg bg-white h-100"><div id=header class="px-1 bg-white"><nav class="UnderlineNav UnderlineNav--right px-2"><a class="UnderlineNav-actions muted-link h2" href=https://www.utam0k.jp/>うたもく</a><div class=UnderlineNav-body><a class=UnderlineNav-item href=https://www.utam0k.jp/post/><span>Posts</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/page/about/><span>About</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/tags><span>Tags</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/en/><span>EN</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/index.xml><span>Atom</span></a></div></nav></div><div role=main id=main class="holy-main markdown-body px-4 bg-white"><div class=Subhead><div class=Subhead-heading><div class="h1 mt-3 mb-1">FreeBSDのオンラインカーネルデバッグ with QEMU</div></div><div class=Subhead-description><a href=https://www.utam0k.jp/tags/freebsd class=muted-link><span class="Label Label--gray">freebsd</span></a>
<a href=https://www.utam0k.jp/tags/os class=muted-link><span class="Label Label--gray">os</span></a>
<a href=https://www.utam0k.jp/tags/gdb class=muted-link><span class="Label Label--gray">gdb</span></a><div class=float-md-right><span title="Lastmod: 2018-12-13. Published at: 2018-12-12.">Lastmod: 2018-12-13</span></div></div></div><article><section class="pb-6 mb-3 border-bottom"><p>この記事は<a href=https://adventar.org/calendars/2915>自作OS Advent Calendar 2018</a>の12日目の記事です。</p><h1 id=はじめに>はじめに</h1><p>最近xv6の教科書を読んでみている。
xv6の教科書ではQEMUの<code>-s</code>オプションを用いたデバッグが推奨されている。<br><code>-s</code>オプションは<code>-gdb tcp::1234</code>の省略版でこのオプションを付けてQEMUを使うと<code>1234</code>番ポートでgdbserverを立ち上げてくれる。<br>あとはgdbで<code>target remote :1234</code>とかをするとQEMUにアタッチされていい感じにデバッグできる。
FreeBSDでこれができたらコードリーディングとか捗りそう&mldr;<br>いろいろ試行錯誤してみたらできました。<br>ということでQEMUの<code>-s</code>オプションでFreeBSDのカーネルのデバッグをしてみました。</p><h1 id=デバッグ構成>デバッグ構成</h1><p>今回デバッグするのに2つのFreeBSDが必要になる。</p><table><thead><tr><th align=center>内容</th><th align=center>OS</th><th align=center>仮想化</th><th align=center>ここでの名称</th></tr></thead><tbody><tr><td align=center>デバッグする側</td><td align=center>FreeBSD 11.2</td><td align=center>KVM</td><td align=center><code>Source</code></td></tr><tr><td align=center>デバッグされる側</td><td align=center>FreeBSD 11.2</td><td align=center>QEMU</td><td align=center><code>Target</code></td></tr><tr><td align=center>ホスト</td><td align=center>Ubuntu 18.04.1 Desktop</td><td align=center>    ×</td><td align=center><code>Host</code></td></tr></tbody></table><p><code>Source</code>の方はKVMを使っていますがなんでもよいと思います。<br>ただし、<code>Source</code>の方でカーネル再構築を行います。</p><p><code>Host</code>の<code>20022</code>番ポートが<code>Target</code>の<code>22</code>番ポートにリダイレクトされるように設定した。
<code>Host</code>と<code>Source</code>は<code>192.168.122.0/24</code>で通信できるようにした。<br>この辺は<code>Host</code>からFreeBSDに相互で通信できれば特に問題ないと思われる。</p><figure><img src=constitution.png></figure><h1 id=やり方>やり方</h1><h3 id=1-freebsdのインストール>1. FreeBSDのインストール</h3><p>まずは<code>Source</code>と<code>Target</code>を用意します。
詳しいインストールの方法<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> は割愛します。</p><p><code>Target</code>のインストール準備として<code>Host</code>で以下のコマンド実行します。<br><code>-redir tcp:20022::22</code>のオプションで<code>Host</code>の<code>20022</code>番ポートが<code>Target</code>の<code>22</code>番ポートにリダイレクトされるようにしています。</p><pre><code>$ qemu-img create -f qcow freebsd_debug.img 30G
$ qemu-system-x86_64 -m 4096 -hda freebsd_debug.img -boot c -cdrom FreeBSD-11.2-RELEASE-amd64-dvd1.iso -redir tcp:20022::22
</code></pre><p><strong>※<code>Source</code>は<code>src</code>を含むようにしましょう※</strong></p><figure><img src=include_src.png></figure><p><code>Source</code>と<code>Target</code>ともに起動させます。</p><h3 id=2-カーネルの再構築>2. カーネルの再構築</h3><p><code>Source</code>のカーネルを再構築してデバッグ情報を含むようにします。
カーネルの再構築はFreeBSDのバージョンによって多少異なる点があるので自分が選択したバージョンに合わせましょう。
まずはもとの設定ファイルをコピーします。</p><pre><code>$ cd /usr/src/sys/amd64/conf
$ cp GENERIC MYKERNEL
</code></pre><p>MYKERNELの設定に以下を足します。</p><pre><code>makeoptions DEBUG=-g
options KDB
options DDB
</code></pre><p>実際のMYKERNELを<a href=https://gist.github.com/utam0k/d46552bf552fb5121d929f8dd444f745>gists</a>にあげておきます。
該当箇所は<a href=https://gist.github.com/utam0k/d46552bf552fb5121d929f8dd444f745#file-mykernel-L24>24</a>/
<a href=https://gist.github.com/utam0k/d46552bf552fb5121d929f8dd444f745#file-mykernel-L83>83</a>/
<a href=https://gist.github.com/utam0k/d46552bf552fb5121d929f8dd444f745#file-mykernel-L85>85</a>行目です。</p><p>再構築をします。</p><pre><code>$ cd /usr/src
$ make buildkernel KERNCONF=MYKERNEL
$ make installkernel KERNCONF=MYKERNEL
</code></pre><p><code>make buildkernel</code>は時間がかかるのでここでコーヒーブレイクです。<br>終わったら<code>Source</code>を再起動させましょう。</p><h3 id=3-転送>3. 転送</h3><p><code>Source</code>の<code>/boot/kernel/</code>以下のファイルを全て<code>Target</code>の<code>/boot/kernel/</code>に送りつけます。
<code>Host</code>で以下のコマンドを実行しました。</p><pre><code>$ scp -r root@192.168.122.2:/boot/kernel .
$ scp -P 20022 kernel/* root@127.0.0.1:/boot/kernel
</code></pre><p>2行目のコマンドの前に<code>Host</code>で<code>strip -x</code>とかするとシンボル情報がなくなってスマートになります。</p><pre><code>$ du kernel -h
123M    kernel
$ sudo strip -x kernel/*.ko
$ sudo strip -x kernel/kernel
$ du kernel -h
117M    kernel
</code></pre><h3 id=4-再起動>4. 再起動</h3><p><code>Target</code>をシャットダウンさせます。
<code>Target</code>を<code>-s</code>オプションを付けて起動させます。
これでgdbserver立ち上げてくれます。</p><pre><code>$ qemu-system-x86_64 -m 4096 -hda freebsd_debug.img -boot c -cdrom FreeBSD-11.2-RELEASE-amd64-dvd1.iso -redir tcp:20022::22  -s
</code></pre><p>これに加えて<code>-S</code>オプションを付けると起動からデバッグできます。</p><h3 id=5-kgdb>5. kgdb</h3><p>kgdb<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>はカーネルデバッグのためのデバッガーです。</p><pre><code>$ kgdb /boot/kernel/kernel
GNU gdb 6.1.1 [FreeBSD]
...
This GDB was configured as &quot;amd64-marcel-freebsd&quot;...
(kgdb) target remote 192.168.122.1:1234
...
(kgdb) b sys_mkdir
Breakpoint 1 at 0xffffffff80bdac14: file /usr/src/sys/kern/vfs_syscalls.c, line 3337.
(kgdb) c
Continuing.
</code></pre><p>そしておもむろに<code>Target</code>で<code>mkdir test</code>を実行すると<br><strong>きちんと止まった！でけた!</strong></p><figure><img src=result.jpg></figure><p>クリックすると画像は大きくなります。</p><p>これだけでもシステムコールがどういう感じで呼ばれてるか少しわかるかと思います。<br><strong>やったー！</strong></p><h1 id=終わりに>終わりに</h1><p>これでいい感じにFreeBSDのカーネルコードリーディングができそうです。<br>やっぱりコードとにらめっこするよりも実行しながらできると楽しいですね。<br>たぶん、本来は2つをシリアル通信でつなげてやるんだと思うんですがQEMUの機能でやってみました。<br>なぜFreeBSDなのかという疑問については聞かないでください。<br>13日目の<a href=https://adventar.org/calendars/2915>自作OS Advent Calendar 2018</a>は<a href=https://twitter.com/garasubo>garasubo</a>さんの
「<a href=https://garasubo.github.io/hexo/2018/12/13/rust-arm.html>RustでArm Cortex-Mプログラミングをする 2018</a>」です。<br>お！Rust好きとしては楽しみです。</p><h2 id=参考文献>参考文献</h2><ul><li><a href=https://www.freebsd.org/doc/en/books/developers-handbook/kerneldebug-online-gdb.html>FreeBSD Documentation</a></li></ul><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://www.freebsd.org/doc/en/books/handbook/bsdinstall.html>https://www.freebsd.org/doc/en/books/handbook/bsdinstall.html</a>
同じバージョン、アーキテクチャでインストールしていきます。<br>私の環境ではFreeBSD-11.2-RELEASE-amd64を選択しました。 <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href=https://en.wikipedia.org/wiki/KGDB>https://en.wikipedia.org/wiki/KGDB</a>
<code>Source</code>でkgdbを起動させて<code>Host</code>で起動しているQEMUにアタッチします。
この時点で<code>Target</code>は停止します。<br>ここからは好きにデバッグしてみてください。
ここでは動作の確認のために<code>sys_mkdir</code>にブレイクポイントを設定して、<code>Source</code>の動作を再開させます。 <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></section><section><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"utam0k"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></article></div><div id=side class="pr-1 bg-white"><aside class=pr-3><div id=toc class="Box Box--blue mb-3"><b>FreeBSDのオンラインカーネルデバッグ with QEMU</b><nav id=TableOfContents><ul><li><ul><li><a href=#1-freebsdのインストール>1. FreeBSDのインストール</a></li><li><a href=#2-カーネルの再構築>2. カーネルの再構築</a></li><li><a href=#3-転送>3. 転送</a></li><li><a href=#4-再起動>4. 再起動</a></li><li><a href=#5-kgdb>5. kgdb</a></li></ul></li></ul><ul><li><a href=#参考文献>参考文献</a></li></ul></nav></div><div><a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class=twitter-share-button data-show-count=false>Tweet</a><script async src=https://platform.twitter.com/widgets.js></script>
<iframe src="https://www.facebook.com/plugins/share_button.php?href=https%3A%2F%2Fdevelopers.facebook.com%2Fdocs%2Fplugins%2F&layout=button&size=small&mobile_iframe=true&width=61&height=20&appId" width=61 height=20 style=border:none;overflow:hidden scrolling=no frameborder=0 allowtransparency=true allow=encrypted-media></iframe>
<a href=http://b.hatena.ne.jp/entry/ class=hatena-bookmark-button data-hatena-bookmark-layout=basic-label-counter data-hatena-bookmark-lang=ja title=このエントリーをはてなブックマークに追加><img src=https://b.st-hatena.com/images/entry-button/button-only@2x.png alt=このエントリーをはてなブックマークに追加 width=20 height=20 style=border:none></a><script type=text/javascript src=https://b.st-hatena.com/js/bookmark_button.js async></script></div></aside></div><div id=footer class="pt-2 pb-3 bg-white text-center"></div></div><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script></body></html>