<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>FreeBSDのオンラインカーネルデバッグ with QEMU | うたもく</title><meta name=description content><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:site_name" content="うたもく"><meta property="og:url" content="https://www.utam0k.jp/blog/2018/12/12/freebsd_on-line_debugging/"><meta property="og:title" content="FreeBSDのオンラインカーネルデバッグ with QEMU"><meta property="og:image" content="https://www.utam0k.jp/img/logo.png"><link rel=alternate type=application/rss+xml href=https://www.utam0k.jp/index.xml><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/hack-font/3.3.0/web/hack.min.css crossorigin=anonymous><link rel=stylesheet href=https://www.utam0k.jp/css/main.min.8c338bb578f3b717c90142dc17ddf0fbfbfeb27a4b7e7cebd415f1f139f5e8fa.css integrity="sha256-jDOLtXjztxfJAULcF93w+/v+snpLfnzr1BXx8Tn16Po="><script>(()=>{const e=window.matchMedia("(prefers-color-scheme: dark)"),n=e=>{const s=document.querySelectorAll(".theme-option");s.forEach(t=>{const n=t.dataset.mode===e;t.setAttribute("aria-pressed",n?"true":"false")});const t=document.querySelector(".theme-toggle");t&&t.setAttribute("aria-pressed",e==="dark"?"true":"false");const o=document.querySelectorAll(".theme-choice");o.forEach(t=>t.setAttribute("aria-checked",t.dataset.mode===e?"true":"false"));const n=document.querySelector("[data-theme-icon]");if(n){const t=e==="system"?document.documentElement.dataset.theme||"light":e;n.dataset.state=t}},s=t=>t==="system"?e.matches?"dark":"light":t,t=e=>{const t=s(e);document.documentElement.dataset.theme=t,document.body&&(document.body.dataset.theme=t,document.body.classList.toggle("theme-dark",t==="dark"),document.body.classList.toggle("theme-light",t==="light")),n(e)},o=()=>{const e=localStorage.getItem("color-scheme"),n=e||"system";t(n)};e.addEventListener("change",e=>{const n=localStorage.getItem("color-scheme");(!n||n==="system")&&t("system")}),window.__setTheme=e=>{const n=e||(document.documentElement.dataset.theme==="dark"?"light":"dark");localStorage.setItem("color-scheme",n),t(n)},window.__toggleTheme=()=>window.__setTheme(),window.__toggleThemeMenu=e=>{const t=e?.nextElementSibling;if(!t)return;const n=!t.hidden;document.querySelectorAll(".theme-popover").forEach(e=>e.hidden=!0),document.querySelectorAll(".theme-trigger").forEach(e=>e.setAttribute("aria-expanded","false")),n||(t.hidden=!1,e.setAttribute("aria-expanded","true"))},document.addEventListener("click",e=>{const t=document.querySelector(".theme-popover");if(!t)return;if(e.target.closest(".theme-menu"))return;t.hidden=!0;const n=document.querySelector(".theme-trigger");n?.setAttribute("aria-expanded","false")}),window.__toggleLangMenu=e=>{const t=e?.nextElementSibling;if(!t)return;const n=!t.hidden;document.querySelectorAll(".lang-popover").forEach(e=>e.hidden=!0),document.querySelectorAll(".lang-trigger").forEach(e=>e.setAttribute("aria-expanded","false")),n||(t.hidden=!1,e.setAttribute("aria-expanded","true"))},window.__switchLang=(e)=>{if(!e)return;window.location.href=e},document.addEventListener("click",e=>{const t=document.querySelector(".lang-popover");if(!t)return;if(e.target.closest(".lang-menu"))return;t.hidden=!0;const n=document.querySelector(".lang-trigger");n?.setAttribute("aria-expanded","false")}),o(),document.addEventListener("DOMContentLoaded",()=>{const t=document.documentElement.dataset.theme||(e.matches?"dark":"light");n(t)})})()</script><meta name=generator content="Hugo 0.152.2"></head><body class=page data-has-toc=true><div class=page-shell><header class=site-header><a class=brand href=https://www.utam0k.jp/><span class=brand-mark aria-hidden=true style=background-image:url(https://www.utam0k.jp/img/logo.png)></span><div class=brand-text><span class=brand-name>Toru Komatsu</span>
<span class=brand-tagline>utam0k</span></div></a><div class=header-actions><nav class=main-nav aria-label=Primary><a class="nav-item is-active" href=https://www.utam0k.jp/blog/>Blog</a>
<a class=nav-item href=https://www.utam0k.jp/slides/>Slides</a>
<a class=nav-item href=https://www.utam0k.jp/page/about/>About</a></nav><span class=header-divider aria-hidden=true></span><div class=header-social><a class=social-btn href=https://github.com/utam0k target=_blank rel="noopener noreferrer" aria-label=GitHub><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .5A12 12 0 008.21 23.9c.6.1.82-.26.82-.58.0-.29-.01-1.05-.02-2.06-3.34.73-4.04-1.61-4.04-1.61-.54-1.37-1.32-1.73-1.32-1.73-1.08-.74.08-.73.08-.73 1.19.08 1.81 1.22 1.81 1.22 1.06 1.8 2.79 1.28 3.47.98.1-.77.42-1.28.76-1.58-2.66-.3-5.47-1.34-5.47-5.95.0-1.32.47-2.4 1.24-3.25-.13-.3-.54-1.52.12-3.16.0.0 1.01-.32 3.3 1.24a11.5 11.5.0 016 0c2.28-1.56 3.29-1.24 3.29-1.24.66 1.64.25 2.86.12 3.16.77.85 1.23 1.93 1.23 3.25.0 4.62-2.81 5.64-5.49 5.94.43.37.81 1.11.81 2.24.0 1.62-.02 2.93-.02 3.33.0.32.21.7.83.58A12 12 0 0012 .5z"/></svg>
</a><a class=social-btn href=https://x.com/utam0k target=_blank rel="noopener noreferrer" aria-label="X (Twitter)"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h5.3l3.4 4.8L14.8 3H21l-6.8 9.2L21 21h-5.3L12 15.8 8.2 21H3l6.8-8.9L3 3z"/></svg></a></div><span class=header-divider aria-hidden=true></span><div class=lang-menu><button class=lang-trigger type=button aria-haspopup=true aria-expanded=false onclick=window.__toggleLangMenu&&window.__toggleLangMenu(this)>
<span class=lang-trigger__label>JA</span></button><div class=lang-popover hidden role=menu><button class=lang-choice type=button data-lang=JA aria-checked=true role=menuitemradio onclick='window.__switchLang&&window.__switchLang("/","JA")'>日本語</button>
<button class=lang-choice type=button data-lang=EN aria-checked=false role=menuitemradio onclick='window.__switchLang&&window.__switchLang("/en/blog/2018/12/12/freebsd_on-line_debugging/","EN")'>English</button></div></div><div class=theme-menu><button class=theme-trigger type=button aria-haspopup=true aria-expanded=false onclick=window.__toggleThemeMenu&&window.__toggleThemeMenu(this)>
<span class=theme-trigger__icon aria-hidden=true data-theme-icon data-state=system></span>
<span class=sr-only data-theme-label>Theme</span></button><div class=theme-popover hidden><button class=theme-choice type=button data-mode=system aria-checked=false role=menuitemradio onclick='window.__setTheme&&window.__setTheme("system")'>Auto (System)</button>
<button class=theme-choice type=button data-mode=light aria-checked=false role=menuitemradio onclick='window.__setTheme&&window.__setTheme("light")'>Light</button>
<button class=theme-choice type=button data-mode=dark aria-checked=false role=menuitemradio onclick='window.__setTheme&&window.__setTheme("dark")'>Dark</button></div></div><button class=menu-toggle type=button aria-expanded=false aria-controls=mobile-menu data-menu-toggle>
<span class=sr-only>Menu</span>
<span class=menu-toggle__icon aria-hidden=true><span></span></span></button></div><div class=mobile-menu id=mobile-menu hidden><div class=mobile-menu__header><span class=mobile-menu__title>Menu</span>
<button class=menu-close type=button aria-label="Close menu" data-menu-close>
<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button></div><nav class=mobile-menu__links aria-label="Primary mobile"><a class="mobile-menu__item is-active" href=https://www.utam0k.jp/blog/>Blog</a>
<a class=mobile-menu__item href=https://www.utam0k.jp/slides/>Slides</a>
<a class=mobile-menu__item href=https://www.utam0k.jp/page/about/>About</a></nav><div class=mobile-menu__footer><div class=mobile-menu__langs><button class="lang-chip is-active" type=button onclick='window.__switchLang&&window.__switchLang("/","JA")'>JA</button>
<button class=lang-chip type=button onclick='window.__switchLang&&window.__switchLang("/en/blog/2018/12/12/freebsd_on-line_debugging/","EN")'>EN</button></div><div class=mobile-menu__icons><button class=social-btn type=button aria-label="Toggle theme" onclick=window.__toggleTheme&&window.__toggleTheme()>
<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="4" fill="currentColor"/><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
</button>
<a class=social-btn href=https://github.com/utam0k target=_blank rel="noopener noreferrer" aria-label=GitHub><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .5A12 12 0 008.21 23.9c.6.1.82-.26.82-.58.0-.29-.01-1.05-.02-2.06-3.34.73-4.04-1.61-4.04-1.61-.54-1.37-1.32-1.73-1.32-1.73-1.08-.74.08-.73.08-.73 1.19.08 1.81 1.22 1.81 1.22 1.06 1.8 2.79 1.28 3.47.98.1-.77.42-1.28.76-1.58-2.66-.3-5.47-1.34-5.47-5.95.0-1.32.47-2.4 1.24-3.25-.13-.3-.54-1.52.12-3.16.0.0 1.01-.32 3.3 1.24a11.5 11.5.0 016 0c2.28-1.56 3.29-1.24 3.29-1.24.66 1.64.25 2.86.12 3.16.77.85 1.23 1.93 1.23 3.25.0 4.62-2.81 5.64-5.49 5.94.43.37.81 1.11.81 2.24.0 1.62-.02 2.93-.02 3.33.0.32.21.7.83.58A12 12 0 0012 .5z"/></svg></a>
<a class=social-btn href=https://x.com/utam0k target=_blank rel="noopener noreferrer" aria-label="X (Twitter)"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h5.3l3.4 4.8L14.8 3H21l-6.8 9.2L21 21h-5.3L12 15.8 8.2 21H3l6.8-8.9L3 3z"/></svg></a></div></div></div><div class=mobile-menu__overlay data-menu-overlay hidden></div></header><main class=layout><div class=article-layout><article class=article><header class="article-hero article-hero--stack"><h1 class=article-title>FreeBSDのオンラインカーネルデバッグ with QEMU</h1><div class="share-block share-block--mobile"><div class=toc-share aria-label="Share this post"><button type=button class="share-btn share-btn--native" data-share-native data-share-url=https://www.utam0k.jp/blog/2018/12/12/freebsd_on-line_debugging/ data-share-title="FreeBSDのオンラインカーネルデバッグ with QEMU" aria-label=ネイティブ共有 hidden>
<svg viewBox="0 -960 960 960" aria-hidden="true"><path d="M680-80q-50 0-85-35t-35-85q0-6 3-28L282-392q-16 15-37 23.5t-45 8.5q-50 0-85-35t-35-85 35-85 85-35q24 0 45 8.5t37 23.5l281-164q-2-7-2.5-13.5T560-760q0-50 35-85t85-35 85 35 35 85-35 85-85 35q-24 0-45-8.5T598-672L317-508q2 7 2.5 13.5t.5 14.5-.5 14.5T317-452l281 164q16-15 37-23.5t45-8.5q50 0 85 35t35 85-35 85-85 35zm0-80q17 0 28.5-11.5T720-2e2t-11.5-28.5T680-240t-28.5 11.5T640-2e2t11.5 28.5T680-160zM2e2-440q17 0 28.5-11.5T240-480t-11.5-28.5T2e2-520t-28.5 11.5T160-480t11.5 28.5T2e2-440zm480-280q17 0 28.5-11.5T720-760t-11.5-28.5T680-8e2t-28.5 11.5T640-760t11.5 28.5T680-720zm0 520zM2e2-480zm480-280z"/></svg>
<span class=sr-only>共有</span>
</button>
<a class=share-btn href="https://twitter.com/intent/tweet?text=FreeBSD%e3%81%ae%e3%82%aa%e3%83%b3%e3%83%a9%e3%82%a4%e3%83%b3%e3%82%ab%e3%83%bc%e3%83%8d%e3%83%ab%e3%83%87%e3%83%90%e3%83%83%e3%82%b0%20with%20QEMU&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2018%2f12%2f12%2ffreebsd_on-line_debugging%2f" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h5.3l3.4 4.8L14.8 3H21l-6.8 9.2L21 21h-5.3L12 15.8 8.2 21H3l6.8-8.9L3 3z"/></svg>
<span class=sr-only>Share on X</span>
</a><a class=share-btn href="http://b.hatena.ne.jp/add?mode=confirm&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2018%2f12%2f12%2ffreebsd_on-line_debugging%2f&title=FreeBSD%e3%81%ae%e3%82%aa%e3%83%b3%e3%83%a9%e3%82%a4%e3%83%b3%e3%82%ab%e3%83%bc%e3%83%8d%e3%83%ab%e3%83%87%e3%83%90%e3%83%83%e3%82%b0%20with%20QEMU" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.47.0C22.42.0 24 1.58 24 3.53v16.94c0 1.95-1.58 3.53-3.53 3.53H3.53C1.58 24 0 22.42.0 20.47V3.53C0 1.58 1.58.0 3.53.0h16.94zM8.61 17.25c1.2.0 2.06-.04 2.58-.12.53-.08.98-.22 1.32-.41.45-.23.78-.56 1.02-.99.24-.43.36-.91.36-1.48.0-.78-.21-1.4-.63-1.87-.42-.48-.99-.74-1.74-.79.66-.18 1.16-.45 1.46-.81.32-.34.47-.82.47-1.42.0-.48-.1-.88-.3-1.26-.21-.36-.5-.65-.88-.87-.35-.2-.74-.32-1.22-.4-.46-.08-1.29-.12-2.48-.12H5.65v10.46H8.6zm.74-4.19c.7.0 1.18.09 1.44.27.27.18.4.5.4.93.0.4-.14.69-.42.86-.27.18-.76.25-1.44.25H8.31v-2.31h1.03zm8.66.71V6.71h-2.46v7.06h2.46zM8.93 9.08c.71.0 1.19.08 1.43.24.25.16.37.44.37.84.0.38-.13.65-.39.8-.27.16-.75.24-1.45.24h-.57V9.08h.61z"/></svg>
<span class=sr-only>はてなブックマーク</span>
</a><a class=share-btn href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2018%2f12%2f12%2ffreebsd_on-line_debugging%2f&title=FreeBSD%e3%81%ae%e3%82%aa%e3%83%b3%e3%83%a9%e3%82%a4%e3%83%b3%e3%82%ab%e3%83%bc%e3%83%8d%e3%83%ab%e3%83%87%e3%83%90%e3%83%83%e3%82%b0%20with%20QEMU" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.45 3.5H3.55A1.55 1.55.0 002 5.05v13.9A1.55 1.55.0 003.55 20.5h16.9A1.55 1.55.0 0022 18.95V5.05A1.55 1.55.0 0020.45 3.5zM7.14 18.1H4.54V9.88h2.6V18.1zm-1.3-9.36a1.51 1.51.0 110-3.02 1.51 1.51.0 010 3.02zM19 18.1h-2.6v-4.96c0-1.18-.42-1.99-1.48-1.99-.81.0-1.3.55-1.51 1.09-.08.19-.1.46-.1.73v5.13H10.7s.03-8.32.0-9.18h2.6v1.3c.35-.54.98-1.31 2.39-1.31 1.74.0 3.31 1.13 3.31 3.56V18.1z"/></svg>
<span class=sr-only>Share on LinkedIn</span></a></div></div><div class="article-meta article-meta--stack"><div class=meta-row>date: <time datetime=2018-12-12>Wed, 12 Dec 2018 00:00:00 +0900</time></div><div class=meta-row>author: <a class=meta-link href=https://www.utam0k.jp/page/about/>@utam0k</a></div><div class=meta-row>tags: [<a class=meta-link href=https://www.utam0k.jp/tags/freebsd>freebsd</a>, <a class=meta-link href=https://www.utam0k.jp/tags/os>os</a>, <a class=meta-link href=https://www.utam0k.jp/tags/gdb>gdb</a>]</div><div class=meta-row>languages: [
<span class=meta-lang-current>JA</span>
,
<a class=meta-link href=https://www.utam0k.jp/en/blog/2018/12/12/freebsd_on-line_debugging/>EN</a>
]</div></div></header><div class=meta-separator aria-hidden=true>---</div><details class=toc-inline id=mobile-toc-inline><summary>目次を開く</summary><nav class=toc aria-label="Table of contents"><p class=toc__title>目次</p><div class=toc__body><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#デバッグ構成>デバッグ構成</a></li><li><a href=#やり方>やり方</a><ul><li><ul><li><a href=#1-freebsdのインストール>1. FreeBSDのインストール</a></li><li><a href=#2-カーネルの再構築>2. カーネルの再構築</a></li><li><a href=#3-転送>3. 転送</a></li><li><a href=#4-再起動>4. 再起動</a></li><li><a href=#5-kgdb>5. kgdb</a></li></ul></li></ul></li><li><a href=#終わりに>終わりに</a><ul><li><a href=#参考文献>参考文献</a></li></ul></li></ul></nav></div></nav></details><div class=toc-modal id=mobile-toc-modal hidden><div class=toc-modal__handle aria-hidden=true></div><div class=toc-modal__header><span>目次</span>
<button type=button class=toc-modal__close data-toc-close aria-label=Close>&#215;</button></div><div class=toc-modal__body><nav class=toc aria-label="Table of contents"><p class=toc__title>目次</p><div class=toc__body><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#デバッグ構成>デバッグ構成</a></li><li><a href=#やり方>やり方</a><ul><li><ul><li><a href=#1-freebsdのインストール>1. FreeBSDのインストール</a></li><li><a href=#2-カーネルの再構築>2. カーネルの再構築</a></li><li><a href=#3-転送>3. 転送</a></li><li><a href=#4-再起動>4. 再起動</a></li><li><a href=#5-kgdb>5. kgdb</a></li></ul></li></ul></li><li><a href=#終わりに>終わりに</a><ul><li><a href=#参考文献>参考文献</a></li></ul></li></ul></nav></div></nav></div></div><div class=toc-modal__overlay hidden></div><div class=article-body><p>この記事は<a href=https://adventar.org/calendars/2915>自作OS Advent Calendar 2018</a>の12日目の記事です。</p><h1 id=はじめに>はじめに</h1><p>最近xv6の教科書を読んでみている。
xv6の教科書ではQEMUの<code>-s</code>オプションを用いたデバッグが推奨されている。<br><code>-s</code>オプションは<code>-gdb tcp::1234</code>の省略版でこのオプションを付けてQEMUを使うと<code>1234</code>番ポートでgdbserverを立ち上げてくれる。<br>あとはgdbで<code>target remote :1234</code>とかをするとQEMUにアタッチされていい感じにデバッグできる。
FreeBSDでこれができたらコードリーディングとか捗りそう&mldr;<br>いろいろ試行錯誤してみたらできました。<br>ということでQEMUの<code>-s</code>オプションでFreeBSDのカーネルのデバッグをしてみました。</p><h1 id=デバッグ構成>デバッグ構成</h1><p>今回デバッグするのに2つのFreeBSDが必要になる。</p><table><thead><tr><th style=text-align:center>内容</th><th style=text-align:center>OS</th><th style=text-align:center>仮想化</th><th style=text-align:center>ここでの名称</th></tr></thead><tbody><tr><td style=text-align:center>デバッグする側</td><td style=text-align:center>FreeBSD 11.2</td><td style=text-align:center>KVM</td><td style=text-align:center><code>Source</code></td></tr><tr><td style=text-align:center>デバッグされる側</td><td style=text-align:center>FreeBSD 11.2</td><td style=text-align:center>QEMU</td><td style=text-align:center><code>Target</code></td></tr><tr><td style=text-align:center>ホスト</td><td style=text-align:center>Ubuntu 18.04.1 Desktop</td><td style=text-align:center>    ×</td><td style=text-align:center><code>Host</code></td></tr></tbody></table><p><code>Source</code>の方はKVMを使っていますがなんでもよいと思います。<br>ただし、<code>Source</code>の方でカーネル再構築を行います。</p><p><code>Host</code>の<code>20022</code>番ポートが<code>Target</code>の<code>22</code>番ポートにリダイレクトされるように設定した。
<code>Host</code>と<code>Source</code>は<code>192.168.122.0/24</code>で通信できるようにした。<br>この辺は<code>Host</code>からFreeBSDに相互で通信できれば特に問題ないと思われる。</p><figure><img src=https://www.utam0k.jp/blog/2018/12/12/freebsd_on-line_debugging/constitution.png></figure><h1 id=やり方>やり方</h1><h3 id=1-freebsdのインストール>1. FreeBSDのインストール</h3><p>まずは<code>Source</code>と<code>Target</code>を用意します。
詳しいインストールの方法<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> は割愛します。</p><p><code>Target</code>のインストール準備として<code>Host</code>で以下のコマンド実行します。<br><code>-redir tcp:20022::22</code>のオプションで<code>Host</code>の<code>20022</code>番ポートが<code>Target</code>の<code>22</code>番ポートにリダイレクトされるようにしています。</p><pre tabindex=0><code>$ qemu-img create -f qcow freebsd_debug.img 30G
$ qemu-system-x86_64 -m 4096 -hda freebsd_debug.img -boot c -cdrom FreeBSD-11.2-RELEASE-amd64-dvd1.iso -redir tcp:20022::22
</code></pre><p><strong>※<code>Source</code>は<code>src</code>を含むようにしましょう※</strong></p><figure><img src=https://www.utam0k.jp/blog/2018/12/12/freebsd_on-line_debugging/include_src.png></figure><p><code>Source</code>と<code>Target</code>ともに起動させます。</p><h3 id=2-カーネルの再構築>2. カーネルの再構築</h3><p><code>Source</code>のカーネルを再構築してデバッグ情報を含むようにします。
カーネルの再構築はFreeBSDのバージョンによって多少異なる点があるので自分が選択したバージョンに合わせましょう。
まずはもとの設定ファイルをコピーします。</p><pre tabindex=0><code>$ cd /usr/src/sys/amd64/conf
$ cp GENERIC MYKERNEL
</code></pre><p>MYKERNELの設定に以下を足します。</p><pre tabindex=0><code>makeoptions DEBUG=-g
options KDB
options DDB
</code></pre><p>実際のMYKERNELを<a href=https://gist.github.com/utam0k/d46552bf552fb5121d929f8dd444f745>gists</a>にあげておきます。
該当箇所は<a href=https://gist.github.com/utam0k/d46552bf552fb5121d929f8dd444f745#file-mykernel-L24>24</a>/
<a href=https://gist.github.com/utam0k/d46552bf552fb5121d929f8dd444f745#file-mykernel-L83>83</a>/
<a href=https://gist.github.com/utam0k/d46552bf552fb5121d929f8dd444f745#file-mykernel-L85>85</a>行目です。</p><p>再構築をします。</p><pre tabindex=0><code>$ cd /usr/src
$ make buildkernel KERNCONF=MYKERNEL
$ make installkernel KERNCONF=MYKERNEL
</code></pre><p><code>make buildkernel</code>は時間がかかるのでここでコーヒーブレイクです。<br>終わったら<code>Source</code>を再起動させましょう。</p><h3 id=3-転送>3. 転送</h3><p><code>Source</code>の<code>/boot/kernel/</code>以下のファイルを全て<code>Target</code>の<code>/boot/kernel/</code>に送りつけます。
<code>Host</code>で以下のコマンドを実行しました。</p><pre tabindex=0><code>$ scp -r root@192.168.122.2:/boot/kernel .
$ scp -P 20022 kernel/* root@127.0.0.1:/boot/kernel
</code></pre><p>2行目のコマンドの前に<code>Host</code>で<code>strip -x</code>とかするとシンボル情報がなくなってスマートになります。</p><pre tabindex=0><code>$ du kernel -h
123M    kernel
$ sudo strip -x kernel/*.ko
$ sudo strip -x kernel/kernel
$ du kernel -h
117M    kernel
</code></pre><h3 id=4-再起動>4. 再起動</h3><p><code>Target</code>をシャットダウンさせます。
<code>Target</code>を<code>-s</code>オプションを付けて起動させます。
これでgdbserver立ち上げてくれます。</p><pre tabindex=0><code>$ qemu-system-x86_64 -m 4096 -hda freebsd_debug.img -boot c -cdrom FreeBSD-11.2-RELEASE-amd64-dvd1.iso -redir tcp:20022::22  -s
</code></pre><p>これに加えて<code>-S</code>オプションを付けると起動からデバッグできます。</p><h3 id=5-kgdb>5. kgdb</h3><p>kgdb<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>はカーネルデバッグのためのデバッガーです。</p><pre tabindex=0><code>$ kgdb /boot/kernel/kernel
GNU gdb 6.1.1 [FreeBSD]
...
This GDB was configured as &#34;amd64-marcel-freebsd&#34;...
(kgdb) target remote 192.168.122.1:1234
...
(kgdb) b sys_mkdir
Breakpoint 1 at 0xffffffff80bdac14: file /usr/src/sys/kern/vfs_syscalls.c, line 3337.
(kgdb) c
Continuing.
</code></pre><p>そしておもむろに<code>Target</code>で<code>mkdir test</code>を実行すると<br><strong>きちんと止まった！でけた!</strong></p><figure><img src=https://www.utam0k.jp/blog/2018/12/12/freebsd_on-line_debugging/result.jpg></figure><p>クリックすると画像は大きくなります。</p><p>これだけでもシステムコールがどういう感じで呼ばれてるか少しわかるかと思います。<br><strong>やったー！</strong></p><h1 id=終わりに>終わりに</h1><p>これでいい感じにFreeBSDのカーネルコードリーディングができそうです。<br>やっぱりコードとにらめっこするよりも実行しながらできると楽しいですね。<br>たぶん、本来は2つをシリアル通信でつなげてやるんだと思うんですがQEMUの機能でやってみました。<br>なぜFreeBSDなのかという疑問については聞かないでください。<br>13日目の<a href=https://adventar.org/calendars/2915>自作OS Advent Calendar 2018</a>は<a href=https://twitter.com/garasubo>garasubo</a>さんの
「<a href=https://garasubo.github.io/hexo/2018/12/13/rust-arm.html>RustでArm Cortex-Mプログラミングをする 2018</a>」です。<br>お！Rust好きとしては楽しみです。</p><h2 id=参考文献>参考文献</h2><ul><li><a href=https://www.freebsd.org/doc/en/books/developers-handbook/kerneldebug-online-gdb.html>FreeBSD Documentation</a></li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://www.freebsd.org/doc/en/books/handbook/bsdinstall.html>https://www.freebsd.org/doc/en/books/handbook/bsdinstall.html</a>
同じバージョン、アーキテクチャでインストールしていきます。<br>私の環境ではFreeBSD-11.2-RELEASE-amd64を選択しました。&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://en.wikipedia.org/wiki/KGDB>https://en.wikipedia.org/wiki/KGDB</a>
<code>Source</code>でkgdbを起動させて<code>Host</code>で起動しているQEMUにアタッチします。
この時点で<code>Target</code>は停止します。<br>ここからは好きにデバッグしてみてください。
ここでは動作の確認のために<code>sys_mkdir</code>にブレイクポイントを設定して、<code>Source</code>の動作を再開させます。&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=article-footer><a class=muted href=https://www.utam0k.jp/blog/>← Back to blog</a><div class=article-nav><a class=nav-arrow href=https://www.utam0k.jp/blog/2018/10/12/r9cc/>← 1人でがんばる自作Cコンパイラ</a>
<a class=nav-arrow href=https://www.utam0k.jp/blog/2019/03/05/xv6_index/>教育版UNIX v6解説 ~詳解xv6~ →</a></div></div></article><aside class=toc-desktop><nav class=toc aria-label="Table of contents"><p class=toc__title>目次</p><div class=toc__body><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#デバッグ構成>デバッグ構成</a></li><li><a href=#やり方>やり方</a><ul><li><ul><li><a href=#1-freebsdのインストール>1. FreeBSDのインストール</a></li><li><a href=#2-カーネルの再構築>2. カーネルの再構築</a></li><li><a href=#3-転送>3. 転送</a></li><li><a href=#4-再起動>4. 再起動</a></li><li><a href=#5-kgdb>5. kgdb</a></li></ul></li></ul></li><li><a href=#終わりに>終わりに</a><ul><li><a href=#参考文献>参考文献</a></li></ul></li></ul></nav></div></nav><div class=sidebar-profile><a class=sidebar-profile__name href=https://www.utam0k.jp/about/>Toru Komatsu</a><div class=sidebar-profile__links><a class=social-btn href=https://github.com/utam0k target=_blank rel="noopener noreferrer" aria-label=GitHub><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .5A12 12 0 008.21 23.9c.6.1.82-.26.82-.58.0-.29-.01-1.05-.02-2.06-3.34.73-4.04-1.61-4.04-1.61-.54-1.37-1.32-1.73-1.32-1.73-1.08-.74.08-.73.08-.73 1.19.08 1.81 1.22 1.81 1.22 1.06 1.8 2.79 1.28 3.47.98.1-.77.42-1.28.76-1.58-2.66-.3-5.47-1.34-5.47-5.95.0-1.32.47-2.4 1.24-3.25-.13-.3-.54-1.52.12-3.16.0.0 1.01-.32 3.3 1.24a11.5 11.5.0 016 0c2.28-1.56 3.29-1.24 3.29-1.24.66 1.64.25 2.86.12 3.16.77.85 1.23 1.93 1.23 3.25.0 4.62-2.81 5.64-5.49 5.94.43.37.81 1.11.81 2.24.0 1.62-.02 2.93-.02 3.33.0.32.21.7.83.58A12 12 0 0012 .5z"/></svg></a>
<a class=social-btn href=https://x.com/utam0k target=_blank rel="noopener noreferrer" aria-label="X (Twitter)"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h5.3l3.4 4.8L14.8 3H21l-6.8 9.2L21 21h-5.3L12 15.8 8.2 21H3l6.8-8.9L3 3z"/></svg></a></div></div><div class="share-block share-block--desktop"><div class=toc-share aria-label="Share this post"><button type=button class="share-btn share-btn--native" data-share-native data-share-url=https://www.utam0k.jp/blog/2018/12/12/freebsd_on-line_debugging/ data-share-title="FreeBSDのオンラインカーネルデバッグ with QEMU" aria-label=ネイティブ共有 hidden>
<svg viewBox="0 -960 960 960" aria-hidden="true"><path d="M680-80q-50 0-85-35t-35-85q0-6 3-28L282-392q-16 15-37 23.5t-45 8.5q-50 0-85-35t-35-85 35-85 85-35q24 0 45 8.5t37 23.5l281-164q-2-7-2.5-13.5T560-760q0-50 35-85t85-35 85 35 35 85-35 85-85 35q-24 0-45-8.5T598-672L317-508q2 7 2.5 13.5t.5 14.5-.5 14.5T317-452l281 164q16-15 37-23.5t45-8.5q50 0 85 35t35 85-35 85-85 35zm0-80q17 0 28.5-11.5T720-2e2t-11.5-28.5T680-240t-28.5 11.5T640-2e2t11.5 28.5T680-160zM2e2-440q17 0 28.5-11.5T240-480t-11.5-28.5T2e2-520t-28.5 11.5T160-480t11.5 28.5T2e2-440zm480-280q17 0 28.5-11.5T720-760t-11.5-28.5T680-8e2t-28.5 11.5T640-760t11.5 28.5T680-720zm0 520zM2e2-480zm480-280z"/></svg>
<span class=sr-only>共有</span>
</button>
<a class=share-btn href="https://twitter.com/intent/tweet?text=FreeBSD%e3%81%ae%e3%82%aa%e3%83%b3%e3%83%a9%e3%82%a4%e3%83%b3%e3%82%ab%e3%83%bc%e3%83%8d%e3%83%ab%e3%83%87%e3%83%90%e3%83%83%e3%82%b0%20with%20QEMU&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2018%2f12%2f12%2ffreebsd_on-line_debugging%2f" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h5.3l3.4 4.8L14.8 3H21l-6.8 9.2L21 21h-5.3L12 15.8 8.2 21H3l6.8-8.9L3 3z"/></svg>
<span class=sr-only>Share on X</span>
</a><a class=share-btn href="http://b.hatena.ne.jp/add?mode=confirm&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2018%2f12%2f12%2ffreebsd_on-line_debugging%2f&title=FreeBSD%e3%81%ae%e3%82%aa%e3%83%b3%e3%83%a9%e3%82%a4%e3%83%b3%e3%82%ab%e3%83%bc%e3%83%8d%e3%83%ab%e3%83%87%e3%83%90%e3%83%83%e3%82%b0%20with%20QEMU" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.47.0C22.42.0 24 1.58 24 3.53v16.94c0 1.95-1.58 3.53-3.53 3.53H3.53C1.58 24 0 22.42.0 20.47V3.53C0 1.58 1.58.0 3.53.0h16.94zM8.61 17.25c1.2.0 2.06-.04 2.58-.12.53-.08.98-.22 1.32-.41.45-.23.78-.56 1.02-.99.24-.43.36-.91.36-1.48.0-.78-.21-1.4-.63-1.87-.42-.48-.99-.74-1.74-.79.66-.18 1.16-.45 1.46-.81.32-.34.47-.82.47-1.42.0-.48-.1-.88-.3-1.26-.21-.36-.5-.65-.88-.87-.35-.2-.74-.32-1.22-.4-.46-.08-1.29-.12-2.48-.12H5.65v10.46H8.6zm.74-4.19c.7.0 1.18.09 1.44.27.27.18.4.5.4.93.0.4-.14.69-.42.86-.27.18-.76.25-1.44.25H8.31v-2.31h1.03zm8.66.71V6.71h-2.46v7.06h2.46zM8.93 9.08c.71.0 1.19.08 1.43.24.25.16.37.44.37.84.0.38-.13.65-.39.8-.27.16-.75.24-1.45.24h-.57V9.08h.61z"/></svg>
<span class=sr-only>はてなブックマーク</span>
</a><a class=share-btn href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.utam0k.jp%2fblog%2f2018%2f12%2f12%2ffreebsd_on-line_debugging%2f&title=FreeBSD%e3%81%ae%e3%82%aa%e3%83%b3%e3%83%a9%e3%82%a4%e3%83%b3%e3%82%ab%e3%83%bc%e3%83%8d%e3%83%ab%e3%83%87%e3%83%90%e3%83%83%e3%82%b0%20with%20QEMU" target=_blank rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.45 3.5H3.55A1.55 1.55.0 002 5.05v13.9A1.55 1.55.0 003.55 20.5h16.9A1.55 1.55.0 0022 18.95V5.05A1.55 1.55.0 0020.45 3.5zM7.14 18.1H4.54V9.88h2.6V18.1zm-1.3-9.36a1.51 1.51.0 110-3.02 1.51 1.51.0 010 3.02zM19 18.1h-2.6v-4.96c0-1.18-.42-1.99-1.48-1.99-.81.0-1.3.55-1.51 1.09-.08.19-.1.46-.1.73v5.13H10.7s.03-8.32.0-9.18h2.6v1.3c.35-.54.98-1.31 2.39-1.31 1.74.0 3.31 1.13 3.31 3.56V18.1z"/></svg>
<span class=sr-only>Share on LinkedIn</span></a></div></div></aside></div><button type=button class=mobile-toc-fab data-toc-modal=#mobile-toc-modal aria-pressed=false>
<span class=mobile-toc-fab__label>目次</span>
<svg class="mobile-toc-fab__icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 14l6-6 6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button></main><footer class=site-footer><div class=footer-meta><span>&copy; 2025 Toru Komatsu</span>
<a href=https://x.com/utam0k target=_blank rel=noopener class=muted>@utam0k</a></div><div class=footer-links><a class=muted href=https://www.utam0k.jp/index.xml>RSS</a>
<a class=muted href=https://github.com/utam0k target=_blank rel=noopener>GitHub</a></div></footer></div><script defer src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script defer type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script><script>(()=>{const e=()=>{const e=window.matchMedia("(max-width: 1024px)").matches,t=/Mobi|Android/i.test(navigator.userAgent),n=e||t;document.body.dataset.isMobile=n?"true":"false"};e(),window.addEventListener("resize",e,{passive:!0})})(),(()=>{const e=()=>Array.from(document.querySelectorAll("[data-toc-modal]")),a=()=>Array.from(document.querySelectorAll(".toc-modal")),d=()=>Array.from(document.querySelectorAll(".toc-modal__overlay")),r=t=>e().filter(e=>e.dataset.tocModal===`#${t?.id}`),n=(e,t)=>{r(e).forEach(e=>{e.classList.toggle("is-active",t),e.setAttribute("aria-pressed",t?"true":"false")})},c=e=>{if(!e)return;e.classList.add("is-open"),e.hidden=!1,document.body.classList.add("toc-open"),n(e,!0)},t=e=>{if(!e)return;e.classList.remove("is-open"),e.hidden=!0,document.body.classList.remove("toc-open"),n(e,!1)},s=()=>a().forEach(e=>t(e)),l=e=>{if(!e)return;e.classList.contains("is-open")?t(e):c(e)},o=()=>{e().forEach(e=>e.classList.add("is-visible"))},i=()=>{e().forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tocModal,n=t?document.querySelector(t):null;l(n)})}),document.addEventListener("click",e=>{if(e.target?.classList?.contains("toc-modal__overlay")&&s(),e.target?.matches("[data-toc-close]")){const n=e.target.closest(".toc-modal");t(n)}e.target?.closest(".toc-modal")&&e.target.tagName==="A"&&s()}),window.addEventListener("scroll",o,{passive:!0}),o()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",i):i()})(),(()=>{const e=document.querySelector(".site-header");if(!e)return;const s=()=>document.body.dataset.isMobile==="true";if(s())return;let t=window.scrollY,n=!1;const o=8,i=()=>{const n=window.scrollY;if(n<80){e.classList.remove("is-hidden"),t=n;return}if(Math.abs(n-t)<o)return;n>t?e.classList.add("is-hidden"):e.classList.remove("is-hidden"),t=n};window.addEventListener("scroll",()=>{if(n)return;n=!0,requestAnimationFrame(()=>{i(),n=!1})},{passive:!0})})(),(()=>{const e=document.querySelector(".share-block--mobile");if(!e)return;const o=()=>document.body.dataset.isMobile==="true";let t=window.scrollY,s=!1;const i=4,a=80,r=()=>{if(e.classList.contains("is-floating"))return;e.classList.add("is-floating"),document.body.classList.add("has-mobile-share")},c=()=>{e.classList.remove("is-floating","is-visible"),document.body.classList.remove("has-mobile-share")},n=()=>{if(!o()){c();return}r();const n=window.scrollY;if(n<a){e.classList.add("is-visible"),t=n;return}if(Math.abs(n-t)<i)return;const s=n<t;s?e.classList.add("is-visible"):e.classList.remove("is-visible"),t=n};window.addEventListener("scroll",()=>{if(s)return;s=!0,requestAnimationFrame(()=>{n(),s=!1})},{passive:!0}),window.addEventListener("resize",n,{passive:!0}),window.addEventListener("orientationchange",n,{passive:!0}),n()})(),(()=>{const e=document.querySelector("[data-share-native]");if(!e)return;const n=e.dataset.shareUrl||location.href,s=e.dataset.shareTitle||document.title,o=()=>document.body.dataset.isMobile==="true",i=()=>{e.hidden=!1,e.addEventListener("click",async e=>{e.preventDefault();try{await navigator.share({title:s,url:n})}catch(e){if(e&&e.name==="AbortError")return;console.warn("Native share failed",e)}})},t=()=>{navigator.share&&o()?i():e.remove()};t(),window.addEventListener("resize",t,{passive:!0}),window.addEventListener("orientationchange",t,{passive:!0})})(),(()=>{const e=document.querySelector("[data-menu-toggle]"),s=document.getElementById("mobile-menu"),t=document.querySelector("[data-menu-overlay]");if(!e||!s)return;const i=()=>document.body.dataset.isMobile==="true",o=n=>{e.classList.toggle("is-open",n),e.setAttribute("aria-expanded",n?"true":"false"),s.hidden=!n,s.classList.toggle("is-open",n),t&&(t.hidden=!n,t.classList.toggle("is-open",n)),document.body.classList.toggle("menu-open",n)},a=()=>o(e.getAttribute("aria-expanded")!=="true"),n=()=>o(!1);e.addEventListener("click",e=>{e.stopPropagation(),a()}),document.querySelectorAll("[data-menu-close]").forEach(e=>e.addEventListener("click",n)),document.addEventListener("click",t=>{!s.contains(t.target)&&!e.contains(t.target)&&n()}),t&&t.addEventListener("click",n),document.addEventListener("keydown",e=>{e.key==="Escape"&&n()}),window.addEventListener("resize",()=>{i()||n()},{passive:!0})})()</script><script>(()=>{const s=Array.from(document.querySelectorAll(".toc__body a"));if(!s.length)return;const r=e=>decodeURIComponent(e.hash.replace("#","")),o=new Map;s.forEach(e=>{const t=r(e),n=o.get(t)||[];n.push(e),o.set(t,n)});const t=Array.from(new Set(s.map(e=>document.getElementById(r(e))).filter(Boolean)));if(!t.length)return;const i=e=>{o.forEach((t,n)=>{t.forEach(t=>t.classList.toggle("is-active",n===e))})},e=()=>{const n=window.scrollY+120;let e=t[0].id;for(const s of t)if(s.offsetTop<=n)e=s.id;else break;return i(e),e};let n=t[0].id;if(i(n),"IntersectionObserver"in window){const s=new Map,o=()=>{if(s.size){const e=Array.from(s.values()).sort((e,t)=>e.boundingClientRect.top-t.boundingClientRect.top)[0];n=e.target.id,i(n)}else n=e()},a=new IntersectionObserver(e=>{e.forEach(e=>{const t=e.target.id;e.isIntersecting?s.set(t,e):s.delete(t)}),o()},{rootMargin:"0px 0px -65% 0px",threshold:[0,.1,.5]});t.forEach(e=>a.observe(e)),window.addEventListener("load",o),window.addEventListener("resize",o,{passive:!0});return}let a=!1;const c=()=>{if(a)return;a=!0,requestAnimationFrame(()=>{e(),a=!1})};window.addEventListener("scroll",c,{passive:!0}),window.addEventListener("resize",e,{passive:!0}),window.addEventListener("load",e),document.querySelectorAll("img").forEach(t=>t.addEventListener("load",e,{once:!0})),e()})()</script><script>(()=>{const t=Array.from(document.querySelectorAll(".article-body img"));if(!t.length)return;const e=document.createElement("div");e.className="lightbox-backdrop",e.innerHTML='<img alt="">',document.body.appendChild(e);const n=e.querySelector("img"),s=()=>e.classList.remove("is-open");e.addEventListener("click",s),document.addEventListener("keydown",e=>{e.key==="Escape"&&s()}),t.forEach(t=>{t.addEventListener("click",()=>{n.src=t.src,n.alt=t.alt||"",e.classList.add("is-open")})})})()</script></body></html>