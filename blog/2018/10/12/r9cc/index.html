<!doctype html><html><head><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-119773781-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>1人でがんばる自作Cコンパイラ &ndash; うたもく</title><meta name=description property="og:description" content="|utam0k"><meta name=apple-mobile-web-app-title content="うたもく"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@utam0k"><meta name=twitter:creator content="@utam0k"><meta name=twitter:title content="1人でがんばる自作Cコンパイラ"><meta name=twitter:description content="Rustで作る自作Cコンパイラ"><meta name=twitter:image content="https://www.utam0k.jp/img/logo.jpg"><meta property="og:title" content="1人でがんばる自作Cコンパイラ"><meta property="og:description" content="Rustで作る自作Cコンパイラ"><meta property="og:image" content="https://www.utam0k.jp/img/logo.jpg"><meta property="og:url" content="https://www.utam0k.jp/blog/2018/10/12/r9cc/"><meta property="og:type" content="website"><meta property="og:site_name" content="うたもく"><link rel=stylesheet href=https://www.utam0k.jp/assets/syntax.css><link rel=stylesheet href=https://www.utam0k.jp/assets/style.css><link rel=stylesheet href=https://www.utam0k.jp/assets/custom_style.css><link href=https://unpkg.com/@primer/css@^16.0.0/dist/primer.css rel=stylesheet></head><body class=bg-gray><div id=holy class="container-lg bg-white h-100"><div id=header class="px-1 bg-white"><nav class="UnderlineNav UnderlineNav--right px-2"><a class="UnderlineNav-actions muted-link h2" href=https://www.utam0k.jp/>うたもく</a><div class=UnderlineNav-body><a class=UnderlineNav-item href=https://www.utam0k.jp/post/><span>Posts</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/page/about/><span>About</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/tags><span>Tags</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/en/><span>EN</span></a>
<a class=UnderlineNav-item href=https://www.utam0k.jp/index.xml><span>Atom</span></a></div></nav></div><div role=main id=main class="holy-main markdown-body px-4 bg-white"><div class=Subhead><div class=Subhead-heading><div class="h1 mt-3 mb-1">1人でがんばる自作Cコンパイラ</div></div><div class=Subhead-description><a href=https://www.utam0k.jp/tags/rust class=muted-link><span class="Label Label--gray">rust</span></a>
<a href=https://www.utam0k.jp/tags/compiler class=muted-link><span class="Label Label--gray">compiler</span></a><div class=float-md-right><span title="Lastmod: 2018-10-12. Published at: 2018-10-12.">Published: 2018-10-12</span></div></div></div><article><section class="pb-6 mb-3 border-bottom"><h2 id=はじめに>はじめに</h2><p>セキュリティキャンを皮切りに自作Cコンパイラがとてもはやっていました。<br>たのしそー僕もやりたい！！！！でもどうやるんだ？？？<br>しかし僕の周りには知る限りではコンパイラに強い人はいませんでした。<br>※ <strong>友達がいないわけではありません</strong><br>誰にも頼ることなくCコンパイラを作るのは難しいのでは!?<br>でもコンパイラは魔法みたいでいやだから知りたい。
本とかいろいろ眺めてみてもさっぱりわからなかったので誰でもできる方法はないかなーと考えたのが<a href=https://github.com/rui314/9cc>9cc</a>をお手本にすることでした。
ということで<a href=https://github.com/rui314/9cc>9cc</a>のファーストコミットからすべてRustにしてみました。
<a href=https://github.com/rui314/9cc>9cc</a>は<a href=https://twitter.com/rui314>rui314</a>さんがやられているCコンパイラです。
<a href=https://github.com/rui314/9cc>9cc</a>のコードは可読性がとても高くとてもやりやすかったです。<a href=https://github.com/rui314/9cc>9cc</a> <em><strong>神</strong></em> です。<br>おそらくこの方法で作るCコンパイラは事前知識はほとんど必要なくできると思います。<br>正直、やるだけだと思います(本当に <em>ｼｭｯ</em> です(ﾎﾝﾏ))。<br>もし同じようなことをやりたい人の参考になればawesomeです。</p><h2 id=できたもの>できたもの</h2><p>できあがっているブツ: <a href=https://github.com/utam0k/r9cc>r9cc</a></p><p><a href=https://github.com/rui314/9cc>9cc</a>の前作である<a href=https://github.com/rui314/8cc>8cc</a>でも同じことを<a href=https://github.com/utam0k/r8cc>チャレンジしていた</a>のですが<br>行き詰っていた & <a href=https://github.com/rui314/9cc>9cc</a>がでた<br>ということで<a href=https://github.com/rui314/9cc>9cc</a>の方に切り替えました。
ということで実は2度目のチャレンジです。</p><p><a href=https://github.com/utam0k/r9cc>r9cc</a>ではコミットメッセージが大文字で始まるものが<a href=https://github.com/rui314/9cc>9cc</a>から単純に移植しているものです。
小文字で始まるものは独自のリファクタリングだったり独自機能だったりします。
そろそろ日本語で書くのが疲れたので趣味で作った<a href=https://github.com/utam0k/r9cc>r9cc</a>でもこのくらいのコードならコンパイルできるぜっていうのを読者に見せつけます。</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=n>fibdp</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>

<span class=kt>int</span> <span class=nf>fib</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>n</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>n</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>fibdp</span><span class=p>[</span><span class=n>n</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>fibdp</span><span class=p>[</span><span class=n>n</span><span class=p>];</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>fibdp</span><span class=p>[</span><span class=n>n</span><span class=p>]</span> <span class=o>=</span> <span class=n>fib</span><span class=p>(</span><span class=n>n</span><span class=o>-</span><span class=mi>2</span><span class=p>)</span> <span class=o>+</span> <span class=n>fib</span><span class=p>(</span><span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
    <span class=k>return</span> <span class=n>fibdp</span><span class=p>[</span><span class=n>n</span><span class=p>];</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
    <span class=n>fibdp</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=kt>int</span> <span class=n>ans</span> <span class=o>=</span> <span class=n>fib</span><span class=p>(</span><span class=mi>46</span><span class=p>);</span>
  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ans</span><span class=p>);</span>
  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>他にもこれくらいなら動きます。</p><ul><li>四則演算</li><li>論理演算</li><li>ローカル変数</li><li>グローバル変数</li><li>引数[あり|なし]の関数呼び出し</li><li>引数[あり|なし]の関数定義</li><li>配列</li><li>ポインタ</li><li>++/--</li><li>char/int型</li><li>文字列リテラル</li><li>構造体</li><li>extern</li><li>#include</li><li>コメント文</li></ul><p><a href=https://github.com/utam0k/r9cc>r9cc</a>の独自機能として配列の初期化時の代入も作ってみたのでこんなのも動きます。</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
  <span class=kt>int</span> <span class=n>x</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>10</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>12</span><span class=p>};</span>
  <span class=k>return</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
<span class=p>}</span>
</code></pre></div><p>これだけでも結構いろいろなCのコードがコンパイルできてびっくりしました。</p><h2 id=気を付けたこと>気を付けたこと</h2><h4 id=なにをしてるか把握する>なにをしてるか把握する</h4><p>おそらく各コミットを何も考えないででRustに書き換えることも可能です。
このように<strong>何もわからないままでもやり続けれてしまう</strong>ことが1番怖いところだと思います。
Rustの力は上がるかもしれませんが本質であるコンパイラを知ることはできません。
Cじゃないの方が頭を使うかなと思ってRustにしました。
正直Cでもよいと思います。
できるだけ自分が作業しているコミットがなにをしているのかを意識して実装しました。
以下の手順で読んでみてコミット全体を把握してから実装することを徹底していました。</p><ol><li>コミットメッセージを読む</li><li>追加されたテストコードを読んでみる</li><li>コード全体を読む</li></ol><p>これに加えて今やってるコミットの+5コミット位を眺めて大まかな流れを把握していました。<br>独自機能を実装してみるのも自分がきちんとコードを把握できているのかチェックするのにはよいと思います。</p><h4 id=ちょっとずつ>ちょっとずつ</h4><p><a href=https://github.com/utam0k/r9cc>r9cc</a>の<a href=https://github.com/utam0k/r9cc/commit/b8b44544eb51d6229f19033a5048043e628ab55a>最初のコミット</a>はこんなもんです。
<a href=https://github.com/rui314/9cc>9cc</a>の<a href=https://github.com/rui314/9cc/commit/56e94442ae8844688d5390851e5b29ba0c946e2f>最初のコミット</a>ももちろんそうです。
数字を返すだけです。<br><strong>こうみると誰でも出来そうじゃないですか!?</strong><br>最初は型なんかありませんでした。<br>構文解析だけを先に作るという方針ではなく、アセンブリを出力するところまでの<strong>全体を均等的</strong>に作っていきます。
でかいものを作りたい気持ちはありましたが、ちょっとずつやっていきました。</p><h4 id=変数名や順序追記-2018-10-13>変数名や順序(追記 2018-10-13)</h4><p>変数名や関数の順番を<a href=https://github.com/utam0k/r9cc>r9cc</a>とできるだけ一緒になるようにしました。
<a href=https://github.com/utam0k/r9cc>r9cc</a>には関数が書かれている場所(?)順番(?)にも意味を持っているところがあります。
変数名や関数名もできるだけ一緒にしたほうがわかりやすくなると思います。</p><h2 id=モチベーション>モチベーション</h2><p><strong>僕の周りにはコンパイラに興味のある人は少なかったためコンパイラについて話す相手はいませんでした。</strong><br>そうなると自分のとても強い意志でがんばるかどうにかしてモチベーションを保つ必要がありました。<br>僕には強い意志を持つ自信がなかったのでモチベーションを保つ方法を考えました。<br>一人でやるときの大きな壁がここだと思います。<br>目標を持つことでモチベーションを保つことができると思います。<br>まず、大きな目標として<a href=https://twitter.com/rui314>rui314</a>さんの<a href=https://note.mu/ruiu/n/n00ebc977fd60>記事</a>でも述べられていますがセキュリティキャンプではセルフホストを設定していたみたいです。
<a href=https://github.com/utam0k/r9cc>r9cc</a>はRustで書いているのでセルフホストはできないので今回はペアレントホストにしました。<br>ペアレントホストは勝手に僕が考えたのですが、参考にしている<a href=https://github.com/rui314/9cc>9cc</a>をコンパイルできるということです。<br>ただ、この目標だけだとモチベーションを保てそうになかったのでもう少し小さな目標を考えました。<br>小さな目標は<a href=https://github.com/rui314/9cc>9cc</a>の適当なコミットを目標にしました。<br>コミットの選び方は自分がわくわくするものを選んで勝手に目標にしていました。<br>僕が選んだの</p><ul><li><a href=https://github.com/rui314/9cc/commit/56e94442ae8844688d5390851e5b29ba0c946e2f>Compile a single number to a program that exits with the given number.</a></li><li><a href=https://github.com/rui314/9cc/commit/42e403e3de0c6457bc11ab14c55a9dad27ed82be>Add variable.</a></li><li><a href=https://github.com/rui314/9cc/commit/c7933acab4e410aa0c0c7a38358092208ace822d>Add zero-arity function definition.</a></li><li><a href=https://github.com/rui314/9cc/commit/b487b30ab0c600b764ea3a94e2502b68f5ee4194>Add &ldquo;for&rdquo;.</a></li><li><a href=https://github.com/rui314/9cc/commit/e43b738d6bb6ecd397e09b46346e0825a00d89e6>Add pointer.</a></li><li><a href=https://github.com/rui314/9cc/commit/63739ad7ef08ee7e037862dfa05739ce00abac5f>Add examples/nqueen.c.</a></li><li><a href=https://github.com/rui314/9cc/commit/bf717fa5e53ebbae9f949515d3662f77af4ff4dd>Add struct definition. Only sizeof() is applicable. No member access.</a></li><li><a href=https://github.com/rui314/9cc/commit/a406a04660d848e083d7b39610409fd9ba497142>Add pre/post increment/decrement operators.</a></li><li><a href=https://github.com/rui314/9cc/commit/a382606b9728ca33f5dedae4f6ca5cc3c9404838>Implement &ldquo;#include&rdquo;.</a></li></ul><p>コミットメッセージのタイトルだけでもわくわくしませんか。うん、しますね。<br>ここまで行くと<code>#include</code>が動くとか楽しみすぎでしょというモチベーションで少しずつやっていきました。</p><p>exampleも積極的に足していくとテンション爆上がりです。<br><a href=https://github.com/rui314/9cc>9cc</a>だと<a href=https://github.com/rui314/9cc/blob/master/examples/nqueen.c>nqueen.c</a>だけですが、
<a href=https://github.com/utam0k/r9cc>r9cc</a>では<a href=https://github.com/utam0k/r9cc/blob/master/examples/fib.c>fib.c</a>や<a href=https://github.com/utam0k/r9cc/blob/master/examples/prime.c>prime.c</a>も足してみました。
自分が書いたコードがコンパイルできた時はたのしー。</p><h2 id=終わりに>終わりに</h2><p>とりあえず<code>#include</code>までできたので記事にしてみました。
<a href=https://github.com/utam0k/r9cc>r9cc</a>を作ることでコーディングはもちろんですが全然わからなかったコンパイラの世界が垣間見れたかなと思います。
今後はペアレントホスト目指してちょっとずつ進んでいきます。
自作Cコンパイラ人口が少しでも増えれば面白いかなと思います。<br>自作Cコンパイラはやっていてめちゃめちゃ楽しいのでおすすめです！<br><em><strong>Rustまだまだ初心者なのでこんな書き方の方がいいよ的なプルリク待ってます。</strong></em><br>Rust固有のコンパイラを作るときに難したかった点はまた違う記事で書こうと思います。<br><em><strong>ﾜﾀｼ ｽｺｼ ﾎﾝﾉｽｺｼ ｼｰｹﾞﾝｺﾞﾃﾞｷﾙ</strong></em><br>くらいは言っても許されるかもしれない。<br>このような機会を与えてくれた<a href=https://github.com/rui314/9cc>9cc</a>に感謝感謝です。
plz awesome.</p><h2 id=追記2018-10-13>追記(2018-10-13)</h2><p>C言語ぽくまで動くまでには1.5週間くらいでした。
<code>#include</code>ができるまでは2ヵ月くらいでした。
もし自作コンパイラやってみようと思ってくれた方で質問や困ったことあったら<a href=https://twitter.com/utam0k>Twitter</a>で
DMなりメンションをもらえればできるだけ考えます！</p><p>学べたこと</p><ul><li>アセンブリ</li><li>C言語の挙動</li><li>いろいろなレジスタの役割</li><li>スタックについて強くなった</li></ul><h2 id=tcfm>tcfm</h2><p><a href=https://twitter.com/rui314>rui314</a>さんがやられている<a href=https://turingcomplete.fm/>Turing Complete FM</a>の紹介をします。<br>Cコンパイラの話など主に低レイヤの話が聞けます。<br>世の中にはすごい人しかいないのではと思えます。</p></section><section><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"utam0k"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></article></div><div id=side class="pr-1 bg-white"><aside class=pr-3><div id=toc class="Box Box--blue mb-3"><b>1人でがんばる自作Cコンパイラ</b><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#できたもの>できたもの</a></li><li><a href=#気を付けたこと>気を付けたこと</a><ul><li></li></ul></li><li><a href=#モチベーション>モチベーション</a></li><li><a href=#終わりに>終わりに</a></li><li><a href=#追記2018-10-13>追記(2018-10-13)</a></li><li><a href=#tcfm>tcfm</a></li></ul></nav></div><div><a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class=twitter-share-button data-show-count=false>Tweet</a><script async src=https://platform.twitter.com/widgets.js></script>
<iframe src="https://www.facebook.com/plugins/share_button.php?href=https%3A%2F%2Fdevelopers.facebook.com%2Fdocs%2Fplugins%2F&layout=button&size=small&mobile_iframe=true&width=61&height=20&appId" width=61 height=20 style=border:none;overflow:hidden scrolling=no frameborder=0 allowtransparency=true allow=encrypted-media></iframe>
<a href=http://b.hatena.ne.jp/entry/ class=hatena-bookmark-button data-hatena-bookmark-layout=basic-label-counter data-hatena-bookmark-lang=ja title=このエントリーをはてなブックマークに追加><img src=https://b.st-hatena.com/images/entry-button/button-only@2x.png alt=このエントリーをはてなブックマークに追加 width=20 height=20 style=border:none></a><script type=text/javascript src=https://b.st-hatena.com/js/bookmark_button.js async></script></div></aside></div><div id=footer class="pt-2 pb-3 bg-white text-center"></div></div><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script></body></html>