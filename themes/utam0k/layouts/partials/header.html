<header class="site-header">
  <a class="brand" href="{{ "/" | relLangURL }}">
    {{ with .Site.Params.logo }}
      <span class="brand-mark" aria-hidden="true" style="background-image:url('{{ . | absURL }}')"></span>
    {{ else }}
      <span class="brand-mark brand-mark--fallback" aria-hidden="true">{{ .Site.Title | substr 0 1 | upper }}</span>
    {{ end }}
    {{ $brandName := .Site.Params.author.name | default .Site.Title }}
    {{ $brandHandle := or .Site.Params.author.github (or .Site.Params.author.twitter .Site.Params.description) }}
    <div class="brand-text">
      <span class="brand-name">{{ $brandName }}</span>
      {{ with $brandHandle }}<span class="brand-tagline">{{ . }}</span>{{ end }}
    </div>
  </a>

  <div class="header-actions">
    {{ $cur := .Lang }}
    {{ $trJa := index (where .Translations "Lang" "ja") 0 }}
    {{ $trEn := index (where .Translations "Lang" "en") 0 }}
    {{ $jaUrl := cond $trJa $trJa.RelPermalink "/" }}
    {{ $enUrl := cond $trEn $trEn.RelPermalink "/en/" }}
    {{ $langs := slice
        (dict "label" "JA" "url" $jaUrl "active" (eq $cur "ja"))
        (dict "label" "EN" "url" $enUrl "active" (eq $cur "en"))
    }}

    {{ with .Site.Menus.main }}
    <nav class="main-nav" aria-label="Primary">
      {{ $current := $.RelPermalink }}
      {{ range sort . "Weight" }}
        {{ $url := .URL | relLangURL }}
        {{ $isActive := cond (or (eq $url "/") (eq $url (printf "/%s/" $.Lang))) (eq $current $url) (hasPrefix $current $url) }}
        <a class="nav-item{{ if $isActive }} is-active{{ end }}" href="{{ $url }}">{{ .Name }}</a>
      {{ end }}
    </nav>
    {{ end }}
    <span class="header-divider" aria-hidden="true"></span>
    {{ $gh := .Site.Params.author.github | default "" }}
    {{ $tw := .Site.Params.author.twitter | default "" }}
    <div class="header-social">
      {{ if $gh }}
      <a class="social-btn" href="https://github.com/{{ $gh }}" target="_blank" rel="noopener noreferrer" aria-label="GitHub">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .5a12 12 0 0 0-3.79 23.4c.6.1.82-.26.82-.58 0-.29-.01-1.05-.02-2.06-3.34.73-4.04-1.61-4.04-1.61-.54-1.37-1.32-1.73-1.32-1.73-1.08-.74.08-.73.08-.73 1.19.08 1.81 1.22 1.81 1.22 1.06 1.8 2.79 1.28 3.47.98.1-.77.42-1.28.76-1.58-2.66-.3-5.47-1.34-5.47-5.95 0-1.32.47-2.4 1.24-3.25-.13-.3-.54-1.52.12-3.16 0 0 1.01-.32 3.3 1.24a11.5 11.5 0 0 1 6 0c2.28-1.56 3.29-1.24 3.29-1.24.66 1.64.25 2.86.12 3.16.77.85 1.23 1.93 1.23 3.25 0 4.62-2.81 5.64-5.49 5.94.43.37.81 1.11.81 2.24 0 1.62-.02 2.93-.02 3.33 0 .32.21.7.83.58A12 12 0 0 0 12 .5Z"/></svg>
      </a>
      {{ end }}
      {{ if $tw }}
      <a class="social-btn" href="https://x.com/{{ $tw }}" target="_blank" rel="noopener noreferrer" aria-label="X (Twitter)">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h5.3l3.4 4.8L14.8 3H21l-6.8 9.2L21 21h-5.3l-3.7-5.2L8.2 21H3l6.8-8.9L3 3z"/></svg>
      </a>
      {{ end }}
    </div>
    <span class="header-divider" aria-hidden="true"></span>
    <div class="lang-menu">
      <button class="lang-trigger" type="button" aria-haspopup="true" aria-expanded="false" onclick="window.__toggleLangMenu && window.__toggleLangMenu(this);">
        <span class="lang-trigger__label">{{ $cur | upper }}</span>
      </button>
      <div class="lang-popover" hidden role="menu">
        {{ range $langs }}
          {{ $name := cond (eq .label "JA") "日本語" "English" }}
          <button class="lang-choice" type="button" data-lang="{{ .label }}" aria-checked="{{ if .active }}true{{ else }}false{{ end }}" role="menuitemradio" onclick="window.__switchLang && window.__switchLang('{{ .url }}', '{{ .label }}');">{{ $name }}</button>
        {{ end }}
      </div>
    </div>
    <div class="theme-menu">
      <button class="theme-trigger" type="button" aria-haspopup="true" aria-expanded="false" onclick="window.__toggleThemeMenu && window.__toggleThemeMenu(this);">
        <span class="theme-trigger__icon" aria-hidden="true" data-theme-icon data-state="system"></span>
        <span class="sr-only" data-theme-label>Theme</span>
      </button>
      <div class="theme-popover" hidden>
        <button class="theme-choice" type="button" data-mode="system" aria-checked="false" role="menuitemradio" onclick="window.__setTheme && window.__setTheme('system');">Auto (System)</button>
        <button class="theme-choice" type="button" data-mode="light" aria-checked="false" role="menuitemradio" onclick="window.__setTheme && window.__setTheme('light');">Light</button>
        <button class="theme-choice" type="button" data-mode="dark" aria-checked="false" role="menuitemradio" onclick="window.__setTheme && window.__setTheme('dark');">Dark</button>
      </div>
    </div>
    <button class="menu-toggle" type="button" aria-expanded="false" aria-controls="mobile-menu" data-menu-toggle>
      <span class="sr-only">Menu</span>
      <span class="menu-toggle__icon" aria-hidden="true"><span></span></span>
    </button>
  </div>

  {{/* Mobile menu */}}
  <div class="mobile-menu" id="mobile-menu" hidden>
    <div class="mobile-menu__header">
      <span class="mobile-menu__title">Menu</span>
      <button class="menu-close" type="button" aria-label="Close menu" data-menu-close>
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </div>
    {{ with .Site.Menus.main }}
    <nav class="mobile-menu__links" aria-label="Primary mobile">
      {{ $current := $.RelPermalink }}
      {{ range sort . "Weight" }}
        {{ $url := .URL | relLangURL }}
        {{ $isActive := cond (or (eq $url "/") (eq $url (printf "/%s/" $.Lang))) (eq $current $url) (hasPrefix $current $url) }}
        <a class="mobile-menu__item{{ if $isActive }} is-active{{ end }}" href="{{ $url }}">{{ .Name }}</a>
      {{ end }}
    </nav>
    {{ end }}
    <div class="mobile-menu__footer">
      <div class="mobile-menu__langs">
        {{ range $langs }}
          <button class="lang-chip{{ if .active }} is-active{{ end }}" type="button" onclick="window.__switchLang && window.__switchLang('{{ .url }}', '{{ .label }}');">{{ .label }}</button>
        {{ end }}
      </div>
      <div class="mobile-menu__icons">
        <button class="social-btn" type="button" aria-label="Toggle theme" onclick="window.__toggleTheme && window.__toggleTheme();">
          <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="4" fill="currentColor"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        {{ if $gh }}<a class="social-btn" href="https://github.com/{{ $gh }}" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .5a12 12 0 0 0-3.79 23.4c.6.1.82-.26.82-.58 0-.29-.01-1.05-.02-2.06-3.34.73-4.04-1.61-4.04-1.61-.54-1.37-1.32-1.73-1.32-1.73-1.08-.74.08-.73.08-.73 1.19.08 1.81 1.22 1.81 1.22 1.06 1.8 2.79 1.28 3.47.98.1-.77.42-1.28.76-1.58-2.66-.3-5.47-1.34-5.47-5.95 0-1.32.47-2.4 1.24-3.25-.13-.3-.54-1.52.12-3.16 0 0 1.01-.32 3.3 1.24a11.5 11.5 0 0 1 6 0c2.28-1.56 3.29-1.24 3.29-1.24.66 1.64.25 2.86.12 3.16.77.85 1.23 1.93 1.23 3.25 0 4.62-2.81 5.64-5.49 5.94.43.37.81 1.11.81 2.24 0 1.62-.02 2.93-.02 3.33 0 .32.21.7.83.58A12 12 0 0 0 12 .5Z"/></svg></a>{{ end }}
        {{ if $tw }}<a class="social-btn" href="https://x.com/{{ $tw }}" target="_blank" rel="noopener noreferrer" aria-label="X (Twitter)"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h5.3l3.4 4.8L14.8 3H21l-6.8 9.2L21 21h-5.3l-3.7-5.2L8.2 21H3l6.8-8.9L3 3z"/></svg></a>{{ end }}
      </div>
    </div>
  </div>
  <div class="mobile-menu__overlay" data-menu-overlay hidden></div>
</header>
